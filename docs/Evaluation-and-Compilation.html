<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Evaluation and Compilation (ANSI Common Lisp)</title>

<meta name="description" content="Evaluation and Compilation (ANSI Common Lisp)">
<meta name="keywords" content="Evaluation and Compilation (ANSI Common Lisp)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="Table-of-Contents.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="index.html" rel="up" title="Top">
<link href="Types-and-Classes.html#Types-and-Classes" rel="next" title="Types and Classes">
<link href="Syntax.html#Re_002dReading-Abbreviated-Expressions" rel="prev" title="Re-Reading Abbreviated Expressions">
<style type="text/css">
<!--
/*
CSS for TexInfo/HTML files.

Copyright (C) 2015-2021 Assaf Gordon (assafgordon@gmail.com)

License:
GNU All Permissive License
https://www.gnu.org/prep/maintain/html_node/License-Notices-for-Other-Files.html

 Copying and distribution of this file, with or without modification,
 are permitted in any medium without royalty provided the copyright
 notice and this notice are preserved.  This file is offered as-is,
 without any warranty.


The used tags/classes were collected from a Texinfo-generated HTML using:

  cd coreutils
  makeinfo --html --no-split -o coreutils.html doc/coreutils.texi
  cat coreutils.html | sed 's/</\n</g' | sed 's;>.*;>;g' \
         | grep '^<' | grep 'class=' | sort -u \
         | perl -lane 'm/<(\w+) .*class="([-\w]+)"/ ; print $1, "\t", $2' \
         | sort -u

*/

a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
body {
  font-family: sans-serif;
  font-size: 16px;
  margin: 1em;

  overflow-x: hidden; /* Coupled with the div.header trick,
			 this will extend the header lines
			 access the entire page width without causing
			 a horizontal scroll bar to appear. */
}


a {
  text-decoration: none;
  outline-style: none;
  color: blue;
}
a:visited {
  color: rgb(16,0,112);
}
a:hover {
  text-decoration: underline;
}


/*****************************************************
   Titles / Headers
******************************************************/

/* @settitle:
   The title of the document at the top of the document/header */
h1.settitle {
  color: rgb(51,70,131);
  text-shadow: rgb(153,153,153) 1px 1px 0px;
}

/* The title at the beginning of the document, before the @menu */
h1.top {
  color: rgb(51,70,131);
  text-shadow: rgb(153,153,153) 1px 1px 0px;
}

/* @chapter */
h2.chapter {
}

h2.appendix { }
h2.unnumbered { }

/* @section */
h3.section {
}
/* @unnumberedsec */
h3.unnumberedsec {
}
/* @heading (seems to be only used in fdl.texi) */
h3.heading {
}

/* @subsection */
h4.subsection {
}


/**************************************************
  Short Contents (if @shortcontents command is used)
***************************************************/
h2.shortcontents-heading { }
div.shortcontents { }
div.shortcontents ul { }
div.shortcontents ul li { }


/**************************************************
  Contents (if @contents command is used)
***************************************************/
h2.contents-heading { }
div.contents { }
div.contents ul { }
div.contents ul li { }


/* The @menu table */
table.menu { }
pre.menu-comment {}



/************************************
  @example   and   @verbatim
************************************/
div.example {
  margin-left: 2em;
  margin-right: 2em;
}
div.example pre.example {
  /* Round Corners */
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  border: 1px solid #c0c0c0;

  padding: 1ex;
  background-color: #f3f3f3;
}

/* Note: @verbatim is also rendered inside a 'div.example' */
div.example pre.verbatim {
  /* Round Corners */
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  border: 1px solid #c0c0c0;

  padding: 1ex;
  background-color: #f3f3f3;
}



/************************************
  @smallexample
************************************/
div.smallexample {
}
div.smallexample pre.smallexample {
}

/***********************************
  @display
***********************************/
div.display {
}
div.display pre.display {
}



/**************************************
  @footnote
**************************************/
div.footnote { }
h4.footnotes-heading { }

/**************************************
The header at the top of each page / section
(the next/previous/top/up links)
**************************************/
div.header {
   padding-top: 0.5ex;
   padding-bottom: 0.5ex;
   background-color: #ddddff;

   /* This will extend the background color of the header
      bar to the entire width of the page (and beyond),
      requires 'overflow-x: hidden' in the 'body'. */
   padding-left: 3000px;
   margin-left: -3000px;
   padding-right: 3000px;
   margin-right: -3000px;
}

/* Disable any additional margins */
div.header p {
    margin: 0;
}
div.header p a {
    color: blue;
}


/**************************************
   @table is rendered as <dl> (defnition list),
   @item  is rendered as <dt> (definition term),
   text is rendered as <dd> (definition description)
**************************************/
dl {
   margin: 0 1em;
}
dl dt {
   margin: 1em 0;
}
dl dd {
   margin-left: 2em;
}

/*******************************************************
  Text Styles
*******************************************************/

/* @var{} */
var {
  color: #CC0000;
}

/* @samp{} */
samp {
  color: #6600CC;
}

/* @env{} will result in <p><code>X</code></p> */
p code {
	border-radius: 5px;
	padding-left: 3px;
	padding-right: 3px;
	background-color: rgba(175,184,193,0.2);
}

/* p code { */
/*   color: #532c14; */
/* } */

/* @option{} */
span.nocodebreak {
  color: #5D4C46;
}

-->
</style>


</head>

<body lang="en">
<span id="Evaluation-and-Compilation"></span><div class="header">
<p>
Next: <a href="Types-and-Classes.html#Types-and-Classes" accesskey="n" rel="next">Types and Classes</a>, Previous: <a href="Syntax.html#Syntax" accesskey="p" rel="prev">Syntax</a>, Up: <a href="index.html" accesskey="u" rel="up">Top</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Evaluation-and-Compilation-1"></span><h2 class="chapter">3 Evaluation and Compilation</h2>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Evaluation" accesskey="1">Evaluation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Compilation" accesskey="2">Compilation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Declarations" accesskey="3">Declarations</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Lambda-Lists" accesskey="4">Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Error-Checking-in-Function-Calls" accesskey="5">Error Checking in Function Calls</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Traversal-Rules-and-Side-Effects" accesskey="6">Traversal Rules and Side Effects</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Destructive-Operations" accesskey="7">Destructive Operations</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><th colspan="3" align="left" valign="top"><pre class="menu-comment">

Dictionary

</pre></th></tr><tr><td align="left" valign="top">&bull; <a href="#lambda-_0028Symbol_0029" accesskey="8">lambda (Symbol)</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#lambda-_0028Macro_0029" accesskey="9">lambda (Macro)</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#compile">compile</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#eval">eval</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#eval_002dwhen">eval-when</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#load_002dtime_002dvalue">load-time-value</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#quote">quote</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#compiler_002dmacro_002dfunction">compiler-macro-function</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#define_002dcompiler_002dmacro">define-compiler-macro</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#defmacro">defmacro</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#macro_002dfunction">macro-function</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#macroexpand_003b-macroexpand_002d1">macroexpand; macroexpand-1</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#define_002dsymbol_002dmacro">define-symbol-macro</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#symbol_002dmacrolet">symbol-macrolet</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#g_t_002amacroexpand_002dhook_002a">*macroexpand-hook*</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#proclaim">proclaim</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#declaim">declaim</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#declare">declare</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#ignore_003b-ignorable">ignore; ignorable</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#dynamic_002dextent">dynamic-extent</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#type">type</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#inline_003b-notinline">inline; notinline</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#ftype">ftype</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#declaration">declaration</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#optimize">optimize</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#special">special</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#locally">locally</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#the">the</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#special_002doperator_002dp">special-operator-p</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#constantp">constantp</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>

<hr>
<span id="Evaluation"></span><div class="header">
<p>
Next: <a href="#Compilation" accesskey="n" rel="next">Compilation</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Evaluation-1"></span><h3 class="section">3.1 Evaluation</h3>


<p><i>Execution</i> of <i>code</i> can be accomplished by a variety of means ranging
from direct interpretation of a <i>form</i> representing a <i>program</i>
to invocation of <i>compiled code</i> produced by a <i>compiler</i>.
</p>
<span id="index-evaluation"></span>
<p><em>Evaluation</em> is the process by which a <i>program</i> is <i>executed</i> in <span class="roman">Common Lisp</span>.
The mechanism of <i>evaluation</i> is manifested
both implicitly through the effect of the <i>Lisp read-eval-print loop</i>,
and  explicitly through the presence of the <i>functions</i> 
<code>eval</code>,
<code>compile</code>,
<code>compile-file</code>,
and <code>load</code>.
Any of these facilities might share the same execution strategy, 
or each might use a different one.
</p>
<p>The behavior of a <i>conforming program</i> processed by <code>eval</code>
and by <code>compile-file</code> might differ; see <a href="#SemanticConstraints">Section 3.2.2.3 (Semantic Constraints)</a>.
</p>
<p><i>Evaluation</i> can be understood in terms of a model in which an
interpreter recursively traverses a <i>form</i> performing each
step of the computation as it goes.  
This model, which describes the semantics of <span class="roman">Common Lisp</span>&nbsp;<!-- /@w --><i>programs</i>,
is described in <a href="#The-Evaluation-Model">Section 3.1.2 (The Evaluation Model)</a>.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Introduction-to-Environments" accesskey="1">Introduction to Environments</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#The-Evaluation-Model" accesskey="2">The Evaluation Model</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Lambda-Expressions" accesskey="3">Lambda Expressions</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Closures-and-Lexical-Binding" accesskey="4">Closures and Lexical Binding</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Shadowing" accesskey="5">Shadowing</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Extent" accesskey="6">Extent</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Return-Values" accesskey="7">Return Values</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>
<hr>
<span id="Introduction-to-Environments"></span><div class="header">
<p>
Next: <a href="#The-Evaluation-Model" accesskey="n" rel="next">The Evaluation Model</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Introduction-to-Environments-1"></span><h4 class="subsection">3.1.1 Introduction to Environments</h4>

<p>A <span id="index-binding"></span>
<em>binding</em> is an association between a <i>name</i> and
that which the name denotes.  <i>Bindings</i> are <i>established</i>
in a <i>lexical environment</i> or a <i>dynamic environment</i>
by particular <i>special operators</i>.
</p>
<p>An <span id="index-environment"></span>
<em>environment</em> is a set of <i>bindings</i> and other information
used during evaluation (<i>e.g.</i>, to associate meanings with names).
</p>
<p><i>Bindings</i> in an <i>environment</i> are partitioned into 
<span id="index-namespace"></span>
<em>namespaces</em>.
A single <i>name</i> can simultaneously have more than one
associated <i>binding</i> per <i>environment</i>,
but can have only one associated <i>binding</i> per <i>namespace</i>.
</p>
<span id="The-Global-Environment"></span><h4 class="subsubsection">3.1.1.1 The Global Environment</h4>

<p>The <span id="index-global-environment"></span>
<em>global environment</em> is that part of an <i>environment</i>
that contains <i>bindings</i> with both <i>indefinite scope</i> 
and <i>indefinite extent</i>.
The <i>global environment</i> contains, among other things, the following:
</p>

<ul>
<li> <i>bindings</i> of <i>dynamic variables</i> and <i>constant variables</i>.
</li><li> <i>bindings</i> of <i>functions</i>, <i>macros</i>, and <i>special operators</i>.
</li><li> <i>bindings</i> of <i>compiler macros</i>.
</li><li> <i>bindings</i> of <i>type</i> and <i>class</i> <i>names</i>
</li><li> information about <i>proclamations</i>.
</li></ul>



<span id="Dynamic-Environments"></span><h4 class="subsubsection">3.1.1.2 Dynamic Environments</h4>

<p>A <span id="index-dynamic-environment"></span>
<em>dynamic environment</em> for <i>evaluation</i> is that part of an
<i>environment</i> that contains <i>bindings</i> whose duration
is bounded by points of <i>establishment</i> and <i>disestablishment</i> 
within the execution of the <i>form</i> that
established the <i>binding</i>.
A <i>dynamic environment</i> contains, among other things, the following:
</p>

<ul>
<li> <i>bindings</i> for <i>dynamic variables</i>.
</li><li> information about <i>active</i> <i>catch tags</i>.
</li><li> information about <i>exit points</i> established by <code>unwind-protect</code>.
</li><li> information about <i>active</i> <i>handlers</i> and <i>restarts</i>.
</li></ul>


<p>The <i>dynamic environment</i> that is active at any given point 
in the <i>execution</i> of a <i>program</i> is referred to by 
definite reference as &ldquo;the current <i>dynamic environment</i>,&rdquo;
or sometimes as just &ldquo;the <i>dynamic environment</i>.&rdquo;
</p>
<p>Within a given <i>namespace</i>,
a <i>name</i> is said to be <i>bound</i>
in a <i>dynamic environment</i> if there is a <i>binding</i> 
associated with its <i>name</i> in the <i>dynamic environment</i> 
or, if not, there is a <i>binding</i> 
associated with its name in the <i>global environment</i>.
</p>

<span id="Lexical-Environments"></span><h4 class="subsubsection">3.1.1.3 Lexical Environments</h4>

<p>A <span id="index-lexical-environment"></span>
<em>lexical environment</em> for <i>evaluation</i> at some position in a <i>program</i>
is that part of the <i>environment</i> that contains information having 
<i>lexical scope</i> within the <i>forms</i> containing that position.
A <i>lexical environment</i> contains, among other things, the following:
</p>

<ul>
<li> <i>bindings</i> of <i>lexical variables</i> and <i>symbol macros</i>.
</li><li> <i>bindings</i> of <i>functions</i> and <i>macros</i>.
(Implicit in this is information about those <i>compiler macros</i> 
that are locally disabled.)
</li><li> <i>bindings</i> of <i>block tags</i>.
</li><li> <i>bindings</i> of <i>go tags</i>.
</li><li> information about <i>declarations</i>.
</li></ul>


<p>The <i>lexical environment</i> that is active at any given position
in a <i>program</i> being semantically processed is referred to by
definite reference as &ldquo;the current <i>lexical environment</i>,&rdquo;
or sometimes as just &ldquo;the <i>lexical environment</i>.&rdquo;  
</p>
<p>Within a given <i>namespace</i>,
a <i>name</i> is said to be <i>bound</i> in a <i>lexical environment</i>
if there is a <i>binding</i> 
associated with its <i>name</i>
in the <i>lexical environment</i> or, if not, there is a <i>binding</i> 
associated with its name in the <i>global environment</i>.
</p>
<span id="g_t3_002e1_002e1_002e3_002e1-The-Null-Lexical-Environment"></span><h4 class="unnumberedsubsubsec">3.1.1.3.1 The Null Lexical Environment</h4>

<span id="NullLexicalEnv"></span>
<p>The <span id="index-null-lexical-environment"></span>
<em>null lexical environment</em> is equivalent to the <i>global environment</i>.
</p>
<p>Although in general the representation of an <i>environment</i> <i>object</i>
is <i>implementation-dependent</i>, <code>nil</code>&nbsp;<!-- /@w -->can be used in any situation where an
<i>environment</i> <i>object</i> is called for in order to denote 
the <i>null lexical environment</i>.
</p>


<span id="Environment-Objects"></span><h4 class="subsubsection">3.1.1.4 Environment Objects</h4>
<span id="EnvObjs"></span>
<p>Some <i>operators</i> make use of an <i>object</i>, 
called an <span id="index-environment-object"></span>
<em>environment object</em>,
that represents the set of <i>lexical bindings</i> needed to perform
semantic analysis on a <i>form</i> in a given <i>lexical environment</i>.
The set of <i>bindings</i> in an <i>environment object</i>
may be a subset of the <i>bindings</i> that would be needed to actually 
perform an <i>evaluation</i>; for example, <i>values</i> associated with
<i>variable</i> <i>names</i> and <i>function names</i> in the corresponding
<i>lexical environment</i> might not be available in an <i>environment object</i>.
</p>
<p>The <i>type</i> and nature of an <i>environment object</i> is <i>implementation-dependent</i>.
The <i>values</i> of <i>environment parameters</i> to <i>macro functions</i>
are examples of <i>environment objects</i>.
</p>
<p>The <i>object</i> <code>nil</code>&nbsp;<!-- /@w -->when used as an <i>environment object</i>
denotes the <i>null lexical environment</i>;
see <a href="#NullLexicalEnv">Section 3.1.1.3.1 (The Null Lexical Environment)</a>.
</p>


<hr>
<span id="The-Evaluation-Model"></span><div class="header">
<p>
Next: <a href="#Lambda-Expressions" accesskey="n" rel="next">Lambda Expressions</a>, Previous: <a href="#Introduction-to-Environments" accesskey="p" rel="prev">Introduction to Environments</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="The-Evaluation-Model-1"></span><h4 class="subsection">3.1.2 The Evaluation Model</h4>

<p>A <span class="roman">Common Lisp</span>&nbsp;<!-- /@w -->system evaluates <i>forms</i> with respect to lexical,
dynamic, and global <i>environments</i>.  The following sections
describe the components of the <span class="roman">Common Lisp</span>&nbsp;<!-- /@w -->evaluation model.
</p>
<span id="Form-Evaluation"></span><h4 class="subsubsection">3.1.2.1 Form Evaluation</h4>

<p><i>Forms</i> fall into three categories:
<i>symbols</i>, <i>conses</i>, and <i>self-evaluating objects</i>.
The following sections explain these categories.
</p>
<span id="g_t3_002e1_002e2_002e1_002e1-Symbols-as-Forms"></span><h4 class="unnumberedsubsubsec">3.1.2.1.1 Symbols as Forms</h4>

<span id="SymbolsAsForms"></span>
<p>If a <i>form</i> is a <i>symbol</i>,
then it is either a <i>symbol macro</i> or a <i>variable</i>.
</p>
<p>The <i>symbol</i> names a <i>symbol macro</i> 
if there is a <i>binding</i> of the <i>symbol</i> as a <i>symbol macro</i>
in the current <i>lexical environment</i> 
(see <code>define-symbol-macro</code> and <code>symbol-macrolet</code>).
If the <i>symbol</i> is a <i>symbol macro</i>,
its expansion function is obtained.
The expansion function is a function of two arguments, and is invoked
by calling the <i>macroexpand hook</i> with 
the expansion function as its first argument,
the <i>symbol</i> as its second argument,
and an <i>environment object</i> (corresponding to the current <i>lexical environment</i>)
as its third argument.
The <i>macroexpand hook</i>, in turn, calls the expansion function with the
<i>form</i> as its first argument and the <i>environment</i> as its second argument.
The <i>value</i> of the expansion function, which is passed through
by the <i>macroexpand hook</i>, is a <i>form</i>. 
This resulting <i>form</i> is processed in place of the original <i>symbol</i>.
</p>
<p>If a <i>form</i> is a <i>symbol</i> that is not a <i>symbol macro</i>,
then it is the <i>name</i> of a <i>variable</i>, and the <i>value</i> of that
<i>variable</i> is returned. There are three kinds of variables:
<i>lexical variables</i>,
<i>dynamic variables</i>,
and
<i>constant variables</i>.
A <i>variable</i> can store one <i>object</i>.
The main operations on a <i>variable</i> are 
to <i>read</i><sub>1</sub>
to <i>write</i><sub>1</sub>
its <i>value</i>.
</p>
<p>An error of <i>type</i> <code>unbound-variable</code> should be signaled if
an <i>unbound variable</i> is referenced.
</p>
<p><i>Non-constant variables</i> can be <i>assigned</i> by using <code>setq</code> 
or <i>bound</i><sub>3</sub>
The next figure&nbsp;<!-- /@w -->lists some <i>defined names</i> that
are applicable to assigning, binding, and defining <i>variables</i>.
</p>

<div class="float"><span id="fig3_002e1"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>boundp</td><td>let</td><td>progv</td></tr>
<tr><td>defconstant</td><td>let*</td><td>psetq</td></tr>
<tr><td>defparameter</td><td>makunbound</td><td>set</td></tr>
<tr><td>defvar</td><td>multiple-value-bind</td><td>setq</td></tr>
<tr><td>lambda</td><td>multiple-value-setq</td><td>symbol-value</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.1: </strong>Some Defined Names Applicable to Variables</p></div></div>

<p>The following is a description of each kind of variable.
</p>
<span id="g_t3_002e1_002e2_002e1_002e1_002e1-Lexical-Variables"></span><h4 class="unnumberedsubsubsec">3.1.2.1.1.1 Lexical Variables</h4>


<p>A <i>lexical variable</i> is a <i>variable</i> that can be referenced only within 
the <i>lexical scope</i> of the <i>form</i> that establishes that <i>variable</i>;
<i>lexical variables</i> have <i>lexical scope</i>.
Each time a <i>form</i> creates a <i>lexical binding</i> of a <i>variable</i>,
a <i>fresh</i> <i>binding</i> is <i>established</i>.
</p>
<p>Within the <i>scope</i> of a <i>binding</i> for a <i>lexical variable</i> <i>name</i>,
uses of that <i>name</i> as a <i>variable</i> are considered to be references
to that <i>binding</i> except where the <i>variable</i> is <i>shadowed</i><sub>2</sub>
by a <i>form</i> that <i>establishes</i> a <i>fresh</i> <i>binding</i> for that 
<i>variable</i> <i>name</i>,
or by a <i>form</i> that locally <i>declares</i> the <i>name</i> <code>special</code>.
</p>
<p>A <i>lexical variable</i> always has a <i>value</i>.
There is no <i>operator</i> that introduces a <i>binding</i> for a
<i>lexical variable</i> without giving it an initial <i>value</i>, nor
is there any <i>operator</i> that can make a <i>lexical variable</i> be <i>unbound</i>.
</p>
<p><i>Bindings</i> of <i>lexical variables</i> are found in the <i>lexical environment</i>.
</p>

<span id="g_t3_002e1_002e2_002e1_002e1_002e2-Dynamic-Variables"></span><h4 class="unnumberedsubsubsec">3.1.2.1.1.2 Dynamic Variables</h4>


<p>A <i>variable</i> is a <i>dynamic variable</i> if one of the following
conditions hold:
</p>

<ul>
<li> It is locally declared or globally proclaimed <code>special</code>.

</li><li> It occurs textually within a <i>form</i> that
creates a <i>dynamic binding</i> for a <i>variable</i> of the <i>same</i> <i>name</i>,
and the <i>binding</i> is not <i>shadowed</i><sub>2</sub>
that creates a <i>lexical binding</i> of the same <i>variable</i> <i>name</i>.
</li></ul>


<p>A <i>dynamic variable</i> can be referenced at any time in any <i>program</i>;
there is no textual limitation on references to <i>dynamic variables</i>.
At any given time, all <i>dynamic variables</i> with a given name refer to 
exactly one <i>binding</i>, either in the <i>dynamic environment</i>
or in the <i>global environment</i>.
</p>
<p>The <i>value</i> part of the <i>binding</i> for a <i>dynamic variable</i> might
be empty; in this case, the <i>dynamic variable</i> is said to have no <i>value</i>,
or to be <i>unbound</i>.  A <i>dynamic variable</i> can be made <i>unbound</i>
by using <code>makunbound</code>.
</p>
<p>The effect of <i>binding</i> a <i>dynamic variable</i> is to create
a new <i>binding</i> to which all references to that <i>dynamic variable</i>
in any <i>program</i> refer for the duration of the <i>evaluation</i> of the <i>form</i>
that creates the <i>dynamic binding</i>.
</p>
<p>A <i>dynamic variable</i> can be referenced outside the <i>dynamic extent</i> of
a <i>form</i> that <i>binds</i> it.  Such a <i>variable</i> is sometimes called 
a &ldquo;global variable&rdquo; but is still in all respects just a <i>dynamic variable</i>
whose <i>binding</i> happens to exist in the <i>global environment</i> rather than in some
<i>dynamic environment</i>.
</p>
<p>A <i>dynamic variable</i> is <i>unbound</i>
unless and until explicitly assigned a value, except for 
those variables whose initial value is 
defined in this specification or by an <i>implementation</i>.
</p>

<span id="g_t3_002e1_002e2_002e1_002e1_002e3-Constant-Variables"></span><h4 class="unnumberedsubsubsec">3.1.2.1.1.3 Constant Variables</h4>

<span id="ConstantVars"></span>
<p>Certain variables, called <i>constant variables</i>, are reserved as &ldquo;named constants.&rdquo;  
The consequences are undefined if an attempt is made to 
assign a value to,
or create
a <i>binding</i> for a <i>constant variable</i>, 
except that a &lsquo;compatible&rsquo; redefinition of a <i>constant variable</i>
using <code>defconstant</code> is permitted; see the <i>macro</i> <a href="Data-and-Control-Flow.html#defconstant">defconstant</a>.
</p>
<p><i>Keywords</i>, 
<i>symbols</i> defined by <span class="roman">Common Lisp</span>&nbsp;<!-- /@w -->or the <i>implementation</i>
as constant (such as <code>nil</code>, <code>t</code>, and <code>pi</code>),
and <i>symbols</i> declared as constant using <code>defconstant</code>
are <i>constant variables</i>.
</p>

<span id="g_t3_002e1_002e2_002e1_002e1_002e4-Symbols-Naming-Both-Lexical-and-Dynamic-Variables"></span><h4 class="unnumberedsubsubsec">3.1.2.1.1.4 Symbols Naming Both Lexical and Dynamic Variables</h4>


<p>The same <i>symbol</i> can name both 
a <i>lexical variable</i> 
and a <i>dynamic variable</i>,
but never in the same <i>lexical environment</i>.
</p>
<p>In the following example, the <i>symbol</i> <code>x</code> is used,
at different times, 
as the <i>name</i> of a <i>lexical variable</i>
and as the <i>name</i> of a <i>dynamic variable</i>.
</p>
<div class="lisp">
<pre class="lisp"> (let ((x 1))            ;Binds a special variable X
   (declare (special x))
   (let ((x 2))          ;Binds a lexical variable X
     (+ x                ;Reads a lexical variable X
        (locally (declare (special x))
                 x))))   ;Reads a special variable X
<span class="roman">→</span> 3
</pre></div>




<span id="g_t3_002e1_002e2_002e1_002e2-Conses-as-Forms"></span><h4 class="unnumberedsubsubsec">3.1.2.1.2 Conses as Forms</h4>


<p>A <i>cons</i> that is used as a <i>form</i> is called a <i>compound form</i>.
</p>
<p>If the <i>car</i> of that <i>compound form</i> is a <i>symbol</i>, 
that <i>symbol</i> is the <i>name</i> of an <i>operator</i>,
and the <i>form</i> is either a <i>special form</i>, a <i>macro form</i>,
or a <i>function form</i>, depending on the <i>function</i> <i>binding</i> 
of the <i>operator</i> in the current <i>lexical environment</i>.
If the <i>operator</i> is neither a <i>special operator</i>
nor a <i>macro name</i>, it is assumed to be a <i>function name</i>
(even if there is no definition for such a <i>function</i>).
</p>
<p>If the <i>car</i> of the <i>compound form</i> is not a <i>symbol</i>,
then that <i>car</i> must be a <i>lambda expression</i>,
in which case the <i>compound form</i> is a <i>lambda form</i>.
</p>
<p>How a <i>compound form</i> is processed depends on whether it is 
classified as a <i>special form</i>, a <i>macro form</i>, 
a <i>function form</i>, or a <i>lambda form</i>.
</p>
<span id="g_t3_002e1_002e2_002e1_002e2_002e1-Special-Forms"></span><h4 class="unnumberedsubsubsec">3.1.2.1.2.1 Special Forms</h4>


<p>A <i>special form</i> is a <i>form</i> with special syntax,
special evaluation rules, or both, possibly manipulating the
evaluation environment, control flow, or both.
A <i>special operator</i> has access to
the current <i>lexical environment</i> 
and the current <i>dynamic environment</i>.
Each <i>special operator</i> defines the manner in which its <i>subexpressions</i>
are treated&mdash;which are <i>forms</i>, which are special syntax, <i>etc</i>.
</p>
<p>Some <i>special operators</i> create new 
lexical or dynamic <i>environments</i> for use during the 
<i>evaluation</i> of <i>subforms</i>
of the <i>special form</i>.  For example, <code>block</code> creates a
new <i>lexical environment</i> that is the same as the one in force
at the point of evaluation of the <code>block</code> <i>form</i>
with the addition of a <i>binding</i> of the <code>block</code> name
to an <i>exit point</i> from the <code>block</code>.
</p>
<p>The set of <i>special operator</i> <i>names</i> is fixed in <span class="roman">Common Lisp</span>; 
no way is provided for the user to define a <i>special operator</i>.
The next figure&nbsp;<!-- /@w -->lists all of the <span class="roman">Common Lisp</span>&nbsp;<!-- /@w --><i>symbols</i>
that have definitions as <i>special operators</i>.
</p>


<div class="float"><span id="CLSpecialOps"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>block</td><td>let*</td><td>return-from</td></tr>
<tr><td>catch</td><td>load-time-value</td><td>setq</td></tr>
<tr><td>eval-when</td><td>locally</td><td>symbol-macrolet</td></tr>
<tr><td>flet</td><td>macrolet</td><td>tagbody</td></tr>
<tr><td>function</td><td>multiple-value-call</td><td>the</td></tr>
<tr><td>go</td><td>multiple-value-prog1</td><td>throw</td></tr>
<tr><td>if</td><td>progn</td><td>unwind-protect</td></tr>
<tr><td>labels</td><td>progv</td><td></td></tr>
<tr><td>let</td><td>quote</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.2: </strong>Common Lisp Special Operators</p></div></div>


<span id="g_t3_002e1_002e2_002e1_002e2_002e2-Macro-Forms"></span><h4 class="unnumberedsubsubsec">3.1.2.1.2.2 Macro Forms</h4>


<p>If the <i>operator</i> names a <i>macro</i>,
its associated <i>macro function</i> is applied
to the entire <i>form</i> and the result of that application is
used in place of the original <i>form</i>.
</p>
<p>Specifically, a <i>symbol</i> names a <i>macro</i> in a given <i>lexical environment</i> if
<code>macro-function</code> is <i>true</i> of the 
<i>symbol</i> and that <i>environment</i>.
The <i>function</i> returned by <code>macro-function</code>
is a <i>function</i> of two arguments, called the
expansion function.
The expansion function is invoked by calling the <i>macroexpand hook</i> with
the expansion function as its first argument,
the entire <i>macro form</i> as its second argument,
and an <i>environment object</i> (corresponding to the current <i>lexical environment</i>)
as its third argument.
The <i>macroexpand hook</i>, in turn, calls the expansion function with the
<i>form</i> as its first argument and the <i>environment</i> as its second argument.
The <i>value</i> of the expansion function, which is passed through
by the <i>macroexpand hook</i>, is a <i>form</i>. 
The returned <i>form</i> is <i>evaluated</i> in place of the original <i>form</i>.
</p>
<p>The consequences are undefined if a <i>macro function</i> destructively modifies
any part of its <i>form</i> argument.
</p>
<p>A <i>macro name</i> is not a <i>function designator</i>,
and cannot be used as the <var>function</var> argument to <i>functions</i> 
such as <code>apply</code>, <code>funcall</code>, or <code>map</code>.
</p>
<p>An <i>implementation</i> is free to implement a <span class="roman">Common Lisp</span>&nbsp;<!-- /@w --><i>special operator</i>
as a <i>macro</i>.  An <i>implementation</i> is free to implement any
<i>macro</i> <i>operator</i> as a <i>special operator</i>, but only
if an equivalent definition of the <i>macro</i> is also provided.
</p>
<p>The next figure&nbsp;<!-- /@w -->lists some <i>defined names</i> that are applicable
to <i>macros</i>.
</p>

<div class="float"><span id="fig3_002e3"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>*macroexpand-hook*</td><td>macro-function</td><td>macroexpand-1</td></tr>
<tr><td>defmacro</td><td>macroexpand</td><td>macrolet</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.3: </strong>Defined names applicable to macros</p></div></div>


<span id="g_t3_002e1_002e2_002e1_002e2_002e3-Function-Forms"></span><h4 class="unnumberedsubsubsec">3.1.2.1.2.3 Function Forms</h4>

<span id="FunctionForms"></span>
<p>If the <i>operator</i> is a <i>symbol</i> naming a <i>function</i>,
the <i>form</i> represents a <i>function form</i>,
and the <i>cdr</i> of the list contains the <i>forms</i> 
which when evaluated will supply the arguments passed to the <i>function</i>.
</p>
<p>When a <i>function name</i> is not defined, 
an error of <i>type</i> <code>undefined-function</code> should be signaled at run time;
see <a href="#SemanticConstraints">Section 3.2.2.3 (Semantic Constraints)</a>.
</p>
<p>A <i>function form</i> is evaluated as follows:
</p>
<p>The <i>subforms</i> in the <i>cdr</i> of the original <i>form</i>
are evaluated in left-to-right order in the current lexical and 
dynamic <i>environments</i>.  The <i>primary value</i> of each
such <i>evaluation</i> becomes an <i>argument</i> to the named <i>function</i>;
any additional <i>values</i> returned by the <i>subforms</i> are discarded.
</p>
<p>The <i>functional value</i> of the <i>operator</i> 
is retrieved from the <i>lexical environment</i>,
and that <i>function</i> is invoked with the indicated arguments.
</p>
<p>Although the order of <i>evaluation</i> of 
the <i>argument</i> <i>subforms</i> themselves is 
strictly left-to-right, it is not specified whether 
the definition of the <i>operator</i> in a <i>function form</i> is looked up 
before the <i>evaluation</i> of the <i>argument</i> <i>subforms</i>,
after the <i>evaluation</i> of the <i>argument</i> <i>subforms</i>,
or between the <i>evaluation</i> of any two <i>argument</i> <i>subforms</i> 
if there is more than one such <i>argument</i> <i>subform</i>.  
For example, the following might return 23 or&nbsp;24.
</p>
<div class="lisp">
<pre class="lisp"> (defun foo (x) (+ x 3))
 (defun bar () (setf (symbol-function 'foo) #'(lambda (x) (+ x 4))))
 (foo (progn (bar) 20))
</pre></div>


<p>A <i>binding</i> for a <i>function name</i> can be <i>established</i> in 
one of several ways.  A <i>binding</i> for a <i>function name</i> in 
the <i>global environment</i> can be <i>established</i> by 
<code>defun</code>,
<code>setf</code> of <code>fdefinition</code>,
<code>setf</code> of <code>symbol-function</code>,
<code>ensure-generic-function</code>,
<code>defmethod</code> (implicitly, due to <code>ensure-generic-function</code>),
or
<code>defgeneric</code>.
A <i>binding</i> for a <i>function name</i> in the <i>lexical environment</i>
can be <i>established</i> by
<code>flet</code>
or <code>labels</code>.
</p>
<p>The next figure&nbsp;<!-- /@w -->lists some <i>defined names</i> that are applicable to <i>functions</i>.
</p>

<div class="float"><span id="fig3_002e4"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>apply</td><td>fdefinition</td><td>mapcan</td></tr>
<tr><td>call-arguments-limit</td><td>flet</td><td>mapcar</td></tr>
<tr><td>complement</td><td>fmakunbound</td><td>mapcon</td></tr>
<tr><td>constantly</td><td>funcall</td><td>mapl</td></tr>
<tr><td>defgeneric</td><td>function</td><td>maplist</td></tr>
<tr><td>defmethod</td><td>functionp</td><td>multiple-value-call</td></tr>
<tr><td>defun</td><td>labels</td><td>reduce</td></tr>
<tr><td>fboundp</td><td>map</td><td>symbol-function</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.4: </strong>Some function-related defined names</p></div></div>


<span id="g_t3_002e1_002e2_002e1_002e2_002e4-Lambda-Forms"></span><h4 class="unnumberedsubsubsec">3.1.2.1.2.4 Lambda Forms</h4>

<span id="LambdaForms"></span>
<p>A <i>lambda form</i> is similar to a <i>function form</i>, except that
the <i>function name</i> is replaced by a <i>lambda expression</i>.
</p>
<p>A <i>lambda form</i> is equivalent to using <i>funcall</i> of a
<i>lexical closure</i> of the <i>lambda expression</i> on the given <i>arguments</i>.
(In practice, some compilers are more likely to produce inline code 
for a <i>lambda form</i> than for an arbitrary named function 
that has been declared <code>inline</code>; however, such a difference
is not semantic.)
</p>
<p>For further information, see <a href="#Lambda-Expressions">Section 3.1.3 (Lambda Expressions)</a>.
</p>


<span id="g_t3_002e1_002e2_002e1_002e3-Self_002dEvaluating-Objects"></span><h4 class="unnumberedsubsubsec">3.1.2.1.3 Self-Evaluating Objects</h4>


<p>A <i>form</i> that is neither a <i>symbol</i> nor a <i>cons</i> is 
defined to be a <i>self-evaluating object</i>.  <i>Evaluating</i>
such an <i>object</i> <i>yields</i> the <i>same</i> <i>object</i> 
as a result.
</p>
<p>Certain specific <i>symbols</i> and <i>conses</i> might also happen 
to be &ldquo;self-evaluating&rdquo; but only as a special case of a more 
general set of rules for the <i>evaluation</i> of <i>symbols</i> and
<i>conses</i>; such <i>objects</i> are not considered to be
<i>self-evaluating objects</i>.
</p>
<p>The consequences are undefined if <i>literal objects</i> (including
<i>self-evaluating objects</i>) are destructively modified.
</p>
<span id="g_t3_002e1_002e2_002e1_002e3_002e1-Examples-of-Self_002dEvaluating-Objects"></span><h4 class="unnumberedsubsubsec">3.1.2.1.3.1 Examples of Self-Evaluating Objects</h4>


<p><i>Numbers</i>, <i>pathnames</i>, and <i>arrays</i> are examples of
<i>self-evaluating objects</i>.
</p>
<div class="lisp">
<pre class="lisp"> 3 <span class="roman">→</span> 3
 #c(2/3 5/8) <span class="roman">→</span> #C(2/3 5/8)
 #p&quot;S:[BILL]OTHELLO.TXT&quot; <span class="roman">→</span> #P&quot;S:[BILL]OTHELLO.TXT&quot;
 #(a b c) <span class="roman">→</span> #(A B C)
 &quot;fred smith&quot; <span class="roman">→</span> &quot;fred smith&quot;
</pre></div>






<hr>
<span id="Lambda-Expressions"></span><div class="header">
<p>
Next: <a href="#Closures-and-Lexical-Binding" accesskey="n" rel="next">Closures and Lexical Binding</a>, Previous: <a href="#The-Evaluation-Model" accesskey="p" rel="prev">The Evaluation Model</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Lambda-Expressions-1"></span><h4 class="subsection">3.1.3 Lambda Expressions</h4>

<p>In a <i>lambda expression</i>,
the body is evaluated in a lexical <i>environment</i> that is formed by
adding the <i>binding</i> of 
each <i>parameter</i> in the <i>lambda list</i>
with the corresponding <i>value</i> from the <i>arguments</i>
to the current lexical <i>environment</i>.
</p>
<p>For further discussion of how <i>bindings</i> are <i>established</i> 
based on the <i>lambda list</i>, see <a href="#Lambda-Lists">Section 3.4 (Lambda Lists)</a>.
</p>
<p>The body of a <i>lambda expression</i> is an <i>implicit progn</i>;
the <i>values</i> it returns are returned by the <i>lambda expression</i>.
</p>

<hr>
<span id="Closures-and-Lexical-Binding"></span><div class="header">
<p>
Next: <a href="#Shadowing" accesskey="n" rel="next">Shadowing</a>, Previous: <a href="#Lambda-Expressions" accesskey="p" rel="prev">Lambda Expressions</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Closures-and-Lexical-Binding-1"></span><h4 class="subsection">3.1.4 Closures and Lexical Binding</h4>

<p>A <i>lexical closure</i> is a <i>function</i> that can refer to and alter
the values of <i>lexical bindings</i> <i>established</i> by <i>binding</i> <i>forms</i>
that textually include the function definition.
</p>
<p>Consider this code, where <code>x</code> is not declared <code>special</code>:
</p>
<div class="lisp">
<pre class="lisp"> (defun two-funs (x)
   (list (function (lambda () x))
         (function (lambda (y) (setq x y)))))
 (setq funs (two-funs 6))
 (funcall (car funs)) <span class="roman">→</span> 6
 (funcall (cadr funs) 43) <span class="roman">→</span> 43
 (funcall (car funs)) <span class="roman">→</span> 43
</pre></div>


<p>The <code>function</code> <i>special form</i> coerces a 
<i>lambda expression</i> into a <i>closure</i> in which the 
<i>lexical environment</i> in effect when the <i>special form</i> is
evaluated is captured along with the <i>lambda expression</i>.
</p>
<p>The function <code>two-funs</code> returns a <i>list</i> of two 
<i>functions</i>, each of which refers to the <i>binding</i> of the
variable <code>x</code> created on entry to the function <code>two-funs</code> when it
was called.
This variable has the value <code>6</code>
initially, but <code>setq</code> can alter this <i>binding</i>.
The <i>lexical closure</i> created for the first 
<i>lambda expression</i> does not &ldquo;snapshot&rdquo; the <i>value</i> <code>6</code> for <code>x</code>
when the <i>closure</i> is created; rather it captures the <i>binding</i> of <code>x</code>.
The second <i>function</i> can be used to alter the <i>value</i> in the same (captured)
<i>binding</i> (to <code>43</code>, in the example), and
this altered variable binding then affects the value returned by the first <i>function</i>.
</p>

<p>In situations where a <i>closure</i> of a 
<i>lambda expression</i> over the same set of <i>bindings</i> may be
produced more than once, the various resulting <i>closures</i> may
or may not be <i>identical</i>, at the discretion of the <i>implementation</i>.
That is, two <i>functions</i> that are behaviorally
indistinguishable might or might not be <i>identical</i>.
Two <i>functions</i> that are behaviorally distinguishable are <i>distinct</i>.
For example:
</p>
<div class="lisp">
<pre class="lisp"> (let ((x 5) (funs '()))
   (dotimes (j 10)                          
     (push #'(lambda (z)                        
               (if (null z) (setq x 0) (+ x z)))
           funs))
   funs)
</pre></div>

<p>The result of the above <i>form</i> is a <i>list</i> of ten <i>closures</i>.
Each requires only the <i>binding</i> of <code>x</code>.
It is the same <i>binding</i> in each case, 
but the ten <i>closure</i> <i>objects</i> might or might not be <i>identical</i>.
On the other hand, the result of the <i>form</i>
</p>
<div class="lisp">
<pre class="lisp"> (let ((funs '()))     
   (dotimes (j 10)
     (let ((x 5))
       (push (function (lambda (z)
                        (if (null z) (setq x 0) (+ x z))))
             funs)))
  funs)
</pre></div>

<p>is also a <i>list</i> of ten <i>closures</i>.
However, in this case no two of the <i>closure</i> <i>objects</i> can
be <i>identical</i> because each <i>closure</i> is closed over a distinct
<i>binding</i> of <code>x</code>, and these <i>bindings</i> can be behaviorally
distinguished because of the use of <code>setq</code>.
</p>
<p>The result of the <i>form</i>
</p>
<div class="lisp">
<pre class="lisp"> (let ((funs '()))
   (dotimes (j 10)
     (let ((x 5))
       (push (function (lambda (z) (+ x z)))
            funs)))
   funs)
</pre></div>

<p>is a <i>list</i> of ten <i>closure</i> <i>objects</i> that
might or might not be <i>identical</i>.
A different <i>binding</i> of <code>x</code> is involved for
each <i>closure</i>, but the <i>bindings</i> cannot be distinguished
because their values are the <i>same</i> and immutable (there being no occurrence
of <code>setq</code> on <code>x</code>).  A compiler could internally
transform the <i>form</i> to
</p>
<div class="lisp">
<pre class="lisp"> (let ((funs '()))
   (dotimes (j 10)
     (push (function (lambda (z) (+ 5 z)))
           funs))
  funs)
</pre></div>

<p>where the <i>closures</i> may be <i>identical</i>.
</p>
<p>It is possible that a <i>closure</i> does not
close over any variable bindings.
In the code fragment
</p>
<div class="lisp">
<pre class="lisp"> (mapcar (function (lambda (x) (+ x 2))) y)
</pre></div>

<p>the function <code>(lambda (x) (+ x 2))</code> contains no references to any outside
object. In this case, the same <i>closure</i> might be returned
for all evaluations of the <code>function</code> <i>form</i>.
</p>

<hr>
<span id="Shadowing"></span><div class="header">
<p>
Next: <a href="#Extent" accesskey="n" rel="next">Extent</a>, Previous: <a href="#Closures-and-Lexical-Binding" accesskey="p" rel="prev">Closures and Lexical Binding</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Shadowing-1"></span><h4 class="subsection">3.1.5 Shadowing</h4>


<p>If two <i>forms</i> that <i>establish</i> <i>lexical bindings</i> with
the same <i>name</i> N are textually nested, then references to N
within the inner <i>form</i> refer to the <i>binding</i> established by
the inner <i>form</i>; the inner <i>binding</i> for N
<span id="index-shadow"></span>
<em>shadows</em> the outer <i>binding</i> for N.  Outside the inner
<i>form</i> but inside the outer one, references to N refer to the
<i>binding</i> established by the outer <i>form</i>.  For example:
</p>
<div class="lisp">
<pre class="lisp"> (defun test (x z)
   (let ((z (* x 2)))
     (print z))
   z)
</pre></div>

<p>The <i>binding</i> of the variable <code>z</code> by
<code>let</code> shadows
the <i>parameter</i> binding for the function <code>test</code>.  The reference to the
variable <code>z</code> in the <code>print</code> <i>form</i> refers to the <code>let</code> binding.
The reference to <code>z</code> at the end of the function <code>test</code> 
refers to the <i>parameter</i> named <code>z</code>.
</p>
<p>Constructs that are lexically scoped act as if new names were
generated for each <i>object</i> on each execution.  Therefore,
dynamic shadowing cannot occur.  For example:
</p>
<div class="lisp">
<pre class="lisp"> (defun contorted-example (f g x)
   (if (= x 0)
       (funcall f)
       (block here
          (+ 5 (contorted-example g
                                  #'(lambda () (return-from here 4))
                                  (- x 1))))))
</pre></div>

<p>Consider the call <code>(contorted-example nil nil 2)</code>.  This produces
<code>4</code>.  During the course of execution, there are three
calls to <code>contorted-example</code>, interleaved with two 
blocks:
</p>
<div class="lisp">
<pre class="lisp"> (contorted-example nil nil 2)
   (block here<sub>1</sub>
     (contorted-example nil #'(lambda () (return-from here<sub>1</sub>
       (block here<sub>2</sub>
         (contorted-example #'(lambda () (return-from here<sub>1</sub>
                            #'(lambda () (return-from here<sub>2</sub>
                            0)
             (funcall f)
                    where f <span class="roman">→</span> #'(lambda () (return-from here<sub>1</sub>
                 (return-from here<sub>1</sub>
</pre></div>

<p>At the time the <code>funcall</code> is executed
there are two <code>block</code> <i>exit points</i> outstanding, each apparently
named <code>here</code>.
The <code>return-from</code> <i>form</i> executed as a result of the <code>funcall</code>
operation
refers to the outer outstanding <i>exit point</i>
(here<sub>1</sub>
inner one (here<sub>2</sub>
It
refers to that <i>exit point</i> textually visible at the point of
execution of <code>function</code>
(here abbreviated by the <code>#'</code> syntax) that resulted
in creation of the <i>function</i> <i>object</i> actually invoked by 
<code>funcall</code>.                       
</p>
<p>If, in this example, one were to change the <code>(funcall f)</code> to
<code>(funcall g)</code>, then the value of the call <code>(contorted-example nil nil 2)</code>
would be <code>9</code>.  The value would change because 
<code>funcall</code> would cause the
execution of <code>(return-from here<sub>2</sub>
a return from the inner <i>exit point</i> (here<sub>2</sub>
When that occurs, the value <code>4</code> is returned from the
middle invocation of <code>contorted-example</code>, <code>5</code> is added to that
to get <code>9</code>, and that value is returned from the outer block
and the outermost call to <code>contorted-example</code>.  The point
is that the choice of <i>exit point</i>
returned from has nothing to do with its
being innermost or outermost; rather,
it depends on the lexical environment
that is packaged up with a <i>lambda expression</i> when
<code>function</code> is executed.


</code></p><hr>
<span id="Extent"></span><div class="header">
<p>
Next: <a href="#Return-Values" accesskey="n" rel="next">Return Values</a>, Previous: <a href="#Shadowing" accesskey="p" rel="prev">Shadowing</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Extent-1"></span><h4 class="subsection">3.1.6 Extent</h4>
<p><code>Contorted-example</code> works only because the
<i>function</i> named by <code>f</code> is invoked during the <i>extent</i> of the 
<i>exit point</i>.
Once the flow of execution has left the block,
the <i>exit point</i> is <i>disestablished</i>.  For example:
</p>
<div class="lisp">
<pre class="lisp"> (defun invalid-example ()
   (let ((y (block here #'(lambda (z) (return-from here z)))))
     (if (numberp y) y (funcall y 5))))
</pre></div>

<p>One might expect the call <code>(invalid-example)</code> to produce <code>5</code>
by the following incorrect reasoning:
<code>let</code> binds <code>y</code> to the
value of <code>block</code>; this value is a <i>function</i> resulting
from the <i>lambda expression</i>.  Because <code>y</code> is not a number, it is
invoked on the value <code>5</code>.  The <code>return-from</code> should then
return this value from the                      
<i>exit point</i> named <code>here</code>, thereby
exiting from the block again and giving <code>y</code> the value <code>5</code>
which, being a number, is then returned as the value of the call
to <code>invalid-example</code>.
</p>
<p>The argument fails only because <i>exit points</i> have 
<i>dynamic extent</i>.  The argument is correct up to the execution of
<code>return-from</code>.  The execution of <code>return-from</code>
should signal an error of <i>type</i> <code>control-error</code>, however, not
because it cannot refer to the <i>exit point</i>, but because it
does correctly refer to an <i>exit point</i> and that 
<i>exit point</i> has been <i>disestablished</i>.
</p>
<p>A reference by name to a dynamic <i>exit point</i> binding such as
a <i>catch tag</i> refers to the most recently 
<i>established</i> <i>binding</i> of that name that has not been 
<i>disestablished</i>.  For example:
</p>
<div class="lisp">
<pre class="lisp"> (defun fun1 (x)
   (catch 'trap (+ 3 (fun2 x))))
 (defun fun2 (y)
   (catch 'trap (* 5 (fun3 y))))
 (defun fun3 (z)
   (throw 'trap z))
</pre></div>

<p>Consider the call <code>(fun1 7)</code>.  The result is <code>10</code>.  At the time
the <code>throw</code> is executed, there are two outstanding catchers with the
name <code>trap</code>: one established within procedure <code>fun1</code>, and the other
within procedure <code>fun2</code>.  The latter is the more recent, and so the
value <code>7</code> is returned from <code>catch</code> in <code>fun2</code>.
Viewed from within <code>fun3</code>, the <code>catch</code> 
in <code>fun2</code> shadows the one in <code>fun1</code>.
Had <code>fun2</code> been defined as
</p>
<div class="lisp">
<pre class="lisp"> (defun fun2 (y)
   (catch 'snare (* 5 (fun3 y))))
</pre></div>

<p>then the two <i>exit points</i> 
would have different <i>names</i>, and therefore the one
in <code>fun1</code> would not be shadowed.  The result would then have been <code>7</code>.
</p>

<hr>
<span id="Return-Values"></span><div class="header">
<p>
Previous: <a href="#Extent" accesskey="p" rel="prev">Extent</a>, Up: <a href="#Evaluation" accesskey="u" rel="up">Evaluation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Return-Values-1"></span><h4 class="subsection">3.1.7 Return Values</h4>

<p>Ordinarily the result of calling a <i>function</i> is a single <i>object</i>.
Sometimes, however, it is convenient for a function to compute several
<i>objects</i> and return them.
</p>
<p>In order to receive other than exactly one value from a <i>form</i>,
one of several <i>special forms</i> or <i>macros</i> must be used to request those
values.  If a <i>form</i> produces <i>multiple values</i> which were not
requested in this way, then the first value is given to the caller and
all others are discarded; if the <i>form</i> produces zero values,
then the caller receives <code>nil</code>&nbsp;<!-- /@w -->as a value.
</p>
<p>The next figure&nbsp;<!-- /@w -->lists 
some <i>operators</i> for receiving <i>multiple values</i><sub>2</sub>
These <i>operators</i> can be used to specify 
one or more <i>forms</i> to <i>evaluate</i> 
and where to put the <i>values</i> returned by those <i>forms</i>.
</p>

<div class="float"><span id="fig3_002e5"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>multiple-value-bind</td><td>multiple-value-prog1</td><td>return-from</td></tr>
<tr><td>multiple-value-call</td><td>multiple-value-setq</td><td>throw</td></tr>
<tr><td>multiple-value-list</td><td>return</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.5: </strong>Some operators applicable to receiving multiple values</p></div></div>

<p>The <i>function</i> <code>values</code> can produce <i>multiple values</i><sub>2</sub>
<code>(values)</code> returns zero values;
<code>(values <var>form</var>)</code> returns the <i>primary value</i> returned by <var>form</var>;
<code>(values <var>form1</var> <var>form2</var>)</code> returns two values,
the <i>primary value</i> of <var>form1</var>
and the <i>primary value</i> of <var>form2</var>;
and so on.
</p>
<p>See <code>multiple-values-limit</code> and <code>values-list</code>.
</p>


<hr>
<span id="Compilation"></span><div class="header">
<p>
Next: <a href="#Declarations" accesskey="n" rel="next">Declarations</a>, Previous: <a href="#Evaluation" accesskey="p" rel="prev">Evaluation</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Compilation-1"></span><h3 class="section">3.2 Compilation</h3>


<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Compiler-Terminology" accesskey="1">Compiler Terminology</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Compilation-Semantics" accesskey="2">Compilation Semantics</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#File-Compilation" accesskey="3">File Compilation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Literal-Objects-in-Compiled-Files" accesskey="4">Literal Objects in Compiled Files</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Exceptional-Situations-in-the-Compiler" accesskey="5">Exceptional Situations in the Compiler</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>
<hr>
<span id="Compiler-Terminology"></span><div class="header">
<p>
Next: <a href="#Compilation-Semantics" accesskey="n" rel="next">Compilation Semantics</a>, Up: <a href="#Compilation" accesskey="u" rel="up">Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Compiler-Terminology-1"></span><h4 class="subsection">3.2.1 Compiler Terminology</h4>


<p>The following terminology is used in this section.
</p>
<p>The <span id="index-compiler"></span>
<em>compiler</em> is a utility that translates code into an
<i>implementation-dependent</i> form that might be represented or
executed efficiently.
The term <span id="index-compiler-1"></span>
<em>compiler</em> refers to both of the <i>functions</i>
<code>compile</code> and <code>compile-file</code>.
</p>
<p>The term <span id="index-compiled-code"></span>
<em>compiled code</em> refers to 
<i>objects</i> representing compiled programs, such as <i>objects</i> constructed
by <code>compile</code> or by <code>load</code> when <i>loading</i> a <i>compiled file</i>.
</p>
<p>The term <span id="index-implicit-compilation"></span>
<em>implicit compilation</em> refers to <i>compilation</i>
performed during <i>evaluation</i>.
</p>
<p>The term <span id="index-literal-object"></span>
<em>literal object</em> refers to 
a quoted <i>object</i> 
or a <i>self-evaluating object</i> 
or an <i>object</i> that is a substructure of such an <i>object</i>.
A <i>constant variable</i> is not itself a <i>literal object</i>.
</p>
<p>The term <span id="index-coalesce"></span>
<em>coalesce</em> is defined as follows.
Suppose <code>A</code> and <code>B</code> are two <i>literal constants</i> in the <i>source code</i>,
and that <code>A'</code> and <code>B'</code> are the corresponding <i>objects</i> in the <i>compiled code</i>.
If <code>A'</code> and <code>B'</code> are <code>eql</code> but
<code>A</code> and <code>B</code> are not <code>eql</code>, then it is said
that <code>A</code> and <code>B</code> have been coalesced by the compiler.
</p>
<p>The term <span id="index-minimal-compilation"></span>
<em>minimal compilation</em> refers to actions the compiler
must take at <i>compile time</i>. These actions are specified in 
<a href="#Compilation-Semantics">Section 3.2.2 (Compilation Semantics)</a>.
</p>
<p>The verb <span id="index-process"></span>
<em>process</em> refers to performing <i>minimal compilation</i>,
determining the time of evaluation for a <i>form</i>,
and possibly <i>evaluating</i> that <i>form</i> (if required).
</p>
<p>The term <span id="index-further-compilation"></span>
<em>further compilation</em> refers to
<i>implementation-dependent</i> compilation beyond <i>minimal compilation</i>.
That is, <i>processing</i> does not imply complete compilation.
Block compilation and generation of machine-specific instructions are 
examples of further compilation.
Further compilation is permitted to take place at <i>run time</i>.
</p>
<p>Four different <i>environments</i> relevant to compilation are
distinguished:
the <i>startup environment</i>,
the <i>compilation environment</i>,
the <i>evaluation environment</i>, and
the <i>run-time environment</i>.
</p>
<p>The <span id="index-startup-environment"></span>
<em>startup environment</em> is
the <i>environment</i> of the <i>Lisp image</i> 
from which the <i>compiler</i> was invoked.
</p>
<p>The <span id="index-compilation-environment"></span>
<em>compilation environment</em> is maintained by the compiler
and is used to hold definitions and declarations to be used internally
by the compiler.  Only those parts of a definition needed for correct
compilation are saved. The <i>compilation environment</i> is used
as the <i>environment</i> <i>argument</i> to macro expanders called by
the compiler. It is unspecified whether a definition available in the
<i>compilation environment</i> can be used in an <i>evaluation</i>
initiated in the <i>startup environment</i> or <i>evaluation environment</i>.
</p>
<p>The <span id="index-evaluation-environment"></span>
<em>evaluation environment</em> is a <i>run-time environment</i>
in which macro expanders and code specified by <code>eval-when</code>
to be evaluated are evaluated.  All evaluations initiated by the
<i>compiler</i> take place in the <i>evaluation environment</i>.
</p>
<p>The <span id="index-run_002dtime-environment"></span>
<em>run-time environment</em> is the 
<i>environment</i> in which the program being compiled will be executed.
</p>
<p>The <i>compilation environment</i> inherits from
the <i>evaluation environment</i>,
and the <i>compilation environment</i> and <i>evaluation environment</i> 
might be <i>identical</i>.
The <i>evaluation environment</i> inherits from
the <i>startup environment</i>, 
and the <i>startup environment</i> and <i>evaluation environment</i> 
might be <i>identical</i>.
</p>
<p>The term <span id="index-compile-time"></span>
<em>compile time</em> refers to the duration of time that
the compiler is processing <i>source code</i>.
At <i>compile time</i>,
only the <i>compilation environment</i> 
and  the <i>evaluation environment</i>
are available.
</p>
<p>The term <span id="index-compile_002dtime-definition"></span>
<em>compile-time definition</em> refers to a definition in
the <i>compilation environment</i>.
For example, when compiling a file, 
the definition of a function might be retained in the <i>compilation environment</i> 
if it is declared <code>inline</code>. 
This definition might not be available in the <i>evaluation environment</i>.
</p>
<p>The term <span id="index-run-time"></span>
<em>run time</em> refers to the duration of time that the
loader is loading compiled code or compiled code is being executed.
At run time, only the <i>run-time environment</i> is available.
</p>
<p>The term <span id="index-run_002dtime-definition"></span>
<em>run-time definition</em> refers to a definition in the
<i>run-time environment</i>.
</p>
<p>The term <span id="index-run_002dtime-compiler"></span>
<em>run-time compiler</em> refers to the <i>function</i> <code>compile</code>
or <i>implicit compilation</i>, for which the compilation and run-time 
<i>environments</i> are maintained in the same <i>Lisp image</i>.
Note that when the <i>run-time compiler</i> is used,
the <i>run-time environment</i> 
and <i>startup environment</i> 
are the same.
</p>

<hr>
<span id="Compilation-Semantics"></span><div class="header">
<p>
Next: <a href="#File-Compilation" accesskey="n" rel="next">File Compilation</a>, Previous: <a href="#Compiler-Terminology" accesskey="p" rel="prev">Compiler Terminology</a>, Up: <a href="#Compilation" accesskey="u" rel="up">Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Compilation-Semantics-1"></span><h4 class="subsection">3.2.2 Compilation Semantics</h4>

<p>Conceptually, compilation is a process that traverses code, performs
certain kinds of syntactic and semantic analyses using information
(such as proclamations and <i>macro</i> definitions) present in the
<i>compilation environment</i>, and produces equivalent, possibly
more efficient code.
</p>

<span id="Compiler-Macros"></span><h4 class="subsubsection">3.2.2.1 Compiler Macros</h4>
<span id="CompilerMacros"></span>
<p>A <i>compiler macro</i> can be defined for a <i>name</i>
that also names a <i>function</i> or <i>macro</i>.
That is, it is possible for a
<i>function name</i> to name both a <i>function</i> and a <i>compiler macro</i>.
</p>
<p>A <i>function name</i> names a <i>compiler macro</i> if <code>compiler-macro-function</code>
is <i>true</i> of the <i>function name</i> in the <i>lexical environment</i> in which
it appears.  Creating a <i>lexical binding</i> for the <i>function name</i>
not only creates a new local <i>function</i> or
<i>macro</i> definition, but also <i>shadows</i><sub>2</sub>
</p>
<p>The <i>function</i> returned by <code>compiler-macro-function</code>
is a <i>function</i> of two arguments, called the
expansion function.  To expand a <i>compiler macro</i>,
the expansion function is invoked by calling the <i>macroexpand hook</i> with
the expansion function as its first argument,
the entire compiler macro <i>form</i> as its second argument,
and the current compilation <i>environment</i> 
(or with the current lexical <i>environment</i>,
if the <i>form</i> is being processed by something
other than <code>compile-file</code>) 
as its third argument.
The <i>macroexpand hook</i>, in turn, calls the expansion function with the
<i>form</i> as its first argument and the <i>environment</i> as its second argument.
The return value from the expansion function, which is passed through
by the <i>macroexpand hook</i>, might either be the <i>same</i> <i>form</i>, 
or else a form that can, at the discretion of the <i>code</i> doing the expansion, 
be used in place of the original <i>form</i>.
</p>

<div class="float"><span id="fig3_002e6"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>*macroexpand-hook*</td><td>compiler-macro-function</td><td>define-compiler-macro</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.6: </strong>Defined names applicable to compiler macros</p></div></div>

<span id="g_t3_002e2_002e2_002e1_002e1-Purpose-of-Compiler-Macros"></span><h4 class="unnumberedsubsubsec">3.2.2.1.1 Purpose of Compiler Macros</h4>


<p>The purpose of the <i>compiler macro</i> facility is to permit 
selective source code transformations as optimization advice 
to the <i>compiler</i>.  When a <i>compound form</i> is being
processed (as by the compiler), if the <i>operator</i> names a
<i>compiler macro</i> then the <i>compiler macro function</i> may be
invoked on the form, and the resulting expansion recursively processed
in preference to performing the usual processing on the original <i>form</i>
according to its normal interpretation as a <i>function form</i> or
<i>macro form</i>.
</p>
<p>A <i>compiler macro function</i>, like a <i>macro function</i>,
is a <i>function</i> of two <i>arguments</i>: the entire call <i>form</i>
and the <i>environment</i>. Unlike an ordinary <i>macro function</i>, a 
<i>compiler macro function</i> can decline to provide an expansion merely by
returning a value that is the <i>same</i> as the original <i>form</i>.
The consequences are undefined if a <i>compiler macro function</i>
destructively modifies any part of its <i>form</i> argument.
</p>
<p>The <i>form</i> passed to the compiler macro function can either be a <i>list</i>
whose <i>car</i> is the function name, or a <i>list</i> whose <i>car</i> is
<code>funcall</code> and whose <i>cadr</i> is a list <code>(function <var>name</var>)</code>;
note that this affects destructuring of the form argument by the 
<i>compiler macro function</i>.
<code>define-compiler-macro</code> arranges for destructuring of arguments to be
performed correctly for both possible formats.
</p>
<p>When <code>compile-file</code> chooses to expand a <i>top level form</i> that is
a <i>compiler macro</i> <i>form</i>, the expansion is also treated as a <i>top level form</i>
for the purposes of <code>eval-when</code> processing; see <a href="#TopLevelForms">Section 3.2.3.1 (Processing of Top Level Forms)</a>.
</p>

<span id="g_t3_002e2_002e2_002e1_002e2-Naming-of-Compiler-Macros"></span><h4 class="unnumberedsubsubsec">3.2.2.1.2 Naming of Compiler Macros</h4>


<p><i>Compiler macros</i> may be defined for <i>function names</i> that name
<i>macros</i> as well as <i>functions</i>.  
</p>
<p><i>Compiler macro</i> definitions are strictly global.  There is no provision
for defining local <i>compiler macros</i> in the way that <code>macrolet</code>
defines local <i>macros</i>.  Lexical bindings of a function name shadow any
compiler macro definition associated with the name as well as its 
global <i>function</i> or <i>macro</i> definition.
</p>
<p>Note that the presence of a compiler macro definition does not affect
the values returned by
functions that access <i>function</i> definitions (<i>e.g.</i>, <code>fboundp</code>)
or <i>macro</i> definitions (<i>e.g.</i>, <code>macroexpand</code>).
Compiler macros are global, and the function
<code>compiler-macro-function</code> is sufficient to resolve their interaction
with other lexical and global definitions.
</p>

<span id="g_t3_002e2_002e2_002e1_002e3-When-Compiler-Macros-Are-Used"></span><h4 class="unnumberedsubsubsec">3.2.2.1.3 When Compiler Macros Are Used</h4>


<p>The presence of a <i>compiler macro</i> definition for a <i>function</i> or <i>macro</i>
indicates that it is desirable for the <i>compiler</i> to use the expansion
of the <i>compiler macro</i> instead of the original <i>function form</i> or
<i>macro form</i>.  However, no language processor
(compiler, evaluator, or other code walker) is ever required to actually
invoke <i>compiler macro functions</i>, or to 
make use of the resulting expansion if it does invoke 
a <i>compiler macro function</i>.
</p>
<p>When the <i>compiler</i> encounters a <i>form</i> during processing that represents
a call to a <i>compiler macro</i> <i>name</i> (that is not declared <code>notinline</code>),
the <i>compiler</i> might expand the <i>compiler macro</i>, 
and might use the expansion in place of the original <i>form</i>.
</p>
<p>When <code>eval</code> encounters a <i>form</i> during processing that represents 
a call to a <i>compiler macro</i> <i>name</i> (that is not declared <code>notinline</code>),
<code>eval</code> might expand the <i>compiler macro</i>,
and might use the expansion in place of the original <i>form</i>.
</p>
<p>There are two situations in which a <i>compiler macro</i> definition must not be
applied by any language processor:
</p>

<ul>
<li> The global function name binding associated with the compiler
macro is shadowed by a lexical binding of the function name.

</li><li> The function name has been declared or proclaimed <code>notinline</code> and
the call form appears within the scope of the declaration.
</li></ul>


<p>It is unspecified whether <i>compiler macros</i> are expanded or used in any other
situations.
</p>
<span id="g_t3_002e2_002e2_002e1_002e3_002e1-Notes-about-the-Implementation-of-Compiler-Macros"></span><h4 class="unnumberedsubsubsec">3.2.2.1.3.1 Notes about the Implementation of Compiler Macros</h4>


<p>Although it is technically permissible, as described above,
for <code>eval</code> to treat <i>compiler macros</i> in the same situations
as <i>compiler</i> might, this is not necessarily a good idea in
<i>interpreted implementations</i>.
</p>
<p><i>Compiler macros</i> exist for the purpose of trading compile-time speed
for run-time speed.  Programmers who write <i>compiler macros</i> tend to
assume that the <i>compiler macros</i> can take more time than normal <i>functions</i>
and <i>macros</i> in order to produce code which is especially optimal for use
at run time.  Since <code>eval</code> in an <i>interpreted implementation</i>
might perform semantic analysis of the same form multiple times, it might be 
inefficient in general for the <i>implementation</i> to choose to call
<i>compiler macros</i> on every such <i>evaluation</i>.
</p>
<p>Nevertheless, the decision about what to do in these situations is left to
each <i>implementation</i>.
</p>




<span id="Minimal-Compilation"></span><h4 class="subsubsection">3.2.2.2 Minimal Compilation</h4>
<span id="MinimalCompilation"></span>
<p><i>Minimal compilation</i> is defined as follows:
</p>

<ul>
<li> All <i>compiler macro</i>
<span id="index-compiler-macro"></span>
calls appearing in the
<i>source code</i> being compiled are expanded, if at all, at compile time;
they will not be expanded at run time.

</li><li> All <i>macro</i>
<span id="index-macro"></span>
and 
<i>symbol macro</i>
<span id="index-symbol-macro"></span>
calls
appearing in the source code being compiled are expanded at compile time
in such a way that they will not be expanded again at run time.
<code>macrolet</code>
<span id="index-macrolet"></span>
and
<code>symbol-macrolet</code>
<span id="index-symbol_002dmacrolet"></span>
are effectively replaced by
<i>forms</i> corresponding to their bodies in which calls to 
<i>macros</i> are replaced by their expansions.

</li><li> The first <i>argument</i> in a <code>load-time-value</code>
<span id="index-load_002dtime_002dvalue"></span>
<i>form</i> 
in <i>source code</i> processed by <code>compile</code>
<span id="index-compile"></span>
is <i>evaluated</i> at <i>compile time</i>;
in <i>source code</i> processed by <code>compile-file</code>
<span id="index-compile_002dfile"></span>
, 
the compiler arranges for it to be <i>evaluated</i> at <i>load time</i>.
In either case, the result of the <i>evaluation</i>
is remembered and used later as the value of the 
<code>load-time-value</code> <i>form</i> at <i>execution time</i>.
</li></ul>



<span id="Semantic-Constraints"></span><h4 class="subsubsection">3.2.2.3 Semantic Constraints</h4>
<span id="SemanticConstraints"></span>
<p>All <i>conforming programs</i> must obey the following constraints,
which are designed to minimize the observable differences 
between compiled and interpreted programs:
</p>

<ul>
<li> Definitions of any referenced <i>macros</i>
must be present in the <i>compilation environment</i>.  
Any <i>form</i> that is a <i>list</i>
beginning with a <i>symbol</i> that does not name a
<i>special operator</i> or a <i>macro</i> defined in the 
<i>compilation environment</i> is treated by the compiler as a 
function call.

</li><li> <code>Special</code> proclamations for <i>dynamic variables</i>
must be made in the <i>compilation environment</i>.  Any <i>binding</i>
for which there is no <code>special</code> declaration or proclamation in
the <i>compilation environment</i> is treated by the compiler as
a <i>lexical binding</i>.

</li><li> The definition of a function that is defined and
declared <code>inline</code> in the <i>compilation environment</i> must be
the same at run time.


</li><li> Within a <i>function</i> named F, the compiler may
(but is not required to)
assume that an apparent recursive call to a <i>function</i> named F 
refers to the same definition of F,
unless that function has been declared <code>notinline</code>.
The consequences of redefining such a recursively defined <i>function</i> F 
while it is executing are undefined.

</li><li> A call within a file to a named function that is
defined in the same file refers to that function, unless that function
has been declared <code>notinline</code>.  The consequences are unspecified
if functions are redefined individually at run time or multiply
defined in the same file.


</li><li> The argument syntax and number of return values for
all functions whose <code>ftype</code> is declared at compile time must
remain the same at run time.

</li><li> <i>Constant variables</i> defined in
the <i>compilation environment</i> must have a <i>similar</i> value at
run time.  A reference to 
a <i>constant variable</i> 
in <i>source code</i> is equivalent to a reference to 
a <i>literal</i> <i>object</i> that is the <i>value</i> of the <i>constant variable</i>.

</li><li> Type definitions made with <code>deftype</code> or
<code>defstruct</code> in the <i>compilation environment</i> must
retain the same definition at run time.  Classes defined by <code>defclass</code>
in the <i>compilation environment</i> must be defined
at run time to have the same <i>superclasses</i> and same 
<i>metaclass</i>.

<p>This implies that <i>subtype</i>/<i>supertype</i> relationships of 
<i>type specifiers</i> must not change between <i>compile time</i> and <i>run time</i>.  
</p>
</li><li> Type declarations present in the compilation 
<i>environment</i> must accurately describe the corresponding values at run time;
otherwise, the consequences are undefined.  It is permissible
for an unknown <i>type</i> to appear in a declaration at 
compile time, though a warning might be signaled in such a case.

</li><li> Except in the situations explicitly listed above, a
<i>function</i> defined in the <i>evaluation environment</i>
is permitted to have a different definition or a different <i>signature</i>
at run time, and the run-time definition prevails.
</li></ul>


<p><i>Conforming programs</i> should not be written using any additional
assumptions about consistency between the run-time 
<i>environment</i> and the startup, evaluation, and compilation 
<i>environments</i>.
</p>
<p>Except where noted, when a compile-time and a run-time definition are
different, one of the following occurs at run time:
</p>

<ul>
<li> an error of <i>type</i> <code>error</code> is signaled
</li><li> the compile-time definition prevails
</li><li> the run-time definition prevails
</li></ul>


<p>If the <i>compiler</i> processes a <i>function form</i> whose <i>operator</i> 
is not defined at compile time, no error is signaled at compile time.
</p>
<hr>
<span id="File-Compilation"></span><div class="header">
<p>
Next: <a href="#Literal-Objects-in-Compiled-Files" accesskey="n" rel="next">Literal Objects in Compiled Files</a>, Previous: <a href="#Compilation-Semantics" accesskey="p" rel="prev">Compilation Semantics</a>, Up: <a href="#Compilation" accesskey="u" rel="up">Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="File-Compilation-1"></span><h4 class="subsection">3.2.3 File Compilation</h4>

<p>The <i>function</i> <code>compile-file</code> performs compilation of 
<i>forms</i> in a file following the rules specified in <a href="#Compilation-Semantics">Section 3.2.2 (Compilation Semantics)</a>,
and produces an output file that can be loaded by using <code>load</code>.
</p>
<p>Normally, the <i>top level forms</i> appearing in a file compiled with
<code>compile-file</code> are evaluated only when the resulting
compiled file is loaded, and not when the file is compiled.  However,
it is typically the case that some forms in the file need to be evaluated
at compile time so the
remainder of the file can be read and compiled correctly.
</p>
<p>The <code>eval-when</code> <i>special form</i> can be used to control
whether a <i>top level form</i> is evaluated at compile time, load
time, or both.  It is possible to specify any of three situations with
<code>eval-when</code>, denoted by the symbols <tt>:compile-toplevel</tt>,
<tt>:load-toplevel</tt>, and <tt>:execute</tt>.  For top level 
<code>eval-when</code> forms, <tt>:compile-toplevel</tt> specifies that the
compiler must evaluate the body at compile time, and <code>:load-toplevel</code> specifies that the compiler must arrange to evaluate
the body at load time. For non-top level <code>eval-when</code> forms,
<tt>:execute</tt> specifies that the body must be executed in the run-time
<i>environment</i>.
</p>
<p>The behavior of this <i>form</i> can be more precisely understood in
terms of a model of how <code>compile-file</code> processes forms in
a file to be compiled. There are two processing modes, called
&ldquo;not-compile-time&rdquo; and &ldquo;compile-time-too&rdquo;.
</p>
<p>Successive forms are read from the file by <code>compile-file</code>
and processed in not-compile-time mode; in this mode, 
<code>compile-file</code> arranges for forms to be evaluated only at load time
and not at compile time.  When <code>compile-file</code> is in
compile-time-too mode, forms are evaluated both at compile time and
load time.
</p>
<span id="Processing-of-Top-Level-Forms"></span><h4 class="subsubsection">3.2.3.1 Processing of Top Level Forms</h4>
<span id="TopLevelForms"></span>
<p>Processing of <i>top level forms</i> in the file compiler is defined
as follows:
</p>

<ol>
<li> If the <i>form</i> is a <i>compiler macro form</i>
(not disabled by a <code>notinline</code> <i>declaration</i>),
the <i>implementation</i> might or might not choose to compute
the <i>compiler macro expansion</i> of the <i>form</i> and,
having performed the expansion, might or might not choose to process the result
as a <i>top level form</i> in the same processing mode
(compile-time-too or not-compile-time).
If it declines to obtain or use the expansion, it must process the original <i>form</i>.

</li><li> If the form is a <i>macro form</i>,
its <i>macro expansion</i> is computed and processed as a 
<i>top level form</i> in
the same processing mode (compile-time-too or not-compile-time).

</li><li> If the form is a <code>progn</code> form, each of its
body <i>forms</i> is sequentially processed as a 
<i>top level form</i> in the same processing mode.

</li><li> If the form is a <code>locally</code>, 
<code>macrolet</code>, or <code>symbol-macrolet</code>, 
<code>compile-file</code> establishes the appropriate bindings and processes the
body forms as <i>top level forms</i> with those bindings in effect
in the same processing mode.  (Note that this implies that the lexical
<i>environment</i> in which <i>top level forms</i> are processed
is not necessarily the <i>null lexical environment</i>.)

</li><li> If the form is an <code>eval-when</code>
<span id="index-eval_002dwhen"></span>
form, it is
handled according to the next figure.


<div class="float"><span id="fig3_002e7"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<thead><tr><th><b>CT</b></th><th><b>LT</b></th><th><b>E</b></th><th><b>Mode</b></th><th><b>Action</b></th><th><b>New Mode</b></th></tr></thead>
<tr><td>Yes</td><td>Yes</td><td>&mdash;</td><td>&mdash;</td><td>Process</td><td>compile-time-too</td></tr>
<tr><td>No</td><td>Yes</td><td>Yes</td><td>CTT</td><td>Process</td><td>compile-time-too</td></tr>
<tr><td>No</td><td>Yes</td><td>Yes</td><td>NCT</td><td>Process</td><td>not-compile-time</td></tr>
<tr><td>No</td><td>Yes</td><td>No</td><td>&mdash;</td><td>Process</td><td>not-compile-time</td></tr>
<tr><td>Yes</td><td>No</td><td>&mdash;</td><td>&mdash;</td><td>Evaluate</td><td>&mdash;</td></tr>
<tr><td>No</td><td>No</td><td>Yes</td><td>CTT</td><td>Evaluate</td><td>&mdash;</td></tr>
<tr><td>No</td><td>No</td><td>Yes</td><td>NCT</td><td>Discard</td><td>&mdash;</td></tr>
<tr><td>No</td><td>No</td><td>No</td><td>&mdash;</td><td>Discard</td><td>&mdash;</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.7: </strong>EVAL-WHEN processing</p></div></div>
<p>Column <b>CT</b>   indicates whether <tt>:compile-toplevel</tt> is specified.
Column <b>LT</b>   indicates whether <tt>:load-toplevel</tt> is specified.
Column <b>E</b>    indicates whether <tt>:execute</tt> is specified.  
Column <b>Mode</b> indicates the processing mode; 
a dash (&mdash;) indicates that the processing mode is not relevant.
</p>
<p>The <b>Action</b> column specifies one of three actions:
</p>

<dl compact="compact">
<dd><p><b>Process:</b> process the body as <i>top level forms</i> in the
specified mode.
</p>
</dd>
<dd><p><b>Evaluate:</b> evaluate the body in the dynamic execution
context of the compiler, using the <i>evaluation environment</i> as
the global environment and the <i>lexical environment</i> in which
the <code>eval-when</code> appears.
</p>
</dd>
<dd><p><b>Discard:</b> ignore the <i>form</i>.
</p></dd>
</dl>


<p>The <b>New Mode</b> column indicates the new processing mode. 
A dash (&mdash;) indicates the compiler remains in its current mode.
</p>
</li><li> Otherwise, the form is a <i>top level form</i> that
is not one of the special cases.  In compile-time-too mode, the
compiler first evaluates the form in the evaluation 
<i>environment</i> and then minimally compiles it.  In not-compile-time
mode, the <i>form</i> is simply minimally compiled.  All <i>subforms</i>
are treated as <i>non-top-level forms</i>.

<p>Note that <i>top level forms</i> are processed in the order in
which they textually appear in the file and that each 
<i>top level form</i> read by the compiler is processed before the next is
read.  However, the order of processing (including macro expansion) of
<i>subforms</i> that are not <i>top level forms</i> and the order of
further compilation is unspecified as long as Common Lisp semantics
are preserved.
</p></li></ol>


<p><code>eval-when</code> forms cause compile-time evaluation only at
top level.  Both <tt>:compile-toplevel</tt> and <tt>:load-toplevel</tt> situation specifications
are ignored for <i>non-top-level forms</i>. For <i>non-top-level forms</i>, 
an <code>eval-when</code>
specifying the <tt>:execute</tt> situation is treated as an <i>implicit progn</i>
including the <i>forms</i> in the body of the <code>eval-when</code> <i>form</i>;
otherwise, the <i>forms</i> in the body are ignored.
</p>
<span id="g_t3_002e2_002e3_002e1_002e1-Processing-of-Defining-Macros"></span><h4 class="unnumberedsubsubsec">3.2.3.1.1 Processing of Defining Macros</h4>



<p>Defining <i>macros</i> (such as <code>defmacro</code> or <code>defvar</code>)
appearing within a file being processed by <code>compile-file</code>
normally have compile-time side effects which affect how subsequent <i>forms</i>
in the same <i>file</i> are compiled.  A convenient model for explaining how these
side effects happen is that the defining macro expands into one or
more <code>eval-when</code> <i>forms</i>, and that the calls which cause the compile-time
side effects to happen appear 
in the body of an <code>(eval-when (:compile-toplevel) ...)</code> <i>form</i>.
</p>
<p>The compile-time side effects may cause information about the definition to
be stored differently than if the defining macro had been processed in the
&lsquo;normal&rsquo; way (either interpretively or by loading the compiled file).
</p>
<p>In particular, the information stored by the defining <i>macros</i> at compile time
might or might not be available to the interpreter (either during or after compilation),
or during subsequent calls to the <i>compiler</i>.  For example,
the following code is nonportable because it assumes that the <i>compiler</i>
stores the macro definition of <code>foo</code> where it is available to the interpreter:
</p>
<div class="lisp">
<pre class="lisp"> (defmacro foo (x) `(car ,x))
 (eval-when (:execute :compile-toplevel :load-toplevel)
   (print (foo '(a b c))))
</pre></div>


<p>A portable way to do the same thing would be to include the macro
definition inside the <code>eval-when</code> <i>form</i>, as in:
</p>
<div class="lisp">
<pre class="lisp"> (eval-when (:execute :compile-toplevel :load-toplevel)
   (defmacro foo (x) `(car ,x))
   (print (foo '(a b c))))
</pre></div>



<p>The next figure&nbsp;<!-- /@w -->lists macros that make definitions
available both in the compilation and run-time <i>environments</i>.
It is not specified whether definitions made available in the
<i>compilation environment</i> are available in the evaluation
<i>environment</i>, nor is it specified whether they are available
in subsequent compilation units or subsequent invocations of the
compiler.  As with <code>eval-when</code>, these compile-time side
effects happen only when the defining macros appear at 
top level.
</p>

<div class="float"><span id="fig3_002e8"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>declaim</td><td>define-modify-macro</td><td>defsetf</td></tr>
<tr><td>defclass</td><td>define-setf-expander</td><td>defstruct</td></tr>
<tr><td>defconstant</td><td>defmacro</td><td>deftype</td></tr>
<tr><td>define-compiler-macro</td><td>defpackage</td><td>defvar</td></tr>
<tr><td>define-condition</td><td>defparameter</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.8: </strong>Defining Macros That Affect the Compile-Time Environment</p></div></div>



<span id="g_t3_002e2_002e3_002e1_002e2-Constraints-on-Macros-and-Compiler-Macros"></span><h4 class="unnumberedsubsubsec">3.2.3.1.2 Constraints on Macros and Compiler Macros</h4>



<p>Except where explicitly stated otherwise, no <i>macro</i> defined in
the <span class="roman">Common Lisp</span>&nbsp;<!-- /@w -->standard produces an expansion that could cause any of the
<i>subforms</i> of the <i>macro form</i> to be treated as 
<i>top level forms</i>.  If an <i>implementation</i> also provides a
<i>special operator</i> definition of a <span class="roman">Common Lisp</span>&nbsp;<!-- /@w --><i>macro</i>, 
the <i>special operator</i> definition must be semantically equivalent
in this respect.
</p>
<p><i>Compiler macro</i> expansions must also have the same
top level evaluation semantics as the <i>form</i> which they replace.
This is of concern both to <i>conforming implementations</i> and to
<i>conforming programs</i>.
</p>



<hr>
<span id="Literal-Objects-in-Compiled-Files"></span><div class="header">
<p>
Next: <a href="#Exceptional-Situations-in-the-Compiler" accesskey="n" rel="next">Exceptional Situations in the Compiler</a>, Previous: <a href="#File-Compilation" accesskey="p" rel="prev">File Compilation</a>, Up: <a href="#Compilation" accesskey="u" rel="up">Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Literal-Objects-in-Compiled-Files-1"></span><h4 class="subsection">3.2.4 Literal Objects in Compiled Files</h4>

<p>The functions <code>eval</code> and <code>compile</code> are
required to ensure that <i>literal objects</i> referenced within the resulting
interpreted or compiled code objects are the <i>same</i> as the
corresponding <i>objects</i> in the <i>source code</i>.
<code>compile-file</code>, on the other hand, 
must produce a <i>compiled file</i> that, when loaded with
<code>load</code>, constructs the <i>objects</i> defined by the
<i>source code</i> and produces references to them.
</p>
<p>In the case of <code>compile-file</code>, <i>objects</i>
constructed by <code>load</code> of the <i>compiled file</i> cannot be spoken
of as being the <i>same</i> as the <i>objects</i> constructed at
compile time, because the <i>compiled file</i> may be loaded into a different
<i>Lisp image</i> than the one in which it was compiled.  This section
defines the concept of <i>similarity</i> which relates
<i>objects</i> in the <i>evaluation environment</i> to the
corresponding <i>objects</i> in the <i>run-time environment</i>.
</p>
<p>The constraints on <i>literal objects</i> described in this section
apply only to <code>compile-file</code>;
<code>eval</code> and <code>compile</code> do not copy or coalesce constants.
</p>
<span id="Externalizable-Objects"></span><h4 class="subsubsection">3.2.4.1 Externalizable Objects</h4>

<p>The fact that the <i>file compiler</i> represents <i>literal</i> <i>objects</i> 
externally in a <i>compiled file</i> and must later reconstruct suitable 
equivalents of those <i>objects</i> when that <i>file</i> is loaded
imposes a need for constraints on the nature of the <i>objects</i> that can be 
used as <i>literal</i> <i>objects</i> in <i>code</i> to be processed 
by the <i>file compiler</i>.
</p>
<p>An <i>object</i> that can be used as a <i>literal</i> <i>object</i> 
in <i>code</i> to be processed by the <i>file compiler</i> is called an
<span id="index-externalizable-object"></span>
<em>externalizable object</em>.
</p>
<p>We define that two <i>objects</i> are <span id="index-similar"></span>
<em>similar</em> if they satisfy
a two-place conceptual equivalence predicate (defined below), which is
independent of the <i>Lisp image</i> so that the two <i>objects</i> in
different <i>Lisp images</i> can be understood to be equivalent under
this predicate.  Further, by inspecting the definition of this conceptual
predicate, the programmer can anticipate what aspects of an <i>object</i>
are reliably preserved by <i>file compilation</i>.
</p>
<p>The <i>file compiler</i> must cooperate with the <i>loader</i> in order to
assure that in each case where an <i>externalizable object</i> is processed
as a <i>literal object</i>, the <i>loader</i> will construct a <i>similar</i>
<i>object</i>.
</p>
<p>The set of <i>objects</i> that are 
<span id="index-externalizable-object-1"></span>
<em>externalizable objects</em> are those
for which the new conceptual term &ldquo;<i>similar</i>&rdquo; is defined, such that
when a <i>compiled file</i> is <i>loaded</i>, an <i>object</i> can be constructed
which can be shown to be <i>similar</i> to the original <i>object</i> which
existed at the time the <i>file compiler</i> was operating.
</p>

<span id="Similarity-of-Literal-Objects"></span><h4 class="subsubsection">3.2.4.2 Similarity of Literal Objects</h4>
<span id="Similarity"></span>
<span id="g_t3_002e2_002e4_002e2_002e1-Similarity-of-Aggregate-Objects"></span><h4 class="unnumberedsubsubsec">3.2.4.2.1 Similarity of Aggregate Objects</h4>


<p>Of the <i>types</i> over which <i>similarity</i> is defined, 
some are treated as aggregate objects.  For these types, 
<i>similarity</i> is defined recursively.  
We say that an <i>object</i> of these types has certain &ldquo;basic qualities&rdquo;
and to satisfy the <i>similarity</i> relationship, the values of the
corresponding qualities of the two <i>objects</i> must also be similar.
</p>

<span id="g_t3_002e2_002e4_002e2_002e2-Definition-of-Similarity"></span><h4 class="unnumberedsubsubsec">3.2.4.2.2 Definition of Similarity</h4>


<p>Two <i>objects</i> S (in <i>source code</i>) and C (in <i>compiled code</i>)
are defined to be <i>similar</i> if and only if 
they are both of one of the <i>types</i> listed here
(or defined by the <i>implementation</i>) 
and they both satisfy all additional requirements of <i>similarity</i> 
indicated for that <i>type</i>.
</p>

<dl compact="compact">
<dt><code>number</code></dt>
<dd>

<p>Two <i>numbers</i> S and C are <i>similar</i> if they are of the same <i>type</i>
and represent the same mathematical value.
</p>
</dd>
<dt><code>character</code></dt>
<dd>


<p>Two <i>simple</i> <i>characters</i> S and C are <i>similar</i> 
if they have <i>similar</i> <i>code</i> <i>attributes</i>.
</p>
<p><i>Implementations</i> providing additional, <i>implementation-defined</i> 
<i>attributes</i> must define whether and how <i>non-simple</i> <i>characters</i> 
can be regarded as <i>similar</i>.
</p>
</dd>
<dt><code>symbol</code></dt>
<dd>

<p>Two <i>apparently uninterned</i> <i>symbols</i> S and C are <i>similar</i>
if their
<i>names</i>
are <i>similar</i>.
</p>
<p>Two <i>interned</i> symbols S and C are <i>similar</i> 
if their <i>names</i> are <i>similar</i>,
and if either S is accessible in the <i>current package</i> at compile time
and C is accessible in the <i>current package</i> at load time,
or C is accessible in the <i>package</i> that is <i>similar</i> to
the <i>home package</i> of S.
</p>
<p>(Note that <i>similarity</i> of
<i>symbols</i> is dependent
on neither the <i>current readtable</i> nor how the <i>function</i> <code>read</code> would
parse the <i>characters</i> in the <i>name</i> of the <i>symbol</i>.)
</p>
</dd>
<dt><code>package</code></dt>
<dd>

<p>Two <i>packages</i> S and C are <i>similar</i> if their <i>names</i> are <i>similar</i>.
</p>
<p>Note that although a <i>package</i> <i>object</i> is an <i>externalizable object</i>,
the programmer is responsible for ensuring that the corresponding <i>package</i> is
already in existence when code referencing it as a <i>literal</i> <i>object</i> 
is <i>loaded</i>.  The <i>loader</i> finds the corresponding <i>package</i> <i>object</i>
as if by calling <code>find-package</code> with that <i>name</i> as an <i>argument</i>.
An error is signaled by the <i>loader</i> if no <i>package</i> exists at load time.
</p>
</dd>
<dt><code>random-state</code></dt>
<dd>

<p>Two <i>random states</i> S and C are <i>similar</i> if S
would always produce the same sequence of pseudo-random numbers 
as a <i>copy</i><sub>5</sub>
when given as the <var>random-state</var> <i>argument</i> to the <i>function</i> <code>random</code>, 
assuming equivalent <var>limit</var> <i>arguments</i> in each case.
</p>
<p>(Note that since C has been processed by the <i>file compiler</i>,
it cannot be used directly as an <i>argument</i> to <code>random</code>
because <code>random</code> would perform a side effect.)
</p>
</dd>
<dt><code>cons</code></dt>
<dd> 

<p>Two <i>conses</i>, S and C, are <i>similar</i> if
the <i>car</i><sub>2</sub>
and the <i>cdr</i><sub>2</sub>
</p>
</dd>
<dt><code>array</code></dt>
<dd>

<p>Two one-dimensional <i>arrays</i>, S and C, are <i>similar</i> if
the <i>length</i> of S is <i>similar</i> to the <i>length</i> of C,
the <i>actual array element type</i> of S is <i>similar</i> to
the <i>actual array element type</i> of C,
and each <i>active</i> <i>element</i> of S is <i>similar</i> to
the corresponding <i>element</i> of C.
</p>
<p>Two <i>arrays</i> of <i>rank</i> other than one, S and C, are <i>similar</i> if
the <i>rank</i> of S is <i>similar</i> to the <i>rank</i> of C,
each <i>dimension</i><sub>1</sub>
the corresponding <i>dimension</i><sub>1</sub>
the <i>actual array element type</i> of S is <i>similar</i> to
the <i>actual array element type</i> of C,
and each <i>element</i> of S is <i>similar</i> to
the corresponding <i>element</i> of C.
</p>
<p>In addition,
if S is a <i>simple array</i>, then C must also be a <i>simple array</i>.
If S is a <i>displaced array</i>,
has a <i>fill pointer</i>,
or is <i>actually adjustable</i>, 
C is permitted to lack any or all of these qualities.
</p>
</dd>
<dt><code>hash-table</code></dt>
<dd>

<p>Two <i>hash tables</i> S and C are <i>similar</i> if they meet the following
three requirements:
</p>

<ol>
<li> They both have the same test 
(<i>e.g.</i>, they are both <code>eql</code> <i>hash tables</i>).

</li><li> There is a unique one-to-one correspondence between the keys of
the two <i>hash tables</i>, such that the corresponding keys are 
<i>similar</i>.

</li><li> For all keys, the values associated with two corresponding keys
are <i>similar</i>.
</li></ol>


<p>If there is more than one possible one-to-one correspondence between
the keys of S and C, the consequences are unspecified.  
A <i>conforming program</i> cannot use a table such as S as an
<i>externalizable constant</i>.
</p>
</dd>
<dt><code>pathname</code></dt>
<dd>

<p>Two <i>pathnames</i> S and C are <i>similar</i> if all corresponding 
<i>pathname components</i> are <i>similar</i>.
</p>
</dd>
<dt><code>function</code></dt>
<dd>

<p><i>Functions</i> are not <i>externalizable objects</i>.
</p>
</dd>
<dt><code>structure-object</code> and <code>standard-object</code></dt>
<dd>

<p>A general-purpose concept of <i>similarity</i> does not exist for <i>structures</i>
and <i>standard objects</i>.
However, a <i>conforming program</i> is permitted to define a <code>make-load-form</code>
<i>method</i> for any <i>class</i> K defined by that <i>program</i> that is
a <i>subclass</i> of either <code>structure-object</code> or <code>standard-object</code>.
The effect of such a <i>method</i> is to define that an <i>object</i> S of <i>type</i> K
in <i>source code</i> is <i>similar</i> to an <i>object</i> C of <i>type</i> K
in <i>compiled code</i> if C was constructed from <i>code</i> produced by 
calling <code>make-load-form</code> on S.
</p></dd>
</dl>



<span id="Extensions-to-Similarity-Rules"></span><h4 class="subsubsection">3.2.4.3 Extensions to Similarity Rules</h4>

<p>Some <i>objects</i>, such as <i>streams</i>, <code>readtables</code>, and <code>methods</code>
are not <i>externalizable objects</i> under the definition of similarity given above.
That is, such <i>objects</i> may not portably appear as <i>literal</i> <i>objects</i> 
in <i>code</i> to be processed by the <i>file compiler</i>. 
</p>
<p>An <i>implementation</i> is permitted to extend the rules of similarity, 
so that other kinds of <i>objects</i> are <i>externalizable objects</i>
for that <i>implementation</i>.
</p>
<p>If for some kind of <i>object</i>, <i>similarity</i> is
neither defined by this specification 
nor by the <i>implementation</i>, 
then the <i>file compiler</i> must signal an error upon encountering such 
an <i>object</i> as a <i>literal constant</i>.
</p>

<span id="Additional-Constraints-on-Externalizable-Objects"></span><h4 class="subsubsection">3.2.4.4 Additional Constraints on Externalizable Objects</h4>

<p>If two <i>literal objects</i> appearing in the source code for a single file
processed with
the <i>file compiler</i> 
are the <i>identical</i>,
the corresponding <i>objects</i> in the <i>compiled code</i> 
must also be the <i>identical</i>.
With the exception of <i>symbols</i> and <i>packages</i>, any two
<i>literal objects</i>
in <i>code</i> being processed by
the <i>file compiler</i>
may be <i>coalesced</i> 
if and only if they are <i>similar</i>; 
if they are either both <i>symbols</i> or both <i>packages</i>,
they may only be <i>coalesced</i> if and only if they are <i>identical</i>.
</p>
<p><i>Objects</i> containing circular references can 
be <i>externalizable objects</i>.
The <i>file compiler</i> is required to preserve <code>eql</code>ness of 
substructures within a <i>file</i>.
Preserving <code>eql</code>ness means that subobjects that are
the <i>same</i>
in the <i>source code</i> must 
be
the <i>same</i>
in the corresponding <i>compiled code</i>.
</p>
<p>In addition, the following are constraints on the handling of
<i>literal objects</i> by the <i>file compiler</i>:
</p>

<dl compact="compact">
<dd><p><b>array:</b> If an <i>array</i> in the source code is a
<i>simple array</i>, then the corresponding <i>array</i>
in the compiled code will also be a <i>simple array</i>.  If
an <i>array</i> in the source code is displaced, has a 
<i>fill pointer</i>, or is <i>actually adjustable</i>, the corresponding 
<i>array</i> in the compiled code might lack any or all of these
qualities. If an <i>array</i> in the source code has a fill
pointer, then the corresponding <i>array</i> in the compiled
code might be only the size implied by the fill pointer.
</p>
</dd>
<dd><p><b>packages:</b> The loader is required to find the
corresponding <i>package</i> <i>object</i> as if by calling 
<code>find-package</code> with the package name as an argument.  
An error of <i>type</i> <code>package-error</code> is signaled if no 
<i>package</i> of that name exists at load time.
</p>
</dd>
<dd><p><b>random-state:</b> A constant <i>random state</i>
object cannot be used as the state argument 
to the <i>function</i> <code>random</code> because <code>random</code> modifies this data structure.
</p>
</dd>
<dd><p><b>structure, standard-object:</b>
<i>Objects</i> of <i>type</i> <code>structure-object</code> and <code>standard-object</code>
may appear in compiled constants if there is an
appropriate <code>make-load-form</code> method defined for that
<i>type</i>.
</p>
<span id="CallingMakeLoadForm"></span><p>The <i>file compiler</i> calls <code>make-load-form</code> on any <i>object</i>
that is referenced as a <i>literal object</i> if the <i>object</i> is a
<i>generalized instance</i> of <code>standard-object</code>,
<code>structure-object</code>, <code>condition</code>, or any of a 
(possibly empty) <i>implementation-dependent</i> set of other <i>classes</i>.
The <i>file compiler</i> only calls <code>make-load-form</code> once for
any given <i>object</i> within a single <i>file</i>.
</p>
</dd>
<dd><p><b>symbol:</b> In order to guarantee that <i>compiled files</i> can be <i>loaded</i>
correctly, users must ensure that the <i>packages</i> referenced in those <i>files</i>
are defined consistently at compile time and load time.  <i>Conforming programs</i>
must satisfy the following requirements:
</p>

<ol>
<li> The <i>current package</i> when a <i>top level form</i> in the <i>file</i>
is processed by <code>compile-file</code> must be the same as the <i>current package</i>
when the <i>code</i> corresponding to that <i>top level form</i> in the
<i>compiled file</i> is executed by <code>load</code>.  In particular:


<ol type="a" start="1">
<li> Any <i>top level form</i> in a <i>file</i> that alters
the <i>current package</i> must change it to a <i>package</i>
of the same <i>name</i> both at compile time and at load time.

</li><li> If the first <i>non-atomic</i> <i>top level form</i> in the <i>file</i>
is not an <code>in-package</code> <i>form</i>, then the <i>current package</i>
at the time <code>load</code> is called must be a <i>package</i> with the 
same <i>name</i> as the package that was the <i>current package</i>
at the time <code>compile-file</code> was called.
</li></ol>


</li><li> For all <i>symbols</i> 
appearing lexically within a <i>top level form</i> that
were <i>accessible</i> in the <i>package</i> that was the <i>current package</i>
during processing of that <i>top level form</i> at compile time, but
whose <i>home package</i> was another <i>package</i>, at load time there must
be a <i>symbol</i> with the same <i>name</i> that is <i>accessible</i> in both the
load-time <i>current package</i> and in the <i>package</i>
with the same <i>name</i> as the
compile-time <i>home package</i>. 

</li><li> For all <i>symbols</i> represented in the <i>compiled file</i> 
that were <i>external symbols</i> in
their <i>home package</i> at compile time, there must be a <i>symbol</i> with the
same <i>name</i> that is an <i>external symbol</i> in the <i>package</i> 
with the same <i>name</i> at load time.
</li></ol>


<p>If any of these conditions do not hold, the <i>package</i> in which the <i>loader</i> looks
for the affected <i>symbols</i> is unspecified.  <i>Implementations</i> are permitted 
to signal an error or to define this behavior.
</p></dd>
</dl>




<hr>
<span id="Exceptional-Situations-in-the-Compiler"></span><div class="header">
<p>
Previous: <a href="#Literal-Objects-in-Compiled-Files" accesskey="p" rel="prev">Literal Objects in Compiled Files</a>, Up: <a href="#Compilation" accesskey="u" rel="up">Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Exceptional-Situations-in-the-Compiler-1"></span><h4 class="subsection">3.2.5 Exceptional Situations in the Compiler</h4>



<p><code>compile</code> and <code>compile-file</code> are permitted to
signal errors and warnings, including errors due to compile-time
processing of <code>(eval-when (:compile-toplevel) ...)</code> forms,
macro expansion, and conditions signaled by the compiler itself.
</p>
<p><i>Conditions</i> of <i>type</i> <code>error</code> might be signaled by the compiler
in situations where the compilation cannot proceed without intervention.  
</p>
<p>In addition to situations for which the standard specifies that
<i>conditions</i> of <i>type</i> <code>warning</code> must or might be signaled,
warnings might be signaled in situations where the compiler can
determine that the consequences are undefined or that a run-time
error will be signaled.  Examples of this situation are as follows: 
violating type declarations,
altering or assigning the value of a constant defined with <code>defconstant</code>,
calling built-in Lisp functions with a wrong number of arguments or malformed keyword
argument lists, 
and using unrecognized declaration specifiers.
</p>
<p>The compiler is permitted to issue warnings about matters of
programming style as conditions of <i>type</i> <code>style-warning</code>.
Examples of this situation are as follows:
redefining a function using a different argument list,
calling a function with a wrong number of arguments,
not declaring <code>ignore</code> of a local variable that is not referenced,
and referencing a variable declared <code>ignore</code>.
</p>
<p>Both <code>compile</code> and <code>compile-file</code> are permitted
(but not required) to <i>establish</i> a <i>handler</i>
for <i>conditions</i> of <i>type</i> <code>error</code>.  For example, they
might signal a warning, and restart compilation from some
<i>implementation-dependent</i> point in order to let the 
compilation proceed without manual intervention.
</p>
<p>Both <code>compile</code> and <code>compile-file</code> return three
values, the second two indicating whether the source code being compiled
contained errors and whether style warnings were issued.
</p>

<p>Some warnings might be deferred until the end of compilation. 
See <code>with-compilation-unit</code>.
</p>


<hr>
<span id="Declarations"></span><div class="header">
<p>
Next: <a href="#Lambda-Lists" accesskey="n" rel="next">Lambda Lists</a>, Previous: <a href="#Compilation" accesskey="p" rel="prev">Compilation</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Declarations-1"></span><h3 class="section">3.3 Declarations</h3>


<span id="index-declaration"></span>
<p><em>Declarations</em> provide a way of specifying information for use by
program processors, such as the evaluator or the compiler.
</p>
<span id="index-local-declaration"></span>
<p><em>Local declarations</em>
can be embedded in executable code using <tt>declare</tt>.
<span id="index-global-declaration"></span>
<em>Global declarations</em>, 
or 
<span id="index-proclamation"></span>
<em>proclamations</em>,
are established by <code>proclaim</code> or <code>declaim</code>.
</p>
<p>The <code>the</code> <i>special form</i> provides a shorthand notation for 
making a <i>local declaration</i> about the <i>type</i> of the
<i>value</i> of a given <i>form</i>.
</p>
<p>The consequences are undefined if a program violates a <i>declaration</i>
or a <i>proclamation</i>.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Minimal-Declaration-Processing-Requirements" accesskey="1">Minimal Declaration Processing Requirements</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Declaration-Specifiers" accesskey="2">Declaration Specifiers</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Declaration-Identifiers" accesskey="3">Declaration Identifiers</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Declaration-Scope" accesskey="4">Declaration Scope</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>
<hr>
<span id="Minimal-Declaration-Processing-Requirements"></span><div class="header">
<p>
Next: <a href="#Declaration-Specifiers" accesskey="n" rel="next">Declaration Specifiers</a>, Up: <a href="#Declarations" accesskey="u" rel="up">Declarations</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Minimal-Declaration-Processing-Requirements-1"></span><h4 class="subsection">3.3.1 Minimal Declaration Processing Requirements</h4>

<p>In general, an <i>implementation</i> is free to ignore
<i>declaration specifiers</i> except for the
<code>declaration</code>
<span id="index-declaration-1"></span>
,
<code>notinline</code>
<span id="index-notinline"></span>
,
<code>safety</code>
<span id="index-safety"></span>
,
and <code>special</code>
<span id="index-special"></span>
<i>declaration specifiers</i>.
</p>
<p>A <code>declaration</code> <i>declaration</i> must suppress warnings
about unrecognized <i>declarations</i> of the kind that it declares.
If an <i>implementation</i> does not produce warnings about
unrecognized declarations, it may safely ignore this <i>declaration</i>.
</p>
<p>A <code>notinline</code> <i>declaration</i> must be recognized by any <i>implementation</i>
that supports inline functions or <i>compiler macros</i> in order to disable those facilities.
An <i>implementation</i> that does not use inline functions or <i>compiler macros</i>
may safely ignore this <i>declaration</i>.
</p>
<p>A <code>safety</code> <i>declaration</i> that increases the current safety level 
must always be recognized.  An <i>implementation</i> that always processes 
code as if safety were high may safely ignore this <i>declaration</i>.
</p>
<p>A <code>special</code> <i>declaration</i> must be processed by all <i>implementations</i>.
</p>

<hr>
<span id="Declaration-Specifiers"></span><div class="header">
<p>
Next: <a href="#Declaration-Identifiers" accesskey="n" rel="next">Declaration Identifiers</a>, Previous: <a href="#Minimal-Declaration-Processing-Requirements" accesskey="p" rel="prev">Minimal Declaration Processing Requirements</a>, Up: <a href="#Declarations" accesskey="u" rel="up">Declarations</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Declaration-Specifiers-1"></span><h4 class="subsection">3.3.2 Declaration Specifiers</h4>

<p>A <span id="index-declaration-specifier"></span>
<em>declaration specifier</em> is an <i>expression</i> that can appear at
top level of a <tt>declare</tt> expression or a <code>declaim</code> form, or as 
the argument to <code>proclaim</code>.
It is a <i>list</i> whose <i>car</i> is a <i>declaration identifier</i>,
and whose <i>cdr</i> is data interpreted according to rules specific to
the <i>declaration identifier</i>.
</p>

<hr>
<span id="Declaration-Identifiers"></span><div class="header">
<p>
Next: <a href="#Declaration-Scope" accesskey="n" rel="next">Declaration Scope</a>, Previous: <a href="#Declaration-Specifiers" accesskey="p" rel="prev">Declaration Specifiers</a>, Up: <a href="#Declarations" accesskey="u" rel="up">Declarations</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Declaration-Identifiers-1"></span><h4 class="subsection">3.3.3 Declaration Identifiers</h4>

<p>The next figure&nbsp;<!-- /@w -->shows a list of all 
<i>declaration identifiers</i>
<span id="index-declaration-identifier"></span>
</p>
<p>defined by this standard.
</p>

<div class="float"><span id="fig3_002e9"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>declaration</td><td>ignore</td><td>special</td></tr>
<tr><td>dynamic-extent</td><td>inline</td><td>type</td></tr>
<tr><td>ftype</td><td>notinline</td><td></td></tr>
<tr><td>ignorable</td><td>optimize</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.9: </strong>Common Lisp Declaration Identifiers</p></div></div>

<p>An implementation is free to support other (<i>implementation-defined</i>)
<i>declaration identifiers</i> as well.  
A warning might be issued
if a <i>declaration identifier</i> 
is not among those defined above,
is not defined by the <i>implementation</i>,
is not a <i>type</i> <i>name</i>, 
and has not been declared in a <code>declaration</code> <i>proclamation</i>.
</p>
<span id="Shorthand-notation-for-Type-Declarations"></span><h4 class="subsubsection">3.3.3.1 Shorthand notation for Type Declarations</h4>

<p>A <i>type specifier</i> can be used as a <i>declaration identifier</i>.
<code>(<var>type-specifier</var> <tt>{</tt>var<tt>}</tt>*)</code> is taken as shorthand for
<code>(type <var>type-specifier</var> <tt>{</tt>var<tt>}</tt>*)</code>.
</p>


<hr>
<span id="Declaration-Scope"></span><div class="header">
<p>
Previous: <a href="#Declaration-Identifiers" accesskey="p" rel="prev">Declaration Identifiers</a>, Up: <a href="#Declarations" accesskey="u" rel="up">Declarations</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Declaration-Scope-1"></span><h4 class="subsection">3.3.4 Declaration Scope</h4>

<p><i>Declarations</i> can be divided into two kinds: those that apply to the
<i>bindings</i> of <i>variables</i> or <i>functions</i>; and those that
do not apply to <i>bindings</i>.
</p>
<p>A <i>declaration</i> that appears at the head of a binding <i>form</i> 
and applies to a <i>variable</i> or <i>function</i> <i>binding</i> 
made by that <i>form</i> is called a <span id="index-bound-declaration"></span>
<em>bound declaration</em>; 
such a <i>declaration</i> affects both the <i>binding</i> and
any references within the <i>scope</i> of the <i>declaration</i>.  
</p>
<p><i>Declarations</i> that are not <i>bound declarations</i> are called
<span id="index-free-declaration"></span>
<em>free declarations</em>.
</p>
<p>A <i>free declaration</i> in a <i>form</i> F1 that applies to a <i>binding</i>
for a <i>name</i> N <i>established</i> by some <i>form</i> F2
of which F1 is a <i>subform</i>
affects only references to N within F1; it does not to apply to
other references to N outside of F1, nor does it affect the manner
in which the <i>binding</i> of N by F2 is <i>established</i>.
</p>
<p><i>Declarations</i> that do not apply to <i>bindings</i> can only appear 
as <i>free declarations</i>.
</p>
<p>The <i>scope</i> of a <i>bound declaration</i> is the same as the
<i>lexical scope</i>
of the <i>binding</i> to which it applies;
for <i>special variables</i>,
this means the <i>scope</i> that the <i>binding</i> 
would have had had it been a <i>lexical binding</i>.
</p>
<p>Unless explicitly stated otherwise, the <i>scope</i> of a 
<i>free declaration</i> includes only the body <i>subforms</i> of 
the <i>form</i> at whose head it appears, and no other <i>subforms</i>.
The <i>scope</i> of <i>free declarations</i> specifically does not
include <i>initialization forms</i> for <i>bindings</i> established
by the <i>form</i> containing the <i>declarations</i>.
</p>
<p>Some <i>iteration forms</i> include step, end-test, or result 
<i>subforms</i> that are also included in the <i>scope</i>
of <i>declarations</i> that appear in the <i>iteration form</i>.
Specifically, the <i>iteration forms</i> and <i>subforms</i> involved
are:
</p>

<ul>
<li> <code>do</code>, <code>do*</code>:  
<var>step-forms</var>, <var>end-test-form</var>, and <var>result-forms</var>.
</li><li> <code>dolist</code>, <code>dotimes</code>:
<var>result-form</var>
</li><li> <code>do-all-symbols</code>, <code>do-external-symbols</code>, <code>do-symbols</code>:
<var>result-form</var>
</li></ul>


<span id="Examples-of-Declaration-Scope"></span><h4 class="subsubsection">3.3.4.1 Examples of Declaration Scope</h4>

<p>Here is an example illustrating the <i>scope</i> of <i>bound declarations</i>.
</p>
<div class="lisp">
<pre class="lisp"> (let ((x 1))                ;[1] 1st occurrence of x
   (declare (special x))     ;[2] 2nd occurrence of x
   (let ((x 2))              ;[3] 3rd occurrence of x
     (let ((old-x x)         ;[4] 4th occurrence of x
           (x 3))            ;[5] 5th occurrence of x
       (declare (special x)) ;[6] 6th occurrence of x
       (list old-x x))))     ;[7] 7th occurrence of x
<span class="roman">→</span> (2 3)
</pre></div>


<p>The first occurrence of <code>x</code> <i>establishes</i> a <i>dynamic binding</i>
of <code>x</code> because of the <code>special</code> <i>declaration</i> for <code>x</code>
in the second line.  The third occurrence of <code>x</code> <i>establishes</i> a
<i>lexical binding</i> of <code>x</code> (because there is no <code>special</code>
<i>declaration</i> in the corresponding <code>let</code> <i>form</i>).
The fourth occurrence of <code>x</code> <i>x</i> is a reference to the
<i>lexical binding</i> of <code>x</code> established in the third line.
The fifth occurrence of <code>x</code> <i>establishes</i> a <i>dynamic binding</i>
of <i>x</i> for the body of the <code>let</code> <i>form</i> that begins on
that line because of the <code>special</code> <i>declaration</i> for <code>x</code>
in the sixth line. The reference to <code>x</code> in the fourth line is not
affected by the <code>special</code> <i>declaration</i> in the sixth line 
because that reference is not within the &ldquo;would-be <i>lexical scope</i>&rdquo;
of the <i>variable</i> <code>x</code> in the fifth line.  The reference to <code>x</code>
in the seventh line is a reference to the <i>dynamic binding</i> of <i>x</i>
<i>established</i> in the fifth line.
</p>
<p>Here is another example, to illustrate the <i>scope</i> of a
<i>free declaration</i>.  In the following:
</p>
<div class="lisp">
<pre class="lisp"> (lambda (&amp;optional (x (foo 1))) ;[1]
   (declare (notinline foo))     ;[2]
   (foo x))                      ;[3]
</pre></div>


<p>the <i>call</i> to <code>foo</code> in the first line might be 
compiled inline even though the <i>call</i> to <code>foo</code> in
the third line must not be.  This is because
the <code>notinline</code> <i>declaration</i>
for <code>foo</code> in the second line applies only to the body on the
third line.  In order to suppress inlining for both <i>calls</i>, 
one might write:
</p>
<div class="lisp">
<pre class="lisp"> (locally (declare (notinline foo)) ;[1]
   (lambda (&amp;optional (x (foo 1)))  ;[2]
     (foo x)))                      ;[3]
</pre></div>


<p>or, alternatively:
</p>
<div class="lisp">
<pre class="lisp"> (lambda (&amp;optional                               ;[1]
            (x (locally (declare (notinline foo)) ;[2]
                 (foo 1))))                       ;[3]
   (declare (notinline foo))                      ;[4]
   (foo x))                                       ;[5]
</pre></div>


<p>Finally, here is an example that shows the <i>scope</i> of
<i>declarations</i> in an <i>iteration form</i>.
</p>
<div class="lisp">
<pre class="lisp"> (let ((x  1))                     ;[1]
   (declare (special x))           ;[2]
     (let ((x 2))                  ;[3]
       (dotimes (i x x)            ;[4]
         (declare (special x)))))  ;[5]
<span class="roman">→</span> 1
</pre></div>


<p>In this example, the first reference to <code>x</code> on the fourth line is to
the <i>lexical binding</i> of <code>x</code> established on the third line.
However, the second occurrence of <code>x</code> on the fourth line lies within
the <i>scope</i> of the <i>free declaration</i> on the fifth line
(because this is the <var>result-form</var> of the <code>dotimes</code>)
and therefore refers to the <i>dynamic binding</i> of <code>x</code>.
</p>


<hr>
<span id="Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Error-Checking-in-Function-Calls" accesskey="n" rel="next">Error Checking in Function Calls</a>, Previous: <a href="#Declarations" accesskey="p" rel="prev">Declarations</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Lambda-Lists-1"></span><h3 class="section">3.4 Lambda Lists</h3>

<p>A <span id="index-lambda-list"></span>
<em>lambda list</em> is a <i>list</i> that
specifies a set of <i>parameters</i> (sometimes called <i>lambda variables</i>)
and a protocol for receiving <i>values</i> for those <i>parameters</i>.
</p>
<p>There are several kinds of <i>lambda lists</i>.
</p>

<div class="float"><span id="fig3_002e10"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<thead><tr><th>Context</th><th>Kind of Lambda List</th></tr></thead>
<tr><td><code>defun</code> <i>form</i></td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>defmacro</code> <i>form</i></td><td><i>macro lambda list</i></td></tr>
<tr><td><i>lambda expression</i></td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>flet</code> local <i>function</i> definition</td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>labels</code> local <i>function</i> definition</td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>handler-case</code> <var>clause</var> specification</td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>restart-case</code> <var>clause</var> specification</td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>macrolet</code> local <i>macro</i> definition</td><td><i>macro lambda list</i></td></tr>
<tr><td><code>define-method-combination</code></td><td><i>ordinary lambda list</i></td></tr>
<tr><td><code>define-method-combination</code> <tt>:arguments</tt> option</td><td><i>define-method-combination arguments lambda list</i></td></tr>
<tr><td><code>defstruct</code> <tt>:constructor</tt> option</td><td><i>boa lambda list</i></td></tr>
<tr><td><code>defgeneric</code> <i>form</i></td><td><i>generic function lambda list</i></td></tr>
<tr><td><code>defgeneric</code> <i>method</i> clause</td><td><i>specialized lambda list</i></td></tr>
<tr><td><code>defmethod</code> <i>form</i></td><td><i>specialized lambda list</i></td></tr>
<tr><td><code>defsetf</code> <i>form</i></td><td><i>defsetf lambda list</i></td></tr>
<tr><td><code>define-setf-expander</code> <i>form</i></td><td><i>macro lambda list</i></td></tr>
<tr><td><code>deftype</code> <i>form</i></td><td><i>deftype lambda list</i></td></tr>
<tr><td><code>destructuring-bind</code> <i>form</i></td><td><i>destructuring lambda list</i></td></tr>
<tr><td><code>define-compiler-macro</code> <i>form</i></td><td><i>macro lambda list</i></td></tr>
<tr><td><code>define-modify-macro</code> <i>form</i></td><td><i>define-modify-macro lambda list</i></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.10: </strong>What Kind of Lambda Lists to Use</p></div></div>

<p>The next figure&nbsp;<!-- /@w -->lists some <i>defined names</i> that are applicable
to <i>lambda lists</i>.
</p>

<div class="float"><span id="fig3_002e11"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>lambda-list-keywords</td><td>lambda-parameters-limit</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.11: </strong>Defined names applicable to lambda lists</p></div></div>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Ordinary-Lambda-Lists" accesskey="1">Ordinary Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Generic-Function-Lambda-Lists" accesskey="2">Generic Function Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Specialized-Lambda-Lists" accesskey="3">Specialized Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Macro-Lambda-Lists" accesskey="4">Macro Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Destructuring-Lambda-Lists" accesskey="5">Destructuring Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Boa-Lambda-Lists" accesskey="6">Boa Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Defsetf-Lambda-Lists" accesskey="7">Defsetf Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Deftype-Lambda-Lists" accesskey="8">Deftype Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Define_002dmodify_002dmacro-Lambda-Lists" accesskey="9">Define-modify-macro Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Define_002dmethod_002dcombination-Arguments-Lambda-Lists">Define-method-combination Arguments Lambda Lists</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Syntactic-Interaction-of-Documentation-Strings-and-Declarations">Syntactic Interaction of Documentation Strings and Declarations</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>
<hr>
<span id="Ordinary-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Generic-Function-Lambda-Lists" accesskey="n" rel="next">Generic Function Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Ordinary-Lambda-Lists-1"></span><h4 class="subsection">3.4.1 Ordinary Lambda Lists</h4>

<p>An <span id="index-ordinary-lambda-list"></span>
<em>ordinary lambda list</em> is used to describe how a set of
<i>arguments</i> is received by an <i>ordinary</i> <i>function</i>.  
The <i>defined names</i> in the next figure&nbsp;<!-- /@w -->are those which use
<i>ordinary lambda lists</i>:
</p>

<div class="float"><span id="fig3_002e12"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>define-method-combination</td><td>handler-case</td><td>restart-case</td></tr>
<tr><td>defun</td><td>labels</td><td></td></tr>
<tr><td>flet</td><td>lambda</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.12: </strong>Standardized Operators that use Ordinary Lambda Lists</p></div></div>

<p>An <i>ordinary lambda list</i> can contain the <i>lambda list keywords</i> shown
in the next figure.
</p>

<div class="float"><span id="fig3_002e13"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;allow-other-keys</code></td><td><code>&amp;key</code></td><td><code>&amp;rest</code></td></tr>
<tr><td><code>&amp;aux</code></td><td><code>&amp;optional</code></td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.13: </strong>Lambda List Keywords used by Ordinary Lambda Lists</p></div></div>

<p>Each <i>element</i> of a <i>lambda list</i> is either a parameter specifier
or a <i>lambda list keyword</i>.
Implementations are free to provide additional <i>lambda list keywords</i>.
For a list of all <i>lambda list keywords</i>
used by the implementation, see <code>lambda-list-keywords</code>.
</p>
<p>The syntax for <i>ordinary lambda lists</i> is as follows: 
</p>

<dl compact="compact">
<dt><var>lambda-list</var>::=</dt>
<dd><p><tt>(</tt><tt>{</tt>var<tt>}</tt>*<br> &nbsp;<!-- /@w --><tt>[</tt><tt>&amp;optional</tt> <tt>{</tt>var <span class="roman">|</span> (var [init-form [supplied-p-parameter]])<tt>}</tt>*<tt>]</tt><br> &nbsp;<!-- /@w --><tt>[</tt><tt>&amp;rest</tt> <var>var</var><tt>]</tt><br> &nbsp;<!-- /@w --><code>[</code><tt>&amp;key</tt>&nbsp;<tt>{</tt>var&nbsp;(<tt>{</tt>var&nbsp;<span class="roman">|</span>&nbsp;<span class="nolinebreak">(keyword-name</span>&nbsp;var)<tt>}</tt>&nbsp;<span class="nolinebreak">[init-form</span>&nbsp;<span class="nolinebreak">[supplied-p-parameter]])</span><tt>}</tt>*<!-- /@w -->  <tt>[</tt><tt><span class="nolinebreak">&amp;allow-other-keys</span></tt><tt>]</tt><code>]</code><!-- /@w --><br> &nbsp;<!-- /@w --><tt>[</tt><tt>&amp;aux</tt> <tt>{</tt>var <span class="roman">|</span> (var [init-form])<tt>}</tt>*<tt>]</tt><tt>)</tt><br>
</p></dd>
</dl>

<p>A <var>var</var> or <var>supplied-p-parameter</var> must be a <i>symbol</i>
that is not the name of a <i>constant variable</i>.
</p>
<p>An <var>init-form</var> can be any <i>form</i>.
Whenever any <var>init-form</var> is evaluated for any parameter
specifier, that <i>form</i> may refer to any parameter variable to
the left of the specifier in which the <var>init-form</var> appears,
including any <var>supplied-p-parameter</var> variables, and may rely 
on the fact that no other parameter variable has yet been bound
(including its own parameter variable).
</p>
<p>A <var>keyword-name</var> can be any <i>symbol</i>, 
but by convention is normally a <i>keyword</i><sub>1</sub>
all <i>standardized</i> <i>functions</i> follow that convention.
</p>
<p>An <i>ordinary lambda list</i> has five parts, any or all of which may be empty.
For information about the treatment of argument mismatches,
see <a href="#Error-Checking-in-Function-Calls">Section 3.5 (Error Checking in Function Calls)</a>.
</p>
<span id="Specifiers-for-the-required-parameters"></span><h4 class="subsubsection">3.4.1.1 Specifiers for the required parameters</h4>

<p>These are all the parameter specifiers up to 
the first <i>lambda list keyword</i>;
if there are no <i>lambda list keywords</i>, 
then all the specifiers are for required parameters.
Each required parameter is specified by a parameter variable <var>var</var>.
<var>var</var> is bound as a lexical variable unless it is declared <code>special</code>.
</p>
<p>If there are <code>n</code> required parameters (<code>n</code> may be zero), 
there must be at least <code>n</code> passed arguments, and the 
required parameters are bound to the first <code>n</code> passed arguments;
see <a href="#Error-Checking-in-Function-Calls">Section 3.5 (Error Checking in Function Calls)</a>.
The other parameters are then processed using any remaining arguments.
</p>

<span id="Specifiers-for-optional-parameters"></span><h4 class="subsubsection">3.4.1.2 Specifiers for optional parameters</h4>
<span id="index-_0026optional"></span>

<p>If <code>&amp;optional</code> is present,
the optional parameter specifiers are those following 
<code>&amp;optional</code> 
up to the next <i>lambda list keyword</i> or the end of the list.
If optional parameters are specified, then each one is processed as
follows.  If any unprocessed arguments remain, then the parameter variable
<var>var</var> is bound to the next remaining argument, just as for a required
parameter.  If no arguments remain, however, then <var>init-form</var> 
is evaluated, and the parameter variable
is bound to the resulting value 
(or to <code>nil</code>&nbsp;<!-- /@w -->if no <var>init-form</var> appears
in the parameter specifier).
If another variable name <var>supplied-p-parameter</var> 
appears in the specifier, it is bound
to <i>true</i> if an argument had been available, and to <i>false</i> if no
argument remained (and therefore <var>init-form</var> had to be evaluated).
<var>Supplied-p-parameter</var>
is bound not to an argument but to a value indicating whether or not
an argument had been supplied for the corresponding <var>var</var>.
</p>

<span id="A-specifier-for-a-rest-parameter"></span><h4 class="subsubsection">3.4.1.3 A specifier for a rest parameter</h4>
<span id="index-_0026rest"></span>

<p><code>&amp;rest</code>, if present, must be followed by a single <i>rest parameter</i>
specifier, which in turn must be followed by another 
<i>lambda list keyword</i> or the end of the <i>lambda list</i>.  After all
optional parameter specifiers have been processed, then there may or
may not be a <i>rest parameter</i>.  If there is a <i>rest parameter</i>, it is
bound to a <i>list</i> of all as-yet-unprocessed arguments.  If
no unprocessed arguments remain, the <i>rest parameter</i> is bound to the
<i>empty list</i>.  If there is no <i>rest parameter</i> and there are no 
<i>keyword parameters</i>, then an error 
should be signaled if
any unprocessed arguments remain; see <a href="#Error-Checking-in-Function-Calls">Section 3.5 (Error Checking in Function Calls)</a>.
The value of a <i>rest parameter</i>
is permitted, but not required, to share structure with the
last argument to <code>apply</code>.
</p>
<span id="index-_0026key"></span>
<span id="index-_0026allow_002dother_002dkeys"></span>

<span id="Specifiers-for-keyword-parameters"></span><h4 class="subsubsection">3.4.1.4 Specifiers for keyword parameters</h4>

<p>If <code>&amp;key</code> 
is present, all specifiers up to the next <i>lambda list keyword</i>
or the end of the <i>list</i> are keyword parameter specifiers.
When keyword parameters are processed,
the same arguments are processed that
would be made into a <i>list</i> for a <i>rest parameter</i>.
It is permitted to specify both <code>&amp;rest</code> and <code>&amp;key</code>.
In this case the remaining arguments are used for both purposes;
that is, all remaining arguments are made into a <i>list</i> for the
<i>rest parameter</i>, and are also processed for the <code>&amp;key</code> parameters.
If <code>&amp;key</code> is specified, there must remain
an even number of arguments; see <a href="#OddNumberOfKeyArgs">Section 3.5.1.6 (Odd Number of Keyword Arguments)</a>.
These arguments are considered as pairs,
the first argument in each pair being interpreted as a name
and the second as the corresponding value.
The first <i>object</i> of each pair must be a <i>symbol</i>;
see <a href="#InvalidKeyArgs">Section 3.5.1.5 (Invalid Keyword Arguments)</a>.
The keyword parameter specifiers may optionally be followed by the
<i>lambda list keyword</i> <code>&amp;allow-other-keys</code>.
</p>
<p>In each keyword parameter specifier must be a name <var>var</var> for
the parameter variable.
If the <var>var</var> appears alone or in a <code>(<var>var</var> <var>init-form</var>)</code>
combination, the keyword name used when matching <i>arguments</i> to <i>parameters</i>
is a <i>symbol</i> in the <code>KEYWORD</code> <i>package</i> whose <i>name</i> is the
<i>same</i> (under <code>string=</code>) as <var>var</var>&rsquo;s.
If the notation <code>((<var>keyword-name</var> <var>var</var>) <var>init-form</var>)</code> is used,
then the keyword name used to match <i>arguments</i> to <i>parameters</i> is
<var>keyword-name</var>, which may be a <i>symbol</i> in any <i>package</i>.
(Of course, if it is not a <i>symbol</i> in the <code>KEYWORD</code> <i>package</i>,
it does not necessarily self-evaluate, so care must be taken when calling the function
to make sure that normal evaluation still yields the keyword name.)
Thus
</p>
<div class="lisp">
<pre class="lisp"> (defun foo (&amp;key radix (type 'integer)) ...)
</pre></div>

<p>means exactly the same as
</p>
<div class="lisp">
<pre class="lisp"> (defun foo (&amp;key ((:radix radix)) ((:type type) 'integer)) ...)
</pre></div>


<p>The keyword parameter specifiers are, like all parameter specifiers,
effectively processed from left to right.  For each keyword parameter
specifier, if there is an argument pair whose name matches that
specifier&rsquo;s name (that is, the names are <code>eq</code>), then the
parameter variable for that specifier is bound to the second item (the
value) of that argument pair.  If more than one such argument pair
matches, the leftmost argument pair is used.  If no such argument pair
exists, then the <var>init-form</var> for that specifier is evaluated and
the parameter variable is bound to that value (or to <code>nil</code>&nbsp;<!-- /@w -->if no
<var>init-form</var> was specified).  <var>supplied-p-parameter</var> is
treated as for <code>&amp;optional</code> parameters: it is bound to <i>true</i> if there
was a matching argument pair, and to <i>false</i> otherwise.
</p>
<p>Unless keyword argument checking is suppressed,
an argument pair must a name matched by a parameter specifier;
see <a href="#UnrecognizedKeyArgs">Section 3.5.1.4 (Unrecognized Keyword Arguments)</a>.
</p>
<p>If keyword argument checking is suppressed, 
then it is permitted for an argument pair
to match no parameter specifier, and the argument pair is ignored, but
such an argument pair is accessible through the <i>rest parameter</i> if
one was supplied.  The purpose of these mechanisms is to allow sharing
of argument lists among several <i>lambda expressions</i> and to
allow either the caller or the called <i>lambda expression</i> to
specify that such sharing may be taking place.
</p>
<p>Note that if <code>&amp;key</code> is present, a keyword argument of <tt>:allow-other-keys</tt>
is always permitted&mdash;regardless of whether the associated value is <i>true</i>
or <i>false</i>.  However, if the value is <i>false</i>, other non-matching
keywords are not tolerated (unless <code>&amp;allow-other-keys</code> was used).
</p>
<p>Furthermore, if the receiving argument list specifies a regular argument which
would be flagged by <tt>:allow-other-keys</tt>, then <tt>:allow-other-keys</tt> has both
its special-cased meaning (identifying whether additional keywords are permitted)
and its normal meaning (data flow into the function in question).
</p>
<span id="g_t3_002e4_002e1_002e4_002e1-Suppressing-Keyword-Argument-Checking"></span><h4 class="unnumberedsubsubsec">3.4.1.4.1 Suppressing Keyword Argument Checking</h4>

<span id="SuppressingKeyArgChecks"></span>
<p>If <code>&amp;allow-other-keys</code> was specified in the <i>lambda list</i> of a <i>function</i>,
<i>keyword</i><sub>2</sub>
to that <i>function</i>.
</p>
<p>If the <tt>:allow-other-keys</tt> <i>argument</i> is <i>true</i> in a call to a <i>function</i>,
<i>keyword</i><sub>2</sub>
in that call.
</p>
<p>The <tt>:allow-other-keys</tt> <i>argument</i> is permissible in all situations involving
<i>keyword</i><sub>2</sub>
is <i>false</i>.
</p>
<span id="g_t3_002e4_002e1_002e4_002e1_002e1-Examples-of-Suppressing-Keyword-Argument-Checking"></span><h4 class="unnumberedsubsubsec">3.4.1.4.1.1 Examples of Suppressing Keyword Argument Checking</h4>


<div class="lisp">
<pre class="lisp">;;; The caller can supply :ALLOW-OTHER-KEYS T to suppress checking.
 ((lambda (&amp;key x) x) :x 1 :y 2 :allow-other-keys t) <span class="roman">→</span> 1
;;; The callee can use &amp;ALLOW-OTHER-KEYS to suppress checking.
 ((lambda (&amp;key x &amp;allow-other-keys) x) :x 1 :y 2) <span class="roman">→</span> 1
;;; :ALLOW-OTHER-KEYS NIL is always permitted.
 ((lambda (&amp;key) t) :allow-other-keys nil) <span class="roman">→</span> T
;;; As with other keyword arguments, only the left-most pair
;;; named :ALLOW-OTHER-KEYS has any effect.
 ((lambda (&amp;key x) x) 
  :x 1 :y 2 :allow-other-keys t :allow-other-keys nil)
<span class="roman">→</span> 1
;;; Only the left-most pair named :ALLOW-OTHER-KEYS has any effect,
;;; so in safe code this signals a PROGRAM-ERROR (and might enter the
;;; debugger).  In unsafe code, the consequences are undefined.
 ((lambda (&amp;key x) x)                   ;This call is not valid
  :x 1 :y 2 :allow-other-keys nil :allow-other-keys t)
</pre></div>





<span id="Specifiers-for-_0026aux-variables"></span><h4 class="subsubsection">3.4.1.5 Specifiers for <code>&amp;aux</code> variables</h4>
<span id="index-_0026aux"></span>

<p>These are not really parameters.  If the <i>lambda list keyword</i>
<code>&amp;aux</code> is present, all specifiers after it are auxiliary variable
specifiers.  After all parameter specifiers have been processed, the
auxiliary variable specifiers (those following <tt>&amp;aux</tt>) are processed
from left to right.  For each one, <var>init-form</var> is evaluated and
<var>var</var> is bound to that value (or to <code>nil</code>&nbsp;<!-- /@w -->if no <var>init-form</var>
was specified).  <code>&amp;aux</code> variable processing is analogous to
<code>let*</code> processing.
</p>
<div class="lisp">
<pre class="lisp"> (lambda (x y &amp;aux (a (car x)) (b 2) c) (list x y a b c))
    ≡ (lambda (x y) (let* ((a (car x)) (b 2) c) (list x y a b c)))
</pre></div>



<span id="Examples-of-Ordinary-Lambda-Lists"></span><h4 class="subsubsection">3.4.1.6 Examples of Ordinary Lambda Lists</h4>

<p>Here are some examples involving <i>optional parameters</i> and <i>rest parameters</i>:
</p>
<div class="lisp">
<pre class="lisp"> ((lambda (a b) (+ a (* b 3))) 4 5) <span class="roman">→</span> 19
 ((lambda (a &amp;optional (b 2)) (+ a (* b 3))) 4 5) <span class="roman">→</span> 19
 ((lambda (a &amp;optional (b 2)) (+ a (* b 3))) 4) <span class="roman">→</span> 10
 ((lambda (&amp;optional (a 2 b) (c 3 d) &amp;rest x) (list a b c d x)))
<span class="roman">→</span> (2 NIL 3 NIL NIL)
 ((lambda (&amp;optional (a 2 b) (c 3 d) &amp;rest x) (list a b c d x)) 6)
<span class="roman">→</span> (6 T 3 NIL NIL)
 ((lambda (&amp;optional (a 2 b) (c 3 d) &amp;rest x) (list a b c d x)) 6 3)
<span class="roman">→</span> (6 T 3 T NIL)
 ((lambda (&amp;optional (a 2 b) (c 3 d) &amp;rest x) (list a b c d x)) 6 3 8)
<span class="roman">→</span> (6 T 3 T (8))
 ((lambda (&amp;optional (a 2 b) (c 3 d) &amp;rest x) (list a b c d x))
  6 3 8 9 10 11)
<span class="roman">→</span> (6 t 3 t (8 9 10 11))
</pre></div>


<p>Here are some examples involving <i>keyword parameters</i>:
</p>
<div class="lisp">
<pre class="lisp"> ((lambda (a b &amp;key c d) (list a b c d)) 1 2) <span class="roman">→</span> (1 2 NIL NIL)
 ((lambda (a b &amp;key c d) (list a b c d)) 1 2 :c 6) <span class="roman">→</span> (1 2 6 NIL)
 ((lambda (a b &amp;key c d) (list a b c d)) 1 2 :d 8) <span class="roman">→</span> (1 2 NIL 8)
 ((lambda (a b &amp;key c d) (list a b c d)) 1 2 :c 6 :d 8) <span class="roman">→</span> (1 2 6 8)
 ((lambda (a b &amp;key c d) (list a b c d)) 1 2 :d 8 :c 6) <span class="roman">→</span> (1 2 6 8)
 ((lambda (a b &amp;key c d) (list a b c d)) :a 1 :d 8 :c 6) <span class="roman">→</span> (:a 1 6 8)
 ((lambda (a b &amp;key c d) (list a b c d)) :a :b :c :d) <span class="roman">→</span> (:a :b :d NIL)
 ((lambda (a b &amp;key ((:sea c)) d) (list a b c d)) 1 2 :sea 6) <span class="roman">→</span> (1 2 6 NIL)
 ((lambda (a b &amp;key ((c c)) d) (list a b c d)) 1 2 'c 6) <span class="roman">→</span> (1 2 6 NIL)
</pre></div>


<p>Here are some examples involving <i>optional parameters</i>, <i>rest parameters</i>,
and <i>keyword parameters</i> together:
</p>
<div class="lisp">
<pre class="lisp"> ((lambda (a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    (list a b c d x)) 1)   
<span class="roman">→</span> (1 3 NIL 1 ()) 
 ((lambda (a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    (list a b c d x)) 1 2)
<span class="roman">→</span> (1 2 NIL 1 ())
 ((lambda (a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    (list a b c d x)) :c 7)
<span class="roman">→</span> (:c 7 NIL :c ())
 ((lambda (a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    (list a b c d x)) 1 6 :c 7)
<span class="roman">→</span> (1 6 7 1 (:c 7))
 ((lambda (a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    (list a b c d x)) 1 6 :d 8)
<span class="roman">→</span> (1 6 NIL 8 (:d 8))
 ((lambda (a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    (list a b c d x)) 1 6 :d 8 :c 9 :d 10)
<span class="roman">→</span> (1 6 9 8 (:d 8 :c 9 :d 10))
</pre></div>


<p>As an example of the use of <code>&amp;allow-other-keys</code> and
<tt>:allow-other-keys</tt>, consider a <i>function</i> that takes two named
arguments of its own and also accepts additional named arguments to be
passed to <code>make-array</code>:
</p>
<div class="lisp">
<pre class="lisp"> (defun array-of-strings (str dims &amp;rest named-pairs
                          &amp;key (start 0) end &amp;allow-other-keys)
   (apply #'make-array dims
          :initial-element (subseq str start end)
          :allow-other-keys t
          named-pairs))
</pre></div>


<p>This <i>function</i> takes a <i>string</i> and dimensioning
information and returns an <i>array</i> of the specified
dimensions, each of whose elements is the specified 
<i>string</i>.  However, <tt>:start</tt> and <tt>:end</tt> named
arguments may be used to specify that a substring of the given
<i>string</i> should be used.  In addition, the presence of
<code>&amp;allow-other-keys</code> in the <i>lambda list</i> indicates that the
caller may supply additional named arguments; the <i>rest parameter</i>
provides access to them.  These additional named arguments are passed
to <code>make-array</code>.  The <i>function</i> <code>make-array</code>
normally does not allow the named arguments <tt>:start</tt> 
and <tt>:end</tt> to be used, and an error should be
signaled if such named arguments are supplied to <code>make-array</code>.
However, the presence in the call to <code>make-array</code> 
of the named argument <tt>:allow-other-keys</tt> with
a <i>true</i> value causes any extraneous named arguments, including
<tt>:start</tt> and <tt>:end</tt>, to be acceptable and ignored.
</p>


<hr>
<span id="Generic-Function-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Specialized-Lambda-Lists" accesskey="n" rel="next">Specialized Lambda Lists</a>, Previous: <a href="#Ordinary-Lambda-Lists" accesskey="p" rel="prev">Ordinary Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Generic-Function-Lambda-Lists-1"></span><h4 class="subsection">3.4.2 Generic Function Lambda Lists</h4>

<p>A <span id="index-generic-function-lambda-list"></span>
<em>generic function lambda list</em> is used to describe the overall shape of
the argument list to be accepted by a <i>generic function</i>.
Individual <i>method</i> <i>signatures</i> might contribute additional 
<i>keyword parameters</i> to the <i>lambda list</i> of the <i>effective method</i>.
</p>
<p>A <i>generic function lambda list</i> is used by <code>defgeneric</code>.
</p>
<p>A <i>generic function lambda list</i> has the following syntax:
</p>

<dl compact="compact">
<dt><var>lambda-list</var>::=</dt>
<dd><p><tt>(</tt><tt>{</tt>var<tt>}</tt>*<br> &nbsp;<!-- /@w --><tt>[</tt><tt>&amp;optional</tt> <tt>{</tt>var <span class="roman">|</span> (var)<tt>}</tt>*<tt>]</tt><br> &nbsp;<!-- /@w --><tt>[</tt><tt>&amp;rest</tt> <var>var</var><tt>]</tt><br> &nbsp;<!-- /@w --><code>[</code><tt>&amp;key</tt>&nbsp;<tt>{</tt>var&nbsp;<span class="roman">|</span>&nbsp;(<tt>{</tt>var&nbsp;<span class="roman">|</span>&nbsp;<span class="nolinebreak">(keyword-name</span>&nbsp;var)<tt>}</tt>&nbsp;<span class="nolinebreak">[init-form</span>&nbsp;<span class="nolinebreak">[supplied-p-parameter]])</span><tt>}</tt>*<!-- /@w -->  <tt>[</tt><tt><span class="nolinebreak">&amp;allow-other-keys</span></tt><tt>]</tt><code>]</code><tt>)</tt><!-- /@w --><br>
</p></dd>
</dl>

<p>A <i>generic function lambda list</i> can contain the <i>lambda list keywords</i> shown
in the next figure.
</p>

<div class="float"><span id="fig3_002e14"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;allow-other-keys</code></td><td><code>&amp;optional</code></td><td></td></tr>
<tr><td><code>&amp;key</code></td><td><code>&amp;rest</code></td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.14: </strong>Lambda List Keywords used by Generic Function Lambda Lists</p></div></div>

<p>A <i>generic function lambda list</i> differs from an <i>ordinary lambda list</i> 
in the following ways:
</p>

<dl compact="compact">
<dt><b>Required arguments</b></dt>
<dd>

<p>Zero or more <i>required parameters</i> must be specified.
</p>
</dd>
<dt><b>Optional and keyword arguments</b></dt>
<dd>

<p><i>Optional parameters</i> and <i>keyword parameters</i> may not have 
default initial value forms nor use supplied-p parameters.
</p>
</dd>
<dt><b>Use of <code>&amp;aux</code></b></dt>
<dd>

<p>The use of <code>&amp;aux</code> is not allowed. 
</p></dd>
</dl>




<hr>
<span id="Specialized-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Macro-Lambda-Lists" accesskey="n" rel="next">Macro Lambda Lists</a>, Previous: <a href="#Generic-Function-Lambda-Lists" accesskey="p" rel="prev">Generic Function Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Specialized-Lambda-Lists-1"></span><h4 class="subsection">3.4.3 Specialized Lambda Lists</h4>

<p>A <span id="index-specialized-lambda-list"></span>
<em>specialized lambda list</em> is used to <i>specialize</i> a <i>method</i>
for a particular <i>signature</i> and to describe how <i>arguments</i> matching
that <i>signature</i> are received by the <i>method</i>.  
The <i>defined names</i> in the next figure&nbsp;<!-- /@w -->use <i>specialized lambda lists</i>
in some way; see the dictionary entry for each for information about how.
</p>

<div class="float"><span id="fig3_002e15"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>defmethod</td><td>defgeneric</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.15: </strong>Standardized Operators that use Specialized Lambda Lists</p></div></div>

<p>A <i>specialized lambda list</i> can contain the <i>lambda list keywords</i> shown
in the next figure.
</p>

<div class="float"><span id="fig3_002e16"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;allow-other-keys</code></td><td><code>&amp;key</code></td><td><code>&amp;rest</code></td></tr>
<tr><td><code>&amp;aux</code></td><td><code>&amp;optional</code></td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.16: </strong>Lambda List Keywords used by Specialized Lambda Lists</p></div></div>

<p>A <i>specialized lambda list</i> is syntactically the same as an <i>ordinary lambda list</i>
except that each <i>required parameter</i> may optionally be associated with a <i>class</i>
or <i>object</i> for which that <i>parameter</i> is <i>specialized</i>.
</p>

<dl compact="compact">
<dt><var>lambda-list</var>::=</dt>
<dd><p><tt>(</tt><tt>{</tt>var <span class="roman">|</span> (var [specializer])<tt>}</tt>*<br> <tt>[</tt><tt>&amp;optional</tt> <tt>{</tt>var <span class="roman">|</span> (var [init-form [supplied-p-parameter]])<tt>}</tt>*<tt>]</tt><br> <tt>[</tt><tt>&amp;rest</tt> <var>var</var><tt>]</tt><br> <tt>[</tt><tt>&amp;key</tt> <tt>{</tt>var (<tt>{</tt>var <span class="roman">|</span> (keyword-name var)<tt>}</tt>
[init-form [supplied-p-parameter]])<tt>}</tt>* <tt>[</tt><tt>&amp;allow-other-keys</tt><tt>]</tt><tt>]</tt><br> <tt>[</tt><tt>&amp;aux</tt> <tt>{</tt>var <span class="roman">|</span> (var [init-form])<tt>}</tt>*<tt>]</tt><tt>)</tt><br>
</p></dd>
</dl>


<hr>
<span id="Macro-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Destructuring-Lambda-Lists" accesskey="n" rel="next">Destructuring Lambda Lists</a>, Previous: <a href="#Specialized-Lambda-Lists" accesskey="p" rel="prev">Specialized Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Macro-Lambda-Lists-1"></span><h4 class="subsection">3.4.4 Macro Lambda Lists</h4>

<p>A <span id="index-macro-lambda-list"></span>
<em>macro lambda list</em> is used in describing <i>macros</i> 
defined by the <i>operators</i> in the next figure.
</p>

<div class="float"><span id="fig3_002e17"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>define-compiler-macro</td><td>defmacro</td><td>macrolet</td></tr>
<tr><td>define-setf-expander</td><td></td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.17: </strong>Operators that use Macro Lambda Lists</p></div></div>

<p>With the additional restriction that
an <i>environment parameter</i> may appear only once
(at any of the positions indicated),
a <i>macro lambda list</i> has the following syntax:
</p>
<dl compact="compact">
<dt><var>reqvars</var>::=</dt>
<dd><p><tt>{</tt>var | <tt>↓</tt>pattern<tt>}</tt>*
</p></dd>
</dl>

<dl compact="compact">
<dt><var>optvars</var>::=</dt>
<dd><p>[<tt>&amp;optional</tt> <tt>{</tt>var | (<tt>{</tt>var
<tt>↓</tt>pattern<tt>}</tt> [init-form [supplied-p-parameter]])<tt>}</tt>*]
</p></dd>
</dl>

<dl compact="compact">
<dt><var>restvars</var>::=</dt>
<dd><p>[<tt>{</tt><tt>&amp;rest</tt> | <tt>&amp;body</tt><tt>}</tt> <tt>{</tt>var | <tt>↓</tt>pattern<tt>}</tt>]
</p></dd>
</dl>

<dl compact="compact">
<dt><var>keyvars</var>::=</dt>
<dd><p>[<tt>&amp;key</tt> <tt>{</tt>var | (<tt>{</tt>var | (keyword-name
<tt>{</tt>var | <tt>↓</tt>pattern<tt>}</tt>)<tt>}</tt> [init-form [supplied-p-parameter]])<tt>}</tt>*
[<tt>&amp;allow-other-keys</tt>]]
</p></dd>
</dl>

<dl compact="compact">
<dt><var>auxvars</var>::=</dt>
<dd><p>[<tt>&amp;aux</tt> <tt>{</tt>var | (var [init-form])<tt>}</tt>*]
</p></dd>
</dl>
<dl compact="compact">
<dt><var>envvar</var>::=</dt>
<dd><p><tt>[</tt><tt>&amp;environment</tt> <var>var</var><tt>]</tt>
</p></dd>
</dl>
<dl compact="compact">
<dt><var>wholevar</var>::=</dt>
<dd><p><tt>[</tt><tt>&amp;whole</tt> <var>var</var><tt>]</tt>
</p></dd>
</dl>
<dl compact="compact">
<dt><var>lambda-list</var>::=</dt>
<dd><p><tt>(</tt><tt>↓</tt>wholevar <tt>↓</tt>envvar <tt>↓</tt>reqvars <tt>↓</tt>envvar <tt>↓</tt>optvars <tt>↓</tt>envvar<br> <tt>↓</tt>restvar <tt>↓</tt>envvar <tt>↓</tt>keyvars <tt>↓</tt>envvar <tt>↓</tt>auxvars <tt>↓</tt>envvar<tt>)</tt>&nbsp;<!-- /@w -->|<br> <tt>(</tt><tt>↓</tt>wholevar <tt>↓</tt>envvar <tt>↓</tt>reqvars <tt>↓</tt>envvar <tt>↓</tt>optvars <tt>↓</tt>envvar <code>.</code> <var>var</var><tt>)</tt>
</p></dd>
</dl>
<dl compact="compact">
<dt><var>pattern</var>::=</dt>
<dd><p><tt>(</tt><tt>↓</tt>wholevar <tt>↓</tt>reqvars <tt>↓</tt>optvars <tt>↓</tt>restvar <tt>↓</tt>keyvars <tt>↓</tt>auxvars<tt>)</tt> |<br> <tt>(</tt><tt>↓</tt>wholevar <tt>↓</tt>reqvars <tt>↓</tt>optvars <code>.</code> <var>var</var><tt>)</tt>
</p></dd>
</dl>

<p>A <i>macro lambda list</i> can contain
the <i>lambda list keywords</i> shown in the next figure.
</p>

<div class="float"><span id="fig3_002e18"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;allow-other-keys</code></td><td><code>&amp;environment</code></td><td><code>&amp;rest</code></td></tr>
<tr><td><code>&amp;aux</code></td><td><code>&amp;key</code></td><td><code>&amp;whole</code></td></tr>
<tr><td><code>&amp;body</code></td><td><code>&amp;optional</code></td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.18: </strong>Lambda List Keywords used by Macro Lambda Lists</p></div></div>

<p><i>Optional parameters</i> (introduced by <code>&amp;optional</code>) and
<i>keyword parameters</i> (introduced by <code>&amp;key</code>)
can be supplied in a <i>macro lambda list</i>,
just as in an <i>ordinary lambda list</i>.
Both may contain default initialization forms and <i>supplied-p parameters</i>.
</p>
<p><code>&amp;body</code>
<span id="index-_0026body"></span>
is identical in function to <code>&amp;rest</code>,
but it can be used to inform certain output-formatting 
and editing functions that the remainder of the <i>form</i> is
treated as a body, and should be indented accordingly.
Only one of <code>&amp;body</code> or <code>&amp;rest</code> can be used at any particular level; 
see <a href="#DestructuringByLambdaLists">Section 3.4.4.1 (Destructuring by Lambda Lists)</a>.
<code>&amp;body</code> can appear at any level of a 
<i>macro lambda list</i>; 
for details, see <a href="#DestructuringByLambdaLists">Section 3.4.4.1 (Destructuring by Lambda Lists)</a>.
</p>
<p><code>&amp;whole</code>
<span id="index-_0026whole"></span>
is followed by a single variable that is bound to the
entire macro-call form; this is the value that the <i>macro function</i>
receives as its first argument.
If <code>&amp;whole</code> and a following variable appear,
they must appear first in <var>lambda-list</var>,
before any other parameter or <i>lambda list keyword</i>.
<code>&amp;whole</code> can appear at any level of a <i>macro lambda list</i>. 
At inner levels, the <code>&amp;whole</code> variable is bound to
the corresponding part of the argument, 
as with <code>&amp;rest</code>, but unlike <code>&amp;rest</code>, other arguments are also allowed.
The use of <code>&amp;whole</code> does not affect the pattern of arguments
specified.
</p>
<p><code>&amp;environment</code>
<span id="index-_0026environment"></span>
is followed by a single variable that is bound
to an <i>environment</i> representing the <i>lexical environment</i> in which the
macro call is to be interpreted.
This <i>environment</i> 
should be used with
<code>macro-function</code>,
<code>get-setf-expansion</code>,
<code>compiler-macro-function</code>, 
and
<code>macroexpand</code> 
(for example) in computing the expansion of the macro, to ensure that any
<i>lexical bindings</i> or definitions established in the 
<i>compilation environment</i> are taken into account.
<code>&amp;environment</code> can only appear at the top level of a
<i>macro lambda list</i>, and can only
appear once, but can appear anywhere in that list;
the <code>&amp;environment</code> <i>parameter</i> is <i>bound</i> along with <code>&amp;whole</code>
before any other <i>variables</i> in the <i>lambda list</i>, regardless of where
<code>&amp;environment</code> appears in the <i>lambda list</i>.
The <i>object</i> that is bound to the
<i>environment parameter</i> has <i>dynamic extent</i>.
</p>
<p>Destructuring allows a <i>macro lambda list</i> to express
the structure of a macro call syntax.
If no <i>lambda list keywords</i> appear,
then the <i>macro lambda list</i> is a <i>tree</i>
containing parameter names at the leaves.
The pattern and the <i>macro form</i> must have compatible <i>tree structure</i>; 
that is, their <i>tree structure</i> must be equivalent,
or it must differ only in that some <i>leaves</i> of the pattern
match <i>non-atomic</i> <i>objects</i> of the <i>macro form</i>.
For information about error detection in this <i>situation</i>,
see <a href="#DestructuringMismatch">Section 3.5.1.7 (Destructuring Mismatch)</a>.
</p>
<p>A destructuring <i>lambda list</i>
(whether at top level or embedded) 
can
be dotted, ending
in a parameter name.  This situation is treated exactly as if the
parameter name that ends the <i>list</i> had appeared preceded by <code>&amp;rest</code>.
</p>
<p>It is permissible for a <i>macro</i> <i>form</i> (or a <i>subexpression</i> of a
<i>macro</i> <i>form</i>)
to be a <i>dotted list</i> 
only  when <code>(... &amp;rest var)</code> or <code>(... . var)</code> is used to match
it. It is the responsibility of the <i>macro</i> to recognize and deal
with such situations.
</p>

<span id="Destructuring-by-Lambda-Lists"></span><h4 class="subsubsection">3.4.4.1 Destructuring by Lambda Lists</h4>
<span id="DestructuringByLambdaLists"></span>
<p>Anywhere in a <i>macro lambda list</i> where a parameter
name can appear, and where <i>ordinary lambda list</i> syntax
(as described in <a href="#Ordinary-Lambda-Lists">Section 3.4.1 (Ordinary Lambda Lists)</a>) does not 
otherwise allow a <i>list</i>, a <i>destructuring lambda list</i> 
can appear in place
of the parameter name.  When this is done, then the argument 
that would match the parameter is treated as a (possibly dotted) <i>list</i>,
to be used as an argument list for satisfying the
parameters in the embedded <i>lambda list</i>.
This is known as destructuring.
</p>

<p>Destructuring is the process of decomposing a compound <i>object</i> into
its component parts, using an abbreviated, declarative syntax, rather
than writing it out by hand using the primitive component-accessing
functions.  Each component part is bound to a variable.
</p>


<p>A destructuring operation requires an <i>object</i> to be decomposed, 
a pattern that specifies what components are to be extracted, and the names
of the variables whose values are to be the components.
</p>
<span id="g_t3_002e4_002e4_002e1_002e1-Data_002ddirected-Destructuring-by-Lambda-Lists"></span><h4 class="unnumberedsubsubsec">3.4.4.1.1 Data-directed Destructuring by Lambda Lists</h4>


<p>In data-directed destructuring,
the pattern is a sample <i>object</i> of the <i>type</i> to be decomposed.
Wherever a component is to be extracted, 
a <i>symbol</i> appears in the pattern; 
this <i>symbol</i> is the name of the variable whose value will be that component.
</p>
<span id="g_t3_002e4_002e4_002e1_002e1_002e1-Examples-of-Data_002ddirected-Destructuring-by-Lambda-Lists"></span><h4 class="unnumberedsubsubsec">3.4.4.1.1.1 Examples of Data-directed Destructuring by Lambda Lists</h4>


<p>An example pattern is
</p>
<p><code>(a b c)</code>
</p>
<p>which destructures a list of three elements.  The variable <code>a</code> is assigned
to the first element, <code>b</code> to the second, etc.  A more complex example
is
</p>
<p><code>((first . rest) . more)</code>
</p>
<p>The important features of data-directed destructuring are its syntactic
simplicity and the ability to extend it to lambda-list-directed destructuring.
</p>


<span id="g_t3_002e4_002e4_002e1_002e2-Lambda_002dlist_002ddirected-Destructuring-by-Lambda-Lists"></span><h4 class="unnumberedsubsubsec">3.4.4.1.2 Lambda-list-directed Destructuring by Lambda Lists</h4>


<p>An extension of data-directed destructuring of <i>trees</i> is
lambda-list-directed destructuring.  This derives from the analogy
between the three-element destructuring pattern
</p>
<p><code>(first second third)</code>
</p>
<p>and the three-argument <i>lambda list</i>
</p>
<p><code>(first second third)</code>
</p>

<p>Lambda-list-directed destructuring is identical to data-directed destructuring
if no <i>lambda list keywords</i> appear in the pattern.  
Any list in the pattern (whether a sub-list or the whole pattern itself)
that contains a <i>lambda list keyword</i> is interpreted specially.
Elements of the list to the left of the first
<i>lambda list keyword</i> are treated as destructuring patterns, as usual, but the
remaining elements of the list are treated like a function&rsquo;s 
<i>lambda list</i>
except that where a variable would normally be required, an arbitrary
destructuring pattern is allowed.  Note that in case of ambiguity,
<i>lambda list</i> syntax is preferred over destructuring syntax.  Thus, after
<code>&amp;optional</code> a list of elements is a list of a destructuring pattern
and a default value form.
</p>
<p>The detailed behavior of each <i>lambda list keyword</i> in a 
lambda-list-directed destructuring
pattern is as follows:
</p>

<dl compact="compact">
<dt><code>&amp;optional</code></dt>
<dd>

<p>Each following element is a variable or a list of a destructuring
pattern, a default value form, and a supplied-p variable.  The default value and
the supplied-p variable can be omitted.  
If the list being destructured ends
early, so that it does not have an element to match against this destructuring
(sub)-pattern, the default form is evaluated and destructured instead.  The
supplied-p variable receives the value 
<code>nil</code>&nbsp;<!-- /@w -->if the default form is used, <code>t</code>&nbsp;<!-- /@w -->otherwise.
</p>
</dd>
<dt><code>&amp;rest</code>, <code>&amp;body</code></dt>
<dd>

<p>The next element is a destructuring pattern that matches the
rest of the list.  <code>&amp;body</code> is identical to <code>&amp;rest</code> but declares that what
is being matched is a list of forms that constitutes the body of <i>form</i>.
This next element must be the last unless a <i>lambda list keyword</i> follows it.
</p>
</dd>
<dt><code>&amp;aux</code></dt>
<dd> 

<p>The remaining elements are not destructuring patterns at all, but are
auxiliary variable bindings.  
</p>
</dd>
<dt><code>&amp;whole</code></dt>
<dd>

<p>The next element is a destructuring pattern that matches the entire
form in a macro, or the entire <i>subexpression</i> at inner levels.
</p>
</dd>
<dt><code>&amp;key</code></dt>
<dd>

<p>Each following element is one of
</p>
<dl compact="compact">
<dd>
<p>a <i>variable</i>,
</p>
</dd>
<dt>or</dt>
<dd>
<p>a list of a variable,
an optional initialization form,
and an optional supplied-p variable.
</p>
</dd>
<dt>or</dt>
<dd>
<p>a list of a list of a keyword and a destructuring pattern,
an optional initialization form,
and an optional supplied-p variable.
</p></dd>
</dl>

<p>The rest of the list being destructured
is taken to be alternating keywords and values and is taken apart appropriately.
</p>
</dd>
<dt><code>&amp;allow-other-keys</code></dt>
<dd>

<p>Stands by itself.
</p></dd>
</dl>





<hr>
<span id="Destructuring-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Boa-Lambda-Lists" accesskey="n" rel="next">Boa Lambda Lists</a>, Previous: <a href="#Macro-Lambda-Lists" accesskey="p" rel="prev">Macro Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Destructuring-Lambda-Lists-1"></span><h4 class="subsection">3.4.5 Destructuring Lambda Lists</h4>

<p>A <span id="index-destructuring-lambda-list"></span>
<em>destructuring lambda list</em> is used by <code>destructuring-bind</code>.
</p>
<p><i>Destructuring lambda lists</i> are closely related to 
<i>macro lambda lists</i>; see <a href="#Macro-Lambda-Lists">Section 3.4.4 (Macro Lambda Lists)</a>.
A <i>destructuring lambda list</i> can contain all of the
<i>lambda list keywords</i> listed for <i>macro lambda lists</i>
except for <code>&amp;environment</code>, and supports destructuring in the
same way.  Inner <i>lambda lists</i> nested within a <i>macro lambda list</i>
have the syntax of <i>destructuring lambda lists</i>.
</p>
<p>A <i>destructuring lambda list</i> has the following syntax:
</p>
<dl compact="compact">
<dt><var>reqvars</var>::=</dt>
<dd><p><tt>{</tt>var | <tt>↓</tt>lambda-list<tt>}</tt>*
</p></dd>
</dl>

<dl compact="compact">
<dt><var>optvars</var>::=</dt>
<dd><p>[<tt>&amp;optional</tt> <tt>{</tt>var | (<tt>{</tt>var
<tt>↓</tt>lambda-list<tt>}</tt> [init-form [supplied-p-parameter]])<tt>}</tt>*]
</p></dd>
</dl>

<dl compact="compact">
<dt><var>restvars</var>::=</dt>
<dd><p>[<tt>{</tt><tt>&amp;rest</tt> | <tt>&amp;body</tt><tt>}</tt> <tt>{</tt>var | <tt>↓</tt>lambda-list<tt>}</tt>]
</p></dd>
</dl>

<dl compact="compact">
<dt><var>keyvars</var>::=</dt>
<dd><p>[<tt>&amp;key</tt> <tt>{</tt>var | (<tt>{</tt>var | (keyword-name
<tt>{</tt>var | <tt>↓</tt>lambda-list<tt>}</tt>)<tt>}</tt> [init-form [supplied-p-parameter]])<tt>}</tt>*
[<tt>&amp;allow-other-keys</tt>]]
</p></dd>
</dl>

<dl compact="compact">
<dt><var>auxvars</var>::=</dt>
<dd><p>[<tt>&amp;aux</tt> <tt>{</tt>var | (var [init-form])<tt>}</tt>*]
</p></dd>
</dl>
<dl compact="compact">
<dt><var>envvar</var>::=</dt>
<dd><p><tt>[</tt><tt>&amp;environment</tt> <var>var</var><tt>]</tt>
</p></dd>
</dl>
<dl compact="compact">
<dt><var>wholevar</var>::=</dt>
<dd><p><tt>[</tt><tt>&amp;whole</tt> <var>var</var><tt>]</tt>
</p></dd>
</dl>
<dl compact="compact">
<dt><var>lambda-list</var>::=</dt>
<dd><p><tt>(</tt><tt>↓</tt>wholevar <tt>↓</tt>reqvars <tt>↓</tt>optvars <tt>↓</tt>restvar <tt>↓</tt>keyvars <tt>↓</tt>auxvars<tt>)</tt> |<br> <tt>(</tt><tt>↓</tt>wholevar <tt>↓</tt>reqvars <tt>↓</tt>optvars <code>.</code> <var>var</var><tt>)</tt>
</p></dd>
</dl>


<hr>
<span id="Boa-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Defsetf-Lambda-Lists" accesskey="n" rel="next">Defsetf Lambda Lists</a>, Previous: <a href="#Destructuring-Lambda-Lists" accesskey="p" rel="prev">Destructuring Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Boa-Lambda-Lists-1"></span><h4 class="subsection">3.4.6 Boa Lambda Lists</h4>

<p>A <span id="index-boa-lambda-list"></span>
<em>boa lambda list</em> is a <i>lambda list</i> that is syntactically 
like an <i>ordinary lambda list</i>, but that is processed in
&ldquo;<b>b</b>y <b>o</b>rder of <b>a</b>rgument&rdquo; style.
</p>
<p>A <i>boa lambda list</i> is used only in a <code>defstruct</code> <i>form</i>,
when explicitly specifying the <i>lambda list</i> 
of a constructor <i>function</i> (sometimes called a &ldquo;boa constructor&rdquo;).
</p>
<p>The <code>&amp;optional</code>, <code>&amp;rest</code>, <code>&amp;aux</code>,
<code>&amp;key</code>, and <code>&amp;allow-other-keys</code>
<i>lambda list keywords</i> are recognized in a <i>boa lambda list</i>.
The way these <i>lambda list keywords</i> differ from their
use in an <i>ordinary lambda list</i> follows.
</p>
<p>Consider this example, which describes how <code>destruct</code> processes
its <tt>:constructor</tt> option.
</p>
<div class="lisp">
<pre class="lisp"> (:constructor create-foo
         (a &amp;optional b (c 'sea) &amp;rest d &amp;aux e (f 'eff)))
</pre></div>


<p>This defines <code>create-foo</code> to be a constructor of one or more arguments.
The first argument is used to initialize the <code>a</code> slot.  The second
argument is used to initialize the <code>b</code> slot.  If there isn&rsquo;t any
second argument, then the default value given in the body of the
<code>defstruct</code> (if given) is used instead.  
The third argument is used to
initialize the <code>c</code> slot.  If there isn&rsquo;t any third argument, then the
symbol <code>sea</code> is used instead.  Any arguments following the third
argument are collected into a <i>list</i> 
and used to initialize the <code>d</code>
slot.  If there are three or fewer arguments, then <code>nil</code>&nbsp;<!-- /@w -->is placed in
the <code>d</code> slot.  The <code>e</code> slot is not initialized; 
its initial value is <i>implementation-defined</i>.
Finally, the <code>f</code> slot is initialized to contain the symbol <code>eff</code>.
<code>&amp;key</code> and <code>&amp;allow-other-keys</code> arguments default
in a manner similar to that of <code>&amp;optional</code> arguments: if no default
is supplied in the <i>lambda list</i> then the default value 
given in the body of the <code>defstruct</code> (if given) is used instead.
For example:
</p>
<div class="lisp">
<pre class="lisp"> (defstruct (foo (:constructor CREATE-FOO (a &amp;optional b (c 'sea)
                                             &amp;key (d 2)
                                             &amp;aux e (f 'eff))))
   (a 1) (b 2) (c 3) (d 4) (e 5) (f 6))
 
 (create-foo 10) <span class="roman">→</span> #S(FOO A 10 B 2 C SEA D 2 E <i>implemention-dependent</i> F EFF)
 (create-foo 10 'bee 'see :d 'dee) 
<span class="roman">→</span> #S(FOO A 10 B BEE C SEE D DEE E <i>implemention-dependent</i> F EFF)
</pre></div>


<p>If keyword arguments of the form 
<code>((<i>key</i> <i>var</i>) <tt>[</tt><i>default</i> <tt>[</tt><i>svar</i><tt>]</tt><tt>]</tt>)</code>
are specified, the <i>slot</i> <i>name</i> is matched with <i>var</i> 
(not <i>key</i>).
</p>
<p>The actions taken in the <code>b</code> and <code>e</code> cases were carefully
chosen to allow the user to specify all possible behaviors. 
The <code>&amp;aux</code> variables can be used to completely override the default
initializations given in the body.
</p>
<p>If no default value is supplied for an <i>aux variable</i> variable,
the consequences are undefined if an attempt is later made to read
the corresponding <i>slot</i>&rsquo;s value before a value is explicitly assigned.
If such a <i>slot</i> has a <tt>:type</tt> option specified,
this suppressed initialization does not imply a type mismatch situation;
the declared type is only required to apply when the <i>slot</i> is finally assigned.
</p>
<p>With this definition, the following can be written:
</p>
<div class="lisp">
<pre class="lisp"> (create-foo 1 2)
</pre></div>

<p>instead of
</p>
<div class="lisp">
<pre class="lisp"> (make-foo :a 1 :b 2)
</pre></div>

<p>and <code>create-foo</code> provides defaulting different
from that of <code>make-foo</code>.
</p>
<p>Additional arguments that do not correspond to slot names but
are merely present to supply values used in subsequent initialization 
computations are allowed.
For example, in the definition
</p>
<div class="lisp">
<pre class="lisp"> (defstruct (frob (:constructor create-frob
                  (a &amp;key (b 3 have-b) (c-token 'c) 
                          (c (list c-token (if have-b 7 2))))))
         a b c)
</pre></div>


<p>the <code>c-token</code> argument is used merely to supply a value used in the 
initialization of the <code>c</code> slot. The <i>supplied-p parameters</i> 
associated with <i>optional parameters</i> and <i>keyword parameters</i>
might also be used this way.
</p>


<hr>
<span id="Defsetf-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Deftype-Lambda-Lists" accesskey="n" rel="next">Deftype Lambda Lists</a>, Previous: <a href="#Boa-Lambda-Lists" accesskey="p" rel="prev">Boa Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Defsetf-Lambda-Lists-1"></span><h4 class="subsection">3.4.7 Defsetf Lambda Lists</h4>

<p>A <span id="index-defsetf-lambda-list"></span>
<em>defsetf lambda list</em> is used by <code>defsetf</code>.
</p>
<p>A <i>defsetf lambda list</i> has the following syntax:
</p>

<dl compact="compact">
<dt><var>lambda-list</var>::=</dt>
<dd><p><tt>(</tt><tt>{</tt>var<tt>}</tt>*<br> <tt>[</tt><tt>&amp;optional</tt> <tt>{</tt>var <span class="roman">|</span> (var [init-form [supplied-p-parameter]])<tt>}</tt>*<tt>]</tt><br> <tt>[</tt><tt>&amp;rest</tt> <var>var</var><tt>]</tt><br> <code>[</code><tt>&amp;key</tt>&nbsp;<tt>{</tt>var&nbsp;(<tt>{</tt>var&nbsp;<span class="roman">|</span>&nbsp;<span class="nolinebreak">(keyword-name</span>&nbsp;var)<tt>}</tt>&nbsp;<span class="nolinebreak">[init-form</span>&nbsp;<span class="nolinebreak">[supplied-p-parameter]])</span><tt>}</tt>*<!-- /@w -->  <tt>[</tt><tt><span class="nolinebreak">&amp;allow-other-keys</span></tt><tt>]</tt><code>]</code><!-- /@w --><br> <tt>[</tt><tt>&amp;environment</tt> <var>var</var><tt>]</tt>
</p></dd>
</dl>

<p>A <i>defsetf lambda list</i> can contain the <i>lambda list keywords</i> shown
in the next figure.
</p>

<div class="float"><span id="fig3_002e19"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;allow-other-keys</code></td><td><code>&amp;key</code></td><td><code>&amp;rest</code></td></tr>
<tr><td><code>&amp;environment</code></td><td><code>&amp;optional</code></td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.19: </strong>Lambda List Keywords used by Defsetf Lambda Lists</p></div></div>

<p>A <i>defsetf lambda list</i> differs from an <i>ordinary lambda list</i> 
only in that it does not permit the use of <code>&amp;aux</code>, 
and that it permits use of <code>&amp;environment</code>, 
which introduces an <i>environment parameter</i>.
</p>

<hr>
<span id="Deftype-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Define_002dmodify_002dmacro-Lambda-Lists" accesskey="n" rel="next">Define-modify-macro Lambda Lists</a>, Previous: <a href="#Defsetf-Lambda-Lists" accesskey="p" rel="prev">Defsetf Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Deftype-Lambda-Lists-1"></span><h4 class="subsection">3.4.8 Deftype Lambda Lists</h4>

<p>A <span id="index-deftype-lambda-list"></span>
<em>deftype lambda list</em> is used by <code>deftype</code>.
</p>
<p>A <i>deftype lambda list</i> has the same syntax as a <i>macro lambda list</i>,
and can therefore contain the <i>lambda list keywords</i> as a <i>macro lambda list</i>.
</p>
<p>A <i>deftype lambda list</i> differs from a <i>macro lambda list</i> 
only in that if no <var>init-form</var> is supplied for an <i>optional parameter</i>
or <i>keyword parameter</i> in the <var>lambda-list</var>, the default <i>value</i> 
for that <i>parameter</i> is the <i>symbol</i> <tt>*</tt> (rather than <code>nil</code>).
</p>

<hr>
<span id="Define_002dmodify_002dmacro-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Define_002dmethod_002dcombination-Arguments-Lambda-Lists" accesskey="n" rel="next">Define-method-combination Arguments Lambda Lists</a>, Previous: <a href="#Deftype-Lambda-Lists" accesskey="p" rel="prev">Deftype Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Define_002dmodify_002dmacro-Lambda-Lists-1"></span><h4 class="subsection">3.4.9 Define-modify-macro Lambda Lists</h4>

<p>A <span id="index-define_002dmodify_002dmacro-lambda-list"></span>
<em>define-modify-macro lambda list</em> is used by 
<code>define-modify-macro</code>.
</p>
<p>A <i>define-modify-macro lambda list</i> can contain the 
<i>lambda list keywords</i> shown in the next figure.
</p>

<div class="float"><span id="fig3_002e20"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;optional</code></td><td><code>&amp;rest</code></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.20: </strong>Lambda List Keywords used by Define-modify-macro Lambda Lists</p></div></div>

<p><i>Define-modify-macro lambda lists</i> are similar to 
<i>ordinary lambda lists</i>, but do not support keyword arguments.
<code>define-modify-macro</code> has no need match keyword arguments, and
a <i>rest parameter</i> is sufficient.  <i>Aux variables</i> are also
not supported, since <code>define-modify-macro</code> has no body <i>forms</i>
which could refer to such <i>bindings</i>.  See the <i>macro</i> <a href="Data-and-Control-Flow.html#define_002dmodify_002dmacro">define-modify-macro</a>.
</p>

<hr>
<span id="Define_002dmethod_002dcombination-Arguments-Lambda-Lists"></span><div class="header">
<p>
Next: <a href="#Syntactic-Interaction-of-Documentation-Strings-and-Declarations" accesskey="n" rel="next">Syntactic Interaction of Documentation Strings and Declarations</a>, Previous: <a href="#Define_002dmodify_002dmacro-Lambda-Lists" accesskey="p" rel="prev">Define-modify-macro Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Define_002dmethod_002dcombination-Arguments-Lambda-Lists-1"></span><h4 class="subsection">3.4.10 Define-method-combination Arguments Lambda Lists</h4>

<p>A <span id="index-define_002dmethod_002dcombination-arguments-lambda-list"></span>
<em>define-method-combination arguments lambda list</em> is used by 
the <tt>:arguments</tt> option to <code>define-method-combination</code>.
</p>
<p>A <i>define-method-combination arguments lambda list</i> can contain the 
<i>lambda list keywords</i> shown in the next figure.
</p>

<div class="float"><span id="fig3_002e21"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td><code>&amp;allow-other-keys</code></td><td><code>&amp;key</code></td><td><code>&amp;rest</code></td></tr>
<tr><td><code>&amp;aux</code></td><td><code>&amp;optional</code></td><td><code>&amp;whole</code></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.21: </strong>Lambda List Keywords used by Define-method-combination arguments Lambda Lists</p></div></div>

<p><i>Define-method-combination arguments lambda lists</i> are similar to 
<i>ordinary lambda lists</i>, but also permit the use of <code>&amp;whole</code>.
</p>

<hr>
<span id="Syntactic-Interaction-of-Documentation-Strings-and-Declarations"></span><div class="header">
<p>
Previous: <a href="#Define_002dmethod_002dcombination-Arguments-Lambda-Lists" accesskey="p" rel="prev">Define-method-combination Arguments Lambda Lists</a>, Up: <a href="#Lambda-Lists" accesskey="u" rel="up">Lambda Lists</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Syntactic-Interaction-of-Documentation-Strings-and-Declarations-1"></span><h4 class="subsection">3.4.11 Syntactic Interaction of Documentation Strings and Declarations</h4>

<p>In a number of situations, a <i>documentation string</i> can appear amidst a
series of <tt>declare</tt> <i>expressions</i> prior to a series of <i>forms</i>.
</p>
<p>In that case, if a <i>string</i> S appears where a <i>documentation string</i> is
permissible and is not followed by 
either a <tt>declare</tt> <i>expression</i> 
or a <i>form</i>
then S is taken to be a <i>form</i>;
otherwise, S is taken as a <i>documentation string</i>.
The consequences are unspecified if more than one such <i>documentation string</i> 
is present.
</p>

<hr>
<span id="Error-Checking-in-Function-Calls"></span><div class="header">
<p>
Next: <a href="#Traversal-Rules-and-Side-Effects" accesskey="n" rel="next">Traversal Rules and Side Effects</a>, Previous: <a href="#Lambda-Lists" accesskey="p" rel="prev">Lambda Lists</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Error-Checking-in-Function-Calls-1"></span><h3 class="section">3.5 Error Checking in Function Calls</h3>


<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Argument-Mismatch-Detection" accesskey="1">Argument Mismatch Detection</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>
<hr>
<span id="Argument-Mismatch-Detection"></span><div class="header">
<p>
Up: <a href="#Error-Checking-in-Function-Calls" accesskey="u" rel="up">Error Checking in Function Calls</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Argument-Mismatch-Detection-1"></span><h4 class="subsection">3.5.1 Argument Mismatch Detection</h4>

<span id="Safe-and-Unsafe-Calls"></span><h4 class="subsubsection">3.5.1.1 Safe and Unsafe Calls</h4>
<span id="SafeAndUnsafeCalls"></span>
<p>A <i>call</i> is a <span id="index-safe-call"></span>
<em>safe call</em> if each of the following is
either <i>safe</i> <i>code</i> or <i>system code</i> (other than
<i>system code</i> that results from <i>macro expansion</i> of 
<i>programmer code</i>):
</p>
<ul>
<li> the <i>call</i>.
</li><li> the definition of the <i>function</i> being <i>called</i>.
</li><li> the point of <i>functional evaluation</i> 
</li></ul>


<p>The following special cases require some elaboration:
</p>

<ul>
<li> If the <i>function</i> being called is a <i>generic function</i>,
it is considered <i>safe</i> if all of the following are
<i>safe code</i> or <i>system code</i>:


<ul class="no-bullet">
<li>&ndash; its definition (if it was defined explicitly).
</li><li>&ndash; the <i>method</i> definitions for all <i>applicable</i> <i>methods</i>.
</li><li>&ndash; the definition of its <i>method combination</i>.
</li></ul>


</li><li> For the form <code>(coerce <var>x</var> 'function)</code>, 
where <var>x</var> is a <i>lambda expression</i>,
the value of the <i>optimize quality</i> <code>safety</code>
in the global environment at the time the <code>coerce</code>
is <i>executed</i> applies to the resulting <i>function</i>.



</li><li> For a call to the <i>function</i> <code>ensure-generic-function</code>, the value of the
<i>optimize quality</i> <code>safety</code> in the <i>environment</i>
<i>object</i> passed as the <tt>:environment</tt> <i>argument</i> applies 
to the resulting <i>generic function</i>.

</li><li> For a call to <code>compile</code> with a <i>lambda expression</i> as the
<i>argument</i>, the value of the <i>optimize quality</i> <code>safety</code>
in the <i>global environment</i> at the time <code>compile</code> is <i>called</i>
applies to the resulting <i>compiled function</i>.

</li><li> For a call to <code>compile</code> with only one argument, if the original definition
of the <i>function</i> was <i>safe</i>, then the resulting <i>compiled function</i>
must also be <i>safe</i>.

</li><li> A <i>call</i> to a <i>method</i> by <code>call-next-method</code> must be 
considered <i>safe</i> if each of the following is 
<i>safe code</i> or <i>system code</i>:


<ul class="no-bullet">
<li>&ndash; the definition of the <i>generic function</i> (if it was defined explicitly).
</li><li>&ndash; the <i>method</i> definitions for all <i>applicable</i> <i>methods</i>.
</li><li>&ndash; the definition of the <i>method combination</i>.
</li><li>&ndash; the point of entry into the body of the <i>method defining form</i>,
where the <i>binding</i> of <code>call-next-method</code> is established.
</li><li>&ndash; the point of <i>functional evaluation</i> of the name <code>call-next-method</code>.
</li></ul>

</li></ul>


<p>An <span id="index-unsafe-call"></span>
<em>unsafe call</em> is a <i>call</i> that is not a <i>safe call</i>.
</p>
<p>The informal intent is that the <i>programmer</i> can rely on a <i>call</i>
to be <i>safe</i>, even when <i>system code</i> is involved, if all reasonable
steps have been taken to ensure that the <i>call</i> is <i>safe</i>.
For example, if a <i>programmer</i> calls <code>mapcar</code> from <i>safe</i>
<i>code</i> and supplies a <i>function</i> that was <i>compiled</i> 
as <i>safe</i>, the <i>implementation</i> is required to ensure that
<code>mapcar</code> makes a <i>safe call</i> as well.
</p>
<span id="g_t3_002e5_002e1_002e1_002e1-Error-Detection-Time-in-Safe-Calls"></span><h4 class="unnumberedsubsubsec">3.5.1.1.1 Error Detection Time in Safe Calls</h4>


<p>If an error is signaled in a <i>safe call</i>,
the exact point of the <i>signal</i> is <i>implementation-dependent</i>.
In particular, it might be signaled at compile time or at run time,
and if signaled at run time, 
it might be prior to, during, or after <i>executing</i> the <i>call</i>.
However, it is always prior to the execution of the body of the <i>function</i> 
being <i>called</i>.
</p>


<span id="Too-Few-Arguments"></span><h4 class="subsubsection">3.5.1.2 Too Few Arguments</h4>

<p>It is not permitted to supply too few <i>arguments</i> to a <i>function</i>.
Too few arguments means fewer <i>arguments</i> than the number of <i>required parameters</i> 
for the <i>function</i>.
</p>
<p>If this <i>situation</i> occurs in a <i>safe call</i>,
an error of <i>type</i> <code>program-error</code> must be signaled;
and in an <i>unsafe call</i> the <i>situation</i> has undefined consequences.
</p>

<span id="Too-Many-Arguments"></span><h4 class="subsubsection">3.5.1.3 Too Many Arguments</h4>

<p>It is not permitted to supply too many <i>arguments</i> to a <i>function</i>.
Too many arguments means more <i>arguments</i> than the number of <i>required parameters</i>
plus the number of <i>optional parameters</i>; however, if the <i>function</i> 
uses <code>&amp;rest</code> or <code>&amp;key</code>, it is not possible for it to receive too many arguments.
</p>
<p>If this <i>situation</i> occurs in a <i>safe call</i>,
an error of <i>type</i> <code>program-error</code> must be signaled;
and in an <i>unsafe call</i> the <i>situation</i> has undefined consequences.
</p>

<span id="Unrecognized-Keyword-Arguments"></span><h4 class="subsubsection">3.5.1.4 Unrecognized Keyword Arguments</h4>
<span id="UnrecognizedKeyArgs"></span>
<p>It is not permitted to supply a keyword argument to a <i>function</i>
using a name that is not recognized by that <i>function</i> 
unless keyword argument checking is suppressed as described
in <a href="#SuppressingKeyArgChecks">Section 3.4.1.4.1 (Suppressing Keyword Argument Checking)</a>.
</p>
<p>If this <i>situation</i> occurs in a <i>safe call</i>,
an error of <i>type</i> <code>program-error</code> must be signaled;
and in an <i>unsafe call</i> the <i>situation</i> has undefined consequences.
</p>

<span id="Invalid-Keyword-Arguments"></span><h4 class="subsubsection">3.5.1.5 Invalid Keyword Arguments</h4>
<span id="InvalidKeyArgs"></span>
<p>It is not permitted to supply a keyword argument to a <i>function</i>
using a name that is not a <i>symbol</i>.
</p>
<p>If this <i>situation</i> occurs in a <i>safe call</i>,
an error of <i>type</i> <code>program-error</code> must be signaled 
unless keyword argument checking is suppressed as described
in <a href="#SuppressingKeyArgChecks">Section 3.4.1.4.1 (Suppressing Keyword Argument Checking)</a>;
and in an <i>unsafe call</i> the <i>situation</i> has undefined consequences.
</p>

<span id="Odd-Number-of-Keyword-Arguments"></span><h4 class="subsubsection">3.5.1.6 Odd Number of Keyword Arguments</h4>
<span id="OddNumberOfKeyArgs"></span>

<p>An odd number of <i>arguments</i> must not be supplied for the <i>keyword parameters</i>.
</p>
<p>If this <i>situation</i> occurs in a <i>safe call</i>,
an error of <i>type</i> <code>program-error</code> must be signaled
unless keyword argument checking is suppressed as described
in <a href="#SuppressingKeyArgChecks">Section 3.4.1.4.1 (Suppressing Keyword Argument Checking)</a>;
and in an <i>unsafe call</i> the <i>situation</i> has undefined consequences.
</p>


<span id="Destructuring-Mismatch"></span><h4 class="subsubsection">3.5.1.7 Destructuring Mismatch</h4>
<span id="DestructuringMismatch"></span>

<p>When matching a <i>destructuring lambda list</i> against a <i>form</i>,
the pattern and the <i>form</i> must have compatible <i>tree structure</i>,
as described in <a href="#Macro-Lambda-Lists">Section 3.4.4 (Macro Lambda Lists)</a>.
</p>
<p>Otherwise, in a <i>safe call</i>,
an error of <i>type</i> <code>program-error</code> must be signaled;
and in an <i>unsafe call</i> the <i>situation</i> has undefined consequences.
</p>


<span id="Errors-When-Calling-a-Next-Method"></span><h4 class="subsubsection">3.5.1.8 Errors When Calling a Next Method</h4>

<p>If <code>call-next-method</code> is called with <i>arguments</i>, the ordered
set of <i>applicable</i> <i>methods</i> for the changed set of <i>arguments</i>
for <code>call-next-method</code> must be the same as the ordered set of 
<i>applicable</i> <i>methods</i> for the original <i>arguments</i> to the
<i>generic function</i>, or else an error should be signaled.
</p>
<p>The comparison between the set of methods applicable to the
new arguments and the set applicable to the original arguments is
insensitive to order differences among methods with the same
specializers.
</p>
<p>If <code>call-next-method</code> is called with <i>arguments</i> that specify
a different ordered set of <i>applicable</i> methods and there is no 
<i>next method</i> available, the test for different methods and the 
associated error signaling (when present) takes precedence over calling
<code>no-next-method</code>.
</p>



<hr>
<span id="Traversal-Rules-and-Side-Effects"></span><div class="header">
<p>
Next: <a href="#Destructive-Operations" accesskey="n" rel="next">Destructive Operations</a>, Previous: <a href="#Error-Checking-in-Function-Calls" accesskey="p" rel="prev">Error Checking in Function Calls</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Traversal-Rules-and-Side-Effects-1"></span><h3 class="section">3.6 Traversal Rules and Side Effects</h3>


<p>The consequences are undefined 
when <i>code</i> executed during an <i>object-traversing</i> operation
destructively modifies the <i>object</i> in a way that might affect the
ongoing traversal operation.
In particular, the following rules apply.
</p>
<dl compact="compact">
<dt><b>List traversal</b></dt>
<dd>

<p>For <i>list</i> traversal operations, the <i>cdr</i> chain of the
<i>list</i> is not allowed to be destructively modified.
</p>
</dd>
<dt><b>Array traversal</b></dt>
<dd>

<p>For <i>array</i> traversal operations, the <i>array</i> is not allowed 
to be adjusted and its <i>fill pointer</i>, if any, is not allowed to 
be changed.
</p>
</dd>
<dt><b>Hash-table traversal</b></dt>
<dd>

<p>For <i>hash table</i> traversal operations, new elements may not be added
or deleted except that the element corresponding to the current hash key 
may be changed or removed.
</p>
</dd>
<dt><b>Package traversal</b></dt>
<dd>

<p>For <i>package</i> traversal operations (<i>e.g.</i>, <code>do-symbols</code>),
new <i>symbols</i> may not be <i>interned</i> in or <i>uninterned</i> 
from the <i>package</i> being traversed 
or any <i>package</i> that it uses except that the 
current <i>symbol</i> may be <i>uninterned</i> from the <i>package</i> 
being traversed.
</p></dd>
</dl>



<hr>
<span id="Destructive-Operations"></span><div class="header">
<p>
Next: <a href="#lambda-_0028Symbol_0029" accesskey="n" rel="next">lambda (Symbol)</a>, Previous: <a href="#Traversal-Rules-and-Side-Effects" accesskey="p" rel="prev">Traversal Rules and Side Effects</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Destructive-Operations-1"></span><h3 class="section">3.7 Destructive Operations</h3>

<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top">&bull; <a href="#Modification-of-Literal-Objects" accesskey="1">Modification of Literal Objects</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top">&bull; <a href="#Transfer-of-Control-during-a-Destructive-Operation" accesskey="2">Transfer of Control during a Destructive Operation</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>
<hr>
<span id="Modification-of-Literal-Objects"></span><div class="header">
<p>
Next: <a href="#Transfer-of-Control-during-a-Destructive-Operation" accesskey="n" rel="next">Transfer of Control during a Destructive Operation</a>, Up: <a href="#Destructive-Operations" accesskey="u" rel="up">Destructive Operations</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Modification-of-Literal-Objects-1"></span><h4 class="subsection">3.7.1 Modification of Literal Objects</h4>

<p>The consequences are undefined if <i>literal</i> <i>objects</i> 
are destructively modified.  For this purpose, the following operations 
are considered <i>destructive</i>:
</p>

<dl compact="compact">
<dt><code>random-state</code></dt>
<dd>

<p>Using it as an <i>argument</i> to the <i>function</i> <code>random</code>.
</p>
</dd>
<dt><code>cons</code></dt>
<dd>

<p>Changing the <i>car</i><sub>1</sub>
or performing a <i>destructive</i> operation on an <i>object</i> which is either
the <i>car</i><sub>2</sub>
</p>
</dd>
<dt><code>array</code></dt>
<dd>

<p>Storing a new value into some element of the <i>array</i>,
or performing a <i>destructive</i> operation 
on an <i>object</i> that is already such an <i>element</i>.
</p>
<p>Changing the <i>fill pointer</i>, <i>dimensions</i>, or displacement of
the <i>array</i> (regardless of whether the <i>array</i> is <i>actually adjustable</i>).
</p>
<p>Performing a <i>destructive</i> operation on another <i>array</i> 
that is displaced to the <i>array</i> or that otherwise shares its contents
with the <i>array</i>.
</p>
</dd>
<dt><code>hash-table</code></dt>
<dd>

<p>Performing a <i>destructive</i> operation on any <i>key</i>.
</p>
<p>Storing a new <i>value</i><sub>4</sub>
or performing a <i>destructive</i> operation 
on any <i>object</i> that is such a <i>value</i>.
</p>
<p>Adding or removing entries from the <i>hash table</i>.
</p>
</dd>
<dt><code>structure-object</code></dt>
<dd>

<p>Storing a new value into any slot,
or performing a <i>destructive</i> operation on an <i>object</i> 
that is the value of some slot.
</p>
</dd>
<dt><code>standard-object</code></dt>
<dd>

<p>Storing a new value into any slot,
or performing a <i>destructive</i> operation on an <i>object</i> 
that is the value of some slot.
</p>
<p>Changing the class of the <i>object</i> (<i>e.g.</i>, using the <i>function</i> <code>change-class</code>).
</p>
</dd>
<dt><code>readtable</code></dt>
<dd>

<p>Altering the <i>readtable case</i>.
</p>
<p>Altering the syntax type of any character in this readtable.
</p>
<p>Altering the <i>reader macro function</i> associated with any <i>character</i>
in the <i>readtable</i>, or altering the <i>reader macro functions</i>
associated with <i>characters</i> defined as <i>dispatching macro characters</i>
in the <i>readtable</i>.
</p>
</dd>
<dt><code>stream</code></dt>
<dd>

<p>Performing I/O operations on the <i>stream</i>,
or <i>closing</i> the <i>stream</i>.
</p>
</dd>
<dt>All other standardized types</dt>
<dd>

<p>[This category includes, for example, <code>character</code>,
<code>condition</code>,
<code>function</code>,
<code>method-combination</code>,
<code>method</code>,
<code>number</code>,
<code>package</code>,
<code>pathname</code>,
<code>restart</code>,
and <code>symbol</code>.]
</p>
<p>There are no <i>standardized</i> <i>destructive</i> operations
defined on <i>objects</i> of these <i>types</i>.
</p></dd>
</dl>



<hr>
<span id="Transfer-of-Control-during-a-Destructive-Operation"></span><div class="header">
<p>
Previous: <a href="#Modification-of-Literal-Objects" accesskey="p" rel="prev">Modification of Literal Objects</a>, Up: <a href="#Destructive-Operations" accesskey="u" rel="up">Destructive Operations</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<span id="Transfer-of-Control-during-a-Destructive-Operation-1"></span><h4 class="subsection">3.7.2 Transfer of Control during a Destructive Operation</h4>

<p>Should a transfer of control out of a <i>destructive</i> operation occur
(<i>e.g.</i>, due to an error) the state of the <var>object</var> being modified is
<i>implementation-dependent</i>.
</p>
<span id="Examples-of-Transfer-of-Control-during-a-Destructive-Operation"></span><h4 class="subsubsection">3.7.2.1 Examples of Transfer of Control during a Destructive Operation</h4>

<p>The following examples illustrate some of the many ways in which the
<i>implementation-dependent</i> nature of the modification can manifest
itself.
</p>
<div class="lisp">
<pre class="lisp"> (let ((a (list 2 1 4 3 7 6 'five)))
   (ignore-errors (sort a #'&lt;))
   a)
<span class="roman">→</span> (1 2 3 4 6 7 FIVE)
or<span class="roman">→</span> (2 1 4 3 7 6 FIVE)
or<span class="roman">→</span> (2)

 (prog foo ((a (list 1 2 3 4 5 6 7 8 9 10)))
   (sort a #'(lambda (x y) (if (zerop (random 5)) (return-from foo a) (&gt; x y)))))
<span class="roman">→</span> (1 2 3 4 5 6 7 8 9 10)
or<span class="roman">→</span> (3 4 5 6 2 7 8 9 10 1)
or<span class="roman">→</span> (1 2 4 3)
</pre></div>





<hr>
<span id="lambda-_0028Symbol_0029"></span><div class="header">
<p>
Next: <a href="#lambda-_0028Macro_0029" accesskey="n" rel="next">lambda (Macro)</a>, Previous: <a href="#Destructive-Operations" accesskey="p" rel="prev">Destructive Operations</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">lambda (Symbol)</h4>
<span id="lambda-_0028Symbol_0029-1"></span><h3 class="heading">lambda (Symbol)</h3>
<span id="index-lambda-4"></span>
<span id="index-lambda"></span>



<span id="Syntax_003a"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-lambda-2">Special Form: <strong>lambda</strong> <em>lambda-list 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments_003a"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>lambda-list</var>&mdash;an <i>ordinary lambda list</i>.
</p>
<p><var>declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.
</p>
<p><var>documentation</var>&mdash;a <i>string</i>; not evaluated.
</p>
<p><var>form</var>&mdash;a <i>form</i>.
</p>
<span id="Description_003a"></span><h4 class="subsubheading">Description:</h4>

<p>A <i>lambda expression</i> is a <i>list</i> that can be used in place of a
<i>function name</i> in certain contexts to denote a <i>function</i> by 
directly describing its behavior rather than indirectly by referring to the 
name of an <i>established</i> <i>function</i>.
</p>
<p><var>Documentation</var> is attached to the denoted <var>function</var> (if any
is actually created) as a <i>documentation string</i>.
</p>
<span id="See-Also_003a"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="Data-and-Control-Flow.html#function-_0028Special-Operator_0029">function (Special Operator)</a>,
<a href="Environment.html#documentation">documentation</a>,
<a href="#Lambda-Expressions">Section 3.1.3 (Lambda Expressions)</a>,
<a href="#LambdaForms">Section 3.1.2.1.2.4 (Lambda Forms)</a>,
<a href="#Syntactic-Interaction-of-Documentation-Strings-and-Declarations">Section 3.4.11 (Syntactic Interaction of Documentation Strings and Declarations)</a>
</p>
<span id="Notes_003a"></span><h4 class="subsubheading">Notes:</h4>

<p>The <i>lambda form</i>
</p>
<div class="lisp">
<pre class="lisp"> ((lambda <var>lambda-list</var> . <var>body</var>) . <var>arguments</var>)
</pre></div>


<p>is semantically equivalent to the <i>function form</i>
</p>
<div class="lisp">
<pre class="lisp"> (funcall #'(lambda <var>lambda-list</var> . <var>body</var>) . <var>arguments</var>)
</pre></div>




<hr>
<span id="lambda-_0028Macro_0029"></span><div class="header">
<p>
Next: <a href="#compile" accesskey="n" rel="next">compile</a>, Previous: <a href="#lambda-_0028Symbol_0029" accesskey="p" rel="prev">lambda (Symbol)</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">lambda (Macro)</h4>
<span id="lambda-_0028Macro_0029-1"></span><h3 class="heading">lambda (Macro)</h3>
<span id="index-lambda-5"></span>
<span id="index-lambda-1"></span>


<span id="Syntax_003a-1"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-lambda-3">Macro: <strong>lambda</strong> <em>lambda-list 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>* <span class="roman">→</span> <var>function</var></em></dt>
</dl>

<span id="Arguments-and-Values_003a"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>lambda-list</var>&mdash;an <i>ordinary lambda list</i>.
</p>
<p><var>declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.
</p>
<p><var>documentation</var>&mdash;a <i>string</i>; not evaluated.
</p>
<p><var>form</var>&mdash;a <i>form</i>.
</p>
<p><var>function</var>&mdash;a <i>function</i>.
</p>
<span id="Description_003a-1"></span><h4 class="subsubheading">Description:</h4>

<p>Provides a shorthand notation for a <code>function</code> <i>special form</i>
involving a <i>lambda expression</i> such that:
</p>
<div class="lisp">
<pre class="lisp">    (lambda <var>lambda-list</var> 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>*)
 ≡ (function (lambda <var>lambda-list</var> 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>*))
 ≡ #'(lambda <var>lambda-list</var> 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>*)
</pre></div>


<span id="Examples_003a"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (funcall (lambda (x) (+ x 3)) 4) <span class="roman">→</span> 7
</pre></div>


<span id="See-Also_003a-1"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#lambda-_0028Symbol_0029">lambda (Symbol)</a> (symbol)
</p>
<span id="Notes_003a-1"></span><h4 class="subsubheading">Notes:</h4>

<p>This macro could be implemented by:
</p>
<div class="lisp">
<pre class="lisp">(defmacro lambda (&amp;whole form &amp;rest bvl-decls-and-body)
  (declare (ignore bvl-decls-and-body))
  `#',form)
</pre></div>



<hr>
<span id="compile"></span><div class="header">
<p>
Next: <a href="#eval" accesskey="n" rel="next">eval</a>, Previous: <a href="#lambda-_0028Macro_0029" accesskey="p" rel="prev">lambda (Macro)</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">compile</h4>
<span id="compile-_0028Function_0029"></span><h3 class="heading">compile (Function)</h3>
<span id="index-compile-4"></span>
<span id="index-compile-1"></span>



<span id="Syntax_003a-2"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-compile-3">Function: <strong>compile</strong> <em>name <tt>&amp;optional</tt> definition <span class="roman">→</span> function, warnings-p, failure-p</em></dt>
</dl>

<span id="Arguments-and-Values_003a-1"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>name</var>&mdash;a <i>function name</i>, or <code>nil</code>.
</p>
<p><var>definition</var>&mdash;a <i>lambda expression</i> or a <i>function</i>.
The default is the function definition of <var>name</var> if it names a <i>function</i>,
or the <i>macro function</i> of <var>name</var> if it names a <i>macro</i>.
The consequences are undefined if no <var>definition</var> is supplied
when the <var>name</var> is <code>nil</code>.
</p>
<p><var>function</var>&mdash;the <var>function-name</var>,
or a <i>compiled function</i>.
</p>
<p><var>warnings-p</var>&mdash;a <i>generalized boolean</i>.
</p>
<p><var>failure-p</var>&mdash;a <i>generalized boolean</i>.
</p>
<span id="Description_003a-2"></span><h4 class="subsubheading">Description:</h4>

<p>Compiles an <i>interpreted function</i>.
</p>
<p><code>compile</code> produces a <i>compiled function</i> from <var>definition</var>.
If the <var>definition</var> is a <i>lambda expression</i>,
it is coerced to a <i>function</i>.  
If the <var>definition</var> is already a <i>compiled function</i>,
<code>compile</code> either produces that function itself (<i>i.e.</i>, is an identity operation)
or an equivalent function.
</p>

<p>If the <var>name</var> is <code>nil</code>,
the resulting <i>compiled function</i> is returned directly as the <i>primary value</i>.
If a <i>non-nil</i> <var>name</var> is given, 
then the resulting <i>compiled function</i> replaces 
the existing <i>function</i> definition of <var>name</var>
and the <var>name</var> is returned as the <i>primary value</i>;
if <var>name</var> is a <i>symbol</i> that names a <i>macro</i>,
its <i>macro function</i> is updated
and the <var>name</var> is returned as the <i>primary value</i>.
</p>
<p><i>Literal objects</i> appearing in code processed by 
the <code>compile</code> function are neither copied nor <i>coalesced</i>.
The code resulting from the execution of <code>compile</code> 
references <i>objects</i> that are <code>eql</code> to the corresponding
<i>objects</i> in the source code.  
</p>
<p><code>compile</code> is permitted, but not required, to <i>establish</i>
a <i>handler</i> for <i>conditions</i> of <i>type</i> <code>error</code>.
For example, the <i>handler</i> might issue a warning and 
restart compilation from some <i>implementation-dependent</i> point 
in order to let the compilation proceed without manual intervention.
</p>
<p>The <i>secondary value</i>, <var>warnings-p</var>, is <i>false</i>
if no <i>conditions</i> of <i>type</i> <code>error</code> or <code>warning</code>
were detected by the compiler, and <i>true</i> otherwise.
</p>
<p>The <i>tertiary value</i>, <var>failure-p</var>, is <i>false</i>
if no <i>conditions</i> of <i>type</i> <code>error</code> or <code>warning</code>
(other than <code>style-warning</code>)
were detected by the compiler, and <i>true</i> otherwise.
</p>
<span id="Examples_003a-1"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun foo () &quot;bar&quot;) <span class="roman">→</span> FOO
 (compiled-function-p #'foo) <span class="roman">→</span> <i>implementation-dependent</i>
 (compile 'foo) <span class="roman">→</span> FOO 
 (compiled-function-p #'foo) <span class="roman">→</span> <i>true</i>
 (setf (symbol-function 'foo)
       (compile nil '(lambda () &quot;replaced&quot;))) <span class="roman">→</span> #&lt;Compiled-Function&gt;
 (foo) <span class="roman">→</span> &quot;replaced&quot;
</pre></div>


<span id="Affected-By_003a"></span><h4 class="subsubheading">Affected By:</h4>

<p><code>*error-output*</code>,
<code>*macroexpand-hook*</code>.
</p>
<p>The presence of macro definitions and proclamations.
</p>
<span id="Exceptional-Situations_003a"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>The consequences are undefined if the <i>lexical environment</i> surrounding the
<i>function</i> to be compiled contains any <i>bindings</i> other than those for
<i>macros</i>, <i>symbol macros</i>, or <i>declarations</i>.
</p>

<p>For information about errors detected during the compilation process, 
see <a href="#Exceptional-Situations-in-the-Compiler">Section 3.2.5 (Exceptional Situations in the Compiler)</a>.
</p>
<span id="See-Also_003a-2"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="System-Construction.html#compile_002dfile">compile-file</a>
</p>

<hr>
<span id="eval"></span><div class="header">
<p>
Next: <a href="#eval_002dwhen" accesskey="n" rel="next">eval-when</a>, Previous: <a href="#compile" accesskey="p" rel="prev">compile</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">eval</h4>
<span id="eval-_0028Function_0029"></span><h3 class="heading">eval (Function)</h3>
<span id="index-eval-4"></span>
<span id="index-eval-1"></span>


<span id="Syntax_003a-3"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-eval-3">Function: <strong>eval</strong> <em>form <span class="roman">→</span> <tt>{</tt>result<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments-and-Values_003a-2"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>form</var>&mdash;a <i>form</i>.
</p>
<p><var>results</var>&mdash;the <i>values</i> <i>yielded</i> by the <i>evaluation</i> of <var>form</var>.
</p>
<span id="Description_003a-3"></span><h4 class="subsubheading">Description:</h4>

<p>Evaluates <var>form</var> in the current <i>dynamic environment</i>
and the <i>null lexical environment</i>.
</p>
<p><code>eval</code> is a user interface to the evaluator.
</p>
<p>The evaluator expands macro calls as if through the use of <code>macroexpand-1</code>.
</p>
<p>Constants appearing in code
processed by <code>eval</code> are
not copied nor coalesced. The code resulting from the execution of 
<code>eval</code>
references <i>objects</i> 
that are <code>eql</code> to the corresponding <i>objects</i> in
the source code.  
</p>
<span id="Examples_003a-2"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (setq form '(1+ a) a 999) <span class="roman">→</span> 999
 (eval form) <span class="roman">→</span> 1000
 (eval 'form) <span class="roman">→</span> (1+ A)
 (let ((a '(this would break if eval used local value))) (eval form))
<span class="roman">→</span> 1000
</pre></div>


<span id="See-Also_003a-3"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#macroexpand_002d1">macroexpand-1</a>,
<a href="#The-Evaluation-Model">Section 3.1.2 (The Evaluation Model)</a>
</p>
<span id="Notes_003a-2"></span><h4 class="subsubheading">Notes:</h4>

<p>To obtain the current dynamic value of a <i>symbol</i>, 
use of <code>symbol-value</code> is equivalent (and usually preferable) 
to use of <code>eval</code>.
</p>
<p>Note that an <code>eval</code> <i>form</i> involves two levels of <i>evaluation</i> 
for its <i>argument</i>.  First, <var>form</var> is <i>evaluated</i> by the
normal argument evaluation mechanism as would occur with any <i>call</i>.
The <i>object</i> that results from this normal <i>argument</i> <i>evaluation</i> 
becomes the <i>value</i> of the <var>form</var> <i>parameter</i>, and is then
<i>evaluated</i> as part of the <code>eval</code> <i>form</i>.
For example:
</p>
<div class="lisp">
<pre class="lisp"> (eval (list 'cdr (car '((quote (a . b)) c)))) <span class="roman">→</span> b
</pre></div>

<p>The <i>argument</i> <i>form</i> <code>(list 'cdr (car '((quote (a . b)) c)))</code> is evaluated
in the usual way to produce the <i>argument</i> <code>(cdr (quote (a . b)))</code>; 
<code>eval</code> then evaluates its <i>argument</i>, <code>(cdr (quote (a . b)))</code>, to produce <code>b</code>.
Since a single <i>evaluation</i> already occurs for any <i>argument</i> <i>form</i>
in any <i>function form</i>,
<code>eval</code> is sometimes said to perform &ldquo;an extra level of evaluation.&rdquo;
</p>


<hr>
<span id="eval_002dwhen"></span><div class="header">
<p>
Next: <a href="#load_002dtime_002dvalue" accesskey="n" rel="next">load-time-value</a>, Previous: <a href="#eval" accesskey="p" rel="prev">eval</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">eval-when</h4>
<span id="eval_002dwhen-_0028Special-Operator_0029"></span><h3 class="heading">eval-when (Special Operator)</h3>
<span id="index-eval_002dwhen-3"></span>
<span id="index-eval_002dwhen-1"></span>
      

<span id="Syntax_003a-4"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-eval_002dwhen-2">Special Form: <strong>eval-when</strong> <em><tt>(</tt><tt>{</tt>situation<tt>}</tt>*<tt>)</tt> <tt>{</tt>form<tt>}</tt>* <span class="roman">→</span> <tt>{</tt>result<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments-and-Values_003a-3"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>situation</var>&mdash;One of the <i>symbols</i> 
<tt>:compile-toplevel</tt>
<span id="index-_003acompile_002dtoplevel"></span>
,
<tt>:load-toplevel</tt>
<span id="index-_003aload_002dtoplevel"></span>
,
<tt>:execute</tt>
<span id="index-_003aexecute"></span>
,
<tt>compile</tt>
<span id="index-compile-2"></span>
,
<tt>load</tt>
<span id="index-load"></span>
, or
<tt>eval</tt>
<span id="index-eval-2"></span>
.
</p>
<p>The use of <tt>eval</tt>, <tt>compile</tt>, and <tt>load</tt> is deprecated.
</p>
<p><var>forms</var>&mdash;an <i>implicit progn</i>.
</p>
<p><var>results</var>&mdash;the <i>values</i> of the <i>forms</i> if they are executed,
or <code>nil</code>&nbsp;<!-- /@w -->if they are not. 
</p>
<span id="Description_003a-4"></span><h4 class="subsubheading">Description:</h4>

<p>The body of an <code>eval-when</code> form is processed as an <i>implicit progn</i>, 
but only in the <var>situations</var> listed.  
</p>


<p>The use of the <var>situations</var> <tt>:compile-toplevel</tt> (or <code>compile</code>) and
<tt>:load-toplevel</tt> (or <code>load</code>) controls whether and when <i>evaluation</i>
occurs when <code>eval-when</code> appears as a <i>top level form</i> in
code processed by <code>compile-file</code>.  See <a href="#File-Compilation">Section 3.2.3 (File Compilation)</a>.
</p>
<p>The use of the <var>situation</var> <tt>:execute</tt> (or <code>eval</code>) controls whether
evaluation occurs for other <code>eval-when</code> <i>forms</i>; that is, 
those that are not <i>top level forms</i>, or those in code processed by
<code>eval</code> or <code>compile</code>.  If the <tt>:execute</tt> situation is
specified in such a <i>form</i>, then the body <var>forms</var> are processed as 
an <i>implicit progn</i>; otherwise, the <code>eval-when</code> <i>form</i>
returns <code>nil</code>.
</p>


<p><code>eval-when</code> 
normally appears as a <i>top level form</i>, but it is meaningful
for it to appear as a <i>non-top-level form</i>.
However, the compile-time side
effects described in <a href="#Compilation">Section 3.2 (Compilation)</a>
only take place when <code>eval-when</code> appears as a  
<i>top level form</i>.
</p>

<span id="Examples_003a-3"></span><h4 class="subsubheading">Examples:</h4>

<p>One example of the use of <code>eval-when</code> is that for the 
compiler to be able to read a file properly when it uses user-defined
<i>reader macros</i>, it is necessary to write
</p>
<div class="lisp">
<pre class="lisp"> (eval-when (:compile-toplevel :load-toplevel :execute)
   (set-macro-character #\$ #'(lambda (stream char)
                                (declare (ignore char))
                                (list 'dollar (read stream))))) <span class="roman">→</span> T
</pre></div>

<p>This causes the call to <code>set-macro-character</code> to be executed
in the compiler&rsquo;s execution environment, thereby modifying its
reader syntax table.
</p>
<div class="lisp">
<pre class="lisp">;;;     The EVAL-WHEN in this case is not at toplevel, so only the :EXECUTE
;;;     keyword is considered. At compile time, this has no effect.
;;;     At load time (if the LET is at toplevel), or at execution time
;;;     (if the LET is embedded in some other form which does not execute
;;;     until later) this sets (SYMBOL-FUNCTION 'FOO1) to a function which
;;;     returns 1.
 (let ((x 1))
   (eval-when (:execute :load-toplevel :compile-toplevel)
     (setf (symbol-function 'foo1) #'(lambda () x))))

;;;     If this expression occurs at the toplevel of a file to be compiled,
;;;     it has BOTH a compile time AND a load-time effect of setting
;;;     (SYMBOL-FUNCTION 'FOO2) to a function which returns 2.
 (eval-when (:execute :load-toplevel :compile-toplevel)
   (let ((x 2))
     (eval-when (:execute :load-toplevel :compile-toplevel)
       (setf (symbol-function 'foo2) #'(lambda () x)))))

;;;     If this expression occurs at the toplevel of a file to be compiled,
;;;     it has BOTH a compile time AND a load-time effect of setting the
;;;     function cell of FOO3 to a function which returns 3.
 (eval-when (:execute :load-toplevel :compile-toplevel)
   (setf (symbol-function 'foo3) #'(lambda () 3)))
 
;;; #4: This always does nothing. It simply returns NIL.
 (eval-when (:compile-toplevel)
   (eval-when (:compile-toplevel) 
     (print 'foo4)))

;;;     If this form occurs at toplevel of a file to be compiled, FOO5 is
;;;     printed at compile time. If this form occurs in a non-top-level
;;;     position, nothing is printed at compile time. Regardless of context,
;;;     nothing is ever printed at load time or execution time.
 (eval-when (:compile-toplevel) 
   (eval-when (:execute)
     (print 'foo5)))
 
;;;     If this form occurs at toplevel of a file to be compiled, FOO6 is
;;;     printed at compile time.  If this form occurs in a non-top-level
;;;     position, nothing is printed at compile time. Regardless of context,
;;;     nothing is ever printed at load time or execution time.
 (eval-when (:execute :load-toplevel)
   (eval-when (:compile-toplevel)
     (print 'foo6)))
</pre></div>


<span id="See-Also_003a-4"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="System-Construction.html#compile_002dfile">compile-file</a>, <a href="#Compilation">Section 3.2 (Compilation)</a>
</p>
<span id="Notes_003a-3"></span><h4 class="subsubheading">Notes:</h4>

<p>The following effects are logical consequences of the definition of 
<code>eval-when</code>:
</p>

<ul>
<li> Execution of a single <code>eval-when</code>
expression executes the body code at most once.

</li><li> <i>Macros</i> intended for use in <i>top level forms</i> 
should be written so that side-effects are done by the <i>forms</i>
in the macro expansion.  The macro-expander itself should not do 
the side-effects.

<p>For example:
</p>
<p>Wrong:  
</p>
<div class="lisp">
<pre class="lisp"> (defmacro foo ()
   (really-foo)
   `(really-foo))
</pre></div>


<p>Right:  
</p>
<div class="lisp">
<pre class="lisp"> (defmacro foo ()
   `(eval-when (:compile-toplevel :execute :load-toplevel) (really-foo)))
</pre></div>


<p>Adherence to this convention means that such <i>macros</i> behave
intuitively when appearing as <i>non-top-level forms</i>.
</p>
</li><li> Placing a variable binding around an <code>eval-when</code> reliably 
captures the binding because the compile-time-too mode cannot occur 
(<i>i.e.</i>, introducing a variable binding means that the <code>eval-when</code>
is not a <i>top level form</i>).
For example,

<div class="lisp">
<pre class="lisp"> (let ((x 3))
   (eval-when (:execute :load-toplevel :compile-toplevel) (print x)))
</pre></div>


<p>prints <code>3</code> 
at execution (<i>i.e.</i>, load) time, and does not print anything at
compile time.  This is important so that expansions of 
<code>defun</code> and 
<code>defmacro</code> 
can be done in terms of <code>eval-when</code> and can correctly capture
the <i>lexical environment</i>.
</p>
<div class="lisp">
<pre class="lisp"> (defun bar (x) (defun foo () (+ x 3)))
</pre></div>


<p>might expand into
</p>
<div class="lisp">
<pre class="lisp"> (defun bar (x) 
   (progn (eval-when (:compile-toplevel) 
            (compiler::notice-function-definition 'foo '(x)))
          (eval-when (:execute :load-toplevel)
            (setf (symbol-function 'foo) #'(lambda () (+ x 3))))))
</pre></div>


<p>which would be treated by the above rules the same as
</p>
<div class="lisp">
<pre class="lisp"> (defun bar (x) 
   (setf (symbol-function 'foo) #'(lambda () (+ x 3))))
</pre></div>


<p>when the definition of <code>bar</code> is not a <i>top level form</i>.
</p></li></ul>




<hr>
<span id="load_002dtime_002dvalue"></span><div class="header">
<p>
Next: <a href="#quote" accesskey="n" rel="next">quote</a>, Previous: <a href="#eval_002dwhen" accesskey="p" rel="prev">eval-when</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">load-time-value</h4>
<span id="load_002dtime_002dvalue-_0028Special-Operator_0029"></span><h3 class="heading">load-time-value (Special Operator)</h3>
<span id="index-load_002dtime_002dvalue-3"></span>
<span id="index-load_002dtime_002dvalue-1"></span>
      

<span id="Syntax_003a-5"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-load_002dtime_002dvalue-2">Special Form: <strong>load-time-value</strong> <em>form <tt>&amp;optional</tt> read-only-p <span class="roman">→</span> object</em></dt>
</dl>

<span id="Arguments-and-Values_003a-4"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>form</var>&mdash;a <i>form</i>; evaluated as described below.
</p>
<p><var>read-only-p</var>&mdash;a <i>boolean</i>; not evaluated.
</p>
<p><var>object</var>&mdash;the <i>primary value</i> resulting from evaluating <var>form</var>.
</p>
<span id="Description_003a-5"></span><h4 class="subsubheading">Description:</h4>

<p><code>load-time-value</code> provides a mechanism for delaying evaluation of <var>form</var>
until the expression is in the run-time environment; see <a href="#Compilation">Section 3.2 (Compilation)</a>.
</p>
<p><var>Read-only-p</var> designates whether the result can be considered a
<i>constant object</i>.
If <code>t</code>,
the result is a read-only quantity that can, 
if appropriate to the <i>implementation</i>, 
be copied into read-only space and/or <i>coalesced</i> with <i>similar</i>
<i>constant objects</i> from other <i>programs</i>.
If <code>nil</code>&nbsp;<!-- /@w -->(the default),
the result must be neither copied nor coalesced;
it must be considered to be potentially modifiable data.
</p>
<p>If a <code>load-time-value</code> expression is processed by <code>compile-file</code>,
the compiler performs its normal semantic processing (such as macro expansion 
and translation into machine code) on <var>form</var>, but arranges for the
execution of <var>form</var> to occur at load time in a <i>null lexical environment</i>, 
with the result of this <i>evaluation</i> then being treated as 
a <i>literal object</i>
at run time.  It is guaranteed that the evaluation of <var>form</var> 
will take place only once when the <i>file</i> is <i>loaded</i>, but 
the order of evaluation with respect to the evaluation of
<i>top level forms</i> in the file is <i>implementation-dependent</i>.
<span id="index-order-of-evaluation"></span>
<span id="index-evaluation-order"></span>
</p>
<p>If a <code>load-time-value</code> expression appears within a function compiled
with <code>compile</code>, the <var>form</var> is evaluated at compile time in a
<i>null lexical environment</i>.  The result of this compile-time evaluation 
is treated as
a <i>literal object</i>
in the compiled code.  
</p>
<p>If a <code>load-time-value</code> expression is processed by <code>eval</code>,
<var>form</var> is evaluated in a <i>null lexical environment</i>, 
and one value is returned.  Implementations that implicitly compile
(or partially compile) expressions processed by <code>eval</code> 
might evaluate <var>form</var> only once, at the time this compilation is performed.  
</p>
<p>If the <i>same</i> <i>list</i> <code>(load-time-value <var>form</var>)</code> is
evaluated or compiled more than once, it is <i>implementation-dependent</i>
whether <var>form</var> is evaluated only once or is evaluated more than once.
This can happen both when an expression being evaluated or compiled shares
substructure, and when the <i>same</i> <i>form</i> is processed by <code>eval</code> or 
<code>compile</code> multiple times.                               
Since a <code>load-time-value</code> expression can be
referenced in more than one place and can be evaluated multiple times
by <code>eval</code>, it is 
<i>implementation-dependent</i> whether each execution returns
a fresh <i>object</i> 
or returns the same <i>object</i> as some other execution.
Users must use caution when destructively modifying the resulting
<i>object</i>.
</p>
<p>If two lists <code>(load-time-value <var>form</var>)</code> 
that are the <i>same</i> under <code>equal</code> but are not <i>identical</i>
are evaluated or compiled,
their values always come from distinct evaluations of <var>form</var>.
Their <i>values</i> may not be coalesced
unless <var>read-only-p</var> is <code>t</code>.
</p>
<span id="Examples_003a-4"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp">;;; The function INCR1 always returns the same value, even in different images.
;;; The function INCR2 always returns the same value in a given image, 
;;; but the value it returns might vary from image to image.
(defun incr1 (x) (+ x #.(random 17)))
(defun incr2 (x) (+ x (load-time-value (random 17))))

;;; The function FOO1-REF references the nth element of the first of 
;;; the *FOO-ARRAYS* that is available at load time.  It is permissible for
;;; that array to be modified (e.g., by SET-FOO1-REF); FOO1-REF will see the
;;; updated values.
(defvar *foo-arrays* (list (make-array 7) (make-array 8)))
(defun foo1-ref (n) (aref (load-time-value (first *my-arrays*) nil) n))
(defun set-foo1-ref (n val) 
  (setf (aref (load-time-value (first *my-arrays*) nil) n) val))

;;; The function BAR1-REF references the nth element of the first of 
;;; the *BAR-ARRAYS* that is available at load time.  The programmer has
;;; promised that the array will be treated as read-only, so the system 
;;; can copy or coalesce the array.
(defvar *bar-arrays* (list (make-array 7) (make-array 8)))
(defun bar1-ref (n) (aref (load-time-value (first *my-arrays*) t) n))

;;; This use of LOAD-TIME-VALUE permits the indicated vector to be coalesced
;;; even though NIL was specified, because the object was already read-only
;;; when it was written as a literal vector rather than created by a constructor.
;;; User programs must treat the vector v as read-only.
(defun baz-ref (n)
  (let ((v (load-time-value #(A B C) nil)))
    (values (svref v n) v)))

;;; This use of LOAD-TIME-VALUE permits the indicated vector to be coalesced
;;; even though NIL was specified in the outer situation because T was specified
;;; in the inner situation.  User programs must treat the vector v as read-only.
(defun baz-ref (n)
  (let ((v (load-time-value (load-time-value (vector 1 2 3) t) nil)))
    (values (svref v n) v)))
</pre></div>


<span id="See-Also_003a-5"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="System-Construction.html#compile_002dfile">compile-file</a>,
<a href="#compile">compile</a>,
<a href="#eval">eval</a>,
<a href="#MinimalCompilation">Section 3.2.2.2 (Minimal Compilation)</a>,
<a href="#Compilation">Section 3.2 (Compilation)</a>
</p>
<span id="Notes_003a-4"></span><h4 class="subsubheading">Notes:</h4>

<p><code>load-time-value</code> must appear outside of quoted structure in a
&ldquo;for <i>evaluation</i>&rdquo; position.  In situations which would appear to call
for use of <code>load-time-value</code> within a quoted structure, 
the <i>backquote</i> <i>reader macro</i> is probably called for;
see <a href="Syntax.html#Backquote">Section 2.4.6 (Backquote)</a>.
</p>
<p>Specifying <code>nil</code>&nbsp;<!-- /@w -->for <var>read-only-p</var> is not a way to force an object
to become modifiable if it has already been made read-only.  It is only a way
to say that, for an object that is modifiable, this operation is not intended
to make that object read-only.
</p>


<hr>
<span id="quote"></span><div class="header">
<p>
Next: <a href="#compiler_002dmacro_002dfunction" accesskey="n" rel="next">compiler-macro-function</a>, Previous: <a href="#load_002dtime_002dvalue" accesskey="p" rel="prev">load-time-value</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">quote</h4>
<span id="quote-_0028Special-Operator_0029"></span><h3 class="heading">quote (Special Operator)</h3>
<span id="index-quote-5"></span>
<span id="index-quote-3"></span>


<span id="Syntax_003a-6"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-quote-4">Special Form: <strong>quote</strong> <em>object <span class="roman">→</span> object</em></dt>
</dl>

<span id="Arguments-and-Values_003a-5"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>object</var>&mdash;an <i>object</i>; not evaluated.
</p>
<span id="Description_003a-6"></span><h4 class="subsubheading">Description:</h4>

<p>The <code>quote</code> <i>special operator</i> just returns <var>object</var>.
</p>
<p>The consequences are undefined if <i>literal objects</i> (including
<i>quoted objects</i>) are destructively modified.
</p>
<span id="Examples_003a-5"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (setq a 1) <span class="roman">→</span> 1
 (quote (setq a 3)) <span class="roman">→</span> (SETQ A 3)
 a <span class="roman">→</span> 1
 'a <span class="roman">→</span> A
 ''a <span class="roman">→</span> (QUOTE A) 
 '''a <span class="roman">→</span> (QUOTE (QUOTE A))
 (setq a 43) <span class="roman">→</span> 43
 (list a (cons a 3)) <span class="roman">→</span> (43 (43 . 3))
 (list (quote a) (quote (cons a 3))) <span class="roman">→</span> (A (CONS A 3)) 
 1 <span class="roman">→</span> 1
 '1 <span class="roman">→</span> 1
 &quot;foo&quot; <span class="roman">→</span> &quot;foo&quot;
 '&quot;foo&quot; <span class="roman">→</span> &quot;foo&quot;
 (car '(a b)) <span class="roman">→</span> A
 '(car '(a b)) <span class="roman">→</span> (CAR (QUOTE (A B)))
 #(car '(a b)) <span class="roman">→</span> #(CAR (QUOTE (A B)))
 '#(car '(a b)) <span class="roman">→</span> #(CAR (QUOTE (A B)))
</pre></div>


<span id="See-Also_003a-6"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#Evaluation">Section 3.1 (Evaluation)</a>,
<a href="Syntax.html#Single_002dQuote">Section 2.4.3 (Single-Quote)</a>,
<a href="#Compiler-Terminology">Section 3.2.1 (Compiler Terminology)</a>
</p>
<span id="Notes_003a-5"></span><h4 class="subsubheading">Notes:</h4>

<p>The textual notation <code>'<var>object</var></code> is equivalent to <code>(quote <var>object</var>)</code>;
see <a href="#Compiler-Terminology">Section 3.2.1 (Compiler Terminology)</a>.
</p>
<p>Some <i>objects</i>, called <i>self-evaluating objects</i>, 
do not require quotation by <code>quote</code>.  
However, <i>symbols</i> and <i>lists</i> are used to represent parts of programs,
and so would not be useable as constant data in a program without <code>quote</code>.
Since <code>quote</code> suppresses the <i>evaluation</i> of these <i>objects</i>,
they become data rather than program.
</p>

<hr>
<span id="compiler_002dmacro_002dfunction"></span><div class="header">
<p>
Next: <a href="#define_002dcompiler_002dmacro" accesskey="n" rel="next">define-compiler-macro</a>, Previous: <a href="#quote" accesskey="p" rel="prev">quote</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">compiler-macro-function</h4>
<span id="compiler_002dmacro_002dfunction-_0028Accessor_0029"></span><h3 class="heading">compiler-macro-function (Accessor)</h3>
<span id="index-compiler_002dmacro_002dfunction-2"></span>
<span id="index-compiler_002dmacro_002dfunction"></span>



<span id="Syntax_003a-7"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-compiler_002dmacro_002dfunction-1">Function: <strong>compiler-macro-function</strong> <em>name <tt>&amp;optional</tt> environment <span class="roman">→</span> function</em></dt>
</dl>
<p><tt>(setf (compiler-macro-function name <tt>&amp;optional</tt> environment) new-function)</tt>
</p>
<span id="Arguments-and-Values_003a-6"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>name</var>&mdash;a <i>function name</i>.
</p>
<p><var>environment</var>&mdash;an <i>environment</i> <i>object</i>.
</p>
<p><var>function</var>, <var>new-function</var>&mdash;a <i>compiler macro function</i>, or <code>nil</code>.
</p>
<span id="Description_003a-7"></span><h4 class="subsubheading">Description:</h4>

<p><i>Accesses</i> the <i>compiler macro function</i> named <var>name</var>, if any,
in the <var>environment</var>.
</p>
<p>A value of <code>nil</code>&nbsp;<!-- /@w -->denotes the absence of a <i>compiler macro function</i> named <var>name</var>.
</p>
<span id="Exceptional-Situations_003a-1"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>The consequences are undefined if <var>environment</var> is <i>non-nil</i>
in a use of <code>setf</code> of <code>compiler-macro-function</code>.
</p>
<span id="See-Also_003a-7"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#define_002dcompiler_002dmacro">define-compiler-macro</a>, <a href="#CompilerMacros">Section 3.2.2.1 (Compiler Macros)</a>
</p>


<hr>
<span id="define_002dcompiler_002dmacro"></span><div class="header">
<p>
Next: <a href="#defmacro" accesskey="n" rel="next">defmacro</a>, Previous: <a href="#compiler_002dmacro_002dfunction" accesskey="p" rel="prev">compiler-macro-function</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">define-compiler-macro</h4>
<span id="define_002dcompiler_002dmacro-_0028Macro_0029"></span><h3 class="heading">define-compiler-macro (Macro)</h3>
<span id="index-define_002dcompiler_002dmacro-2"></span>
<span id="index-define_002dcompiler_002dmacro"></span>



<span id="Syntax_003a-8"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-define_002dcompiler_002dmacro-1">Macro: <strong>define-compiler-macro</strong> <em>name lambda-list 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>* <span class="roman">→</span> name</em></dt>
</dl>

<span id="Arguments-and-Values_003a-7"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>name</var>&mdash;a <i>function name</i>.
</p>
<p><var>lambda-list</var>&mdash;a <i>macro lambda list</i>.
</p>
<p><var>declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.
</p>
<p><var>documentation</var>&mdash;a <i>string</i>; not evaluated.
</p>
<p><var>form</var>&mdash;a <i>form</i>.
</p>
<span id="Description_003a-8"></span><h4 class="subsubheading">Description:</h4>



<p>This is the normal mechanism for defining a <i>compiler macro function</i>.
Its manner of definition is the same as for <code>defmacro</code>; the only
differences are:
</p>

<ul>
<li> The <var>name</var> can be a <i>function name</i> naming
any <i>function</i> or <i>macro</i>.

</li><li> The expander function is installed as a <i>compiler macro function</i>
for the <var>name</var>, rather than as a <i>macro function</i>.

</li><li> The <code>&amp;whole</code> argument is bound to the form argument that 
is passed to the <i>compiler macro function</i>.  The remaining lambda-list 
parameters are specified as if this form contained the function name in the
<i>car</i> and the actual arguments in the <i>cdr</i>, but if the <i>car</i> 
of the actual form is the symbol <code>funcall</code>, then the destructuring of 
the arguments is actually performed using its <i>cddr</i> instead.

<p><var>Documentation</var> is attached as a <i>documentation string</i> 
to <var>name</var> (as kind <code>compiler-macro</code>)
and to the <i>compiler macro function</i>.
</p>
</li><li> Unlike an ordinary <i>macro</i>, a <i>compiler macro</i>
can decline to provide an expansion merely by returning a form that is
the <i>same</i> as the original (which can be obtained by using
<code>&amp;whole</code>).
</li></ul>


<span id="Examples_003a-6"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun square (x) (expt x 2)) <span class="roman">→</span> SQUARE
 (define-compiler-macro square (&amp;whole form arg)
   (if (atom arg)
       `(expt ,arg 2)
       (case (car arg)
         (square (if (= (length arg) 2)
                     `(expt ,(nth 1 arg) 4)
                     form))
         (expt   (if (= (length arg) 3)
                     (if (numberp (nth 2 arg))
                         `(expt ,(nth 1 arg) ,(* 2 (nth 2 arg)))
                         `(expt ,(nth 1 arg) (* 2 ,(nth 2 arg))))
                     form))
         (otherwise `(expt ,arg 2))))) <span class="roman">→</span> SQUARE
 (square (square 3)) <span class="roman">→</span> 81
 (macroexpand '(square x)) <span class="roman">→</span> (SQUARE X), <i>false</i>
 (funcall (compiler-macro-function 'square) '(square x) nil)
<span class="roman">→</span> (EXPT X 2)
 (funcall (compiler-macro-function 'square) '(square (square x)) nil)
<span class="roman">→</span> (EXPT X 4)
 (funcall (compiler-macro-function 'square) '(funcall #'square x) nil)
<span class="roman">→</span> (EXPT X 2)

 (defun distance-positional (x1 y1 x2 y2)
   (sqrt (+ (expt (- x2 x1) 2) (expt (- y2 y1) 2))))
<span class="roman">→</span> DISTANCE-POSITIONAL
 (defun distance (&amp;key (x1 0) (y1 0) (x2 x1) (y2 y1))
   (distance-positional x1 y1 x2 y2))
<span class="roman">→</span> DISTANCE
 (define-compiler-macro distance (&amp;whole form
                                  &amp;rest key-value-pairs
                                  &amp;key (x1 0  x1-p)
                                       (y1 0  y1-p)
                                       (x2 x1 x2-p)
                                       (y2 y1 y2-p)
                                  &amp;allow-other-keys
                                  &amp;environment env)
   (flet ((key (n) (nth (* n 2) key-value-pairs))
          (arg (n) (nth (1+ (* n 2)) key-value-pairs))
          (simplep (x)
            (let ((expanded-x (macroexpand x env)))
              (or (constantp expanded-x env)
                  (symbolp expanded-x)))))
     (let ((n (/ (length key-value-pairs) 2)))
       (multiple-value-bind (x1s y1s x2s y2s others)
           (loop for (key) on key-value-pairs by #'cddr
                 count (eq key ':x1) into x1s
                 count (eq key ':y1) into y1s
                 count (eq key ':x2) into x2s
                 count (eq key ':y1) into y2s
                 count (not (member key '(:x1 :x2 :y1 :y2)))
                   into others
                 finally (return (values x1s y1s x2s y2s others)))
         (cond ((and (= n 4)
                     (eq (key 0) :x1)
                     (eq (key 1) :y1)
                     (eq (key 2) :x2)
                     (eq (key 3) :y2))
                `(distance-positional ,x1 ,y1 ,x2 ,y2))
               ((and (if x1-p (and (= x1s 1) (simplep x1)) t)
                     (if y1-p (and (= y1s 1) (simplep y1)) t)
                     (if x2-p (and (= x2s 1) (simplep x2)) t)
                     (if y2-p (and (= y2s 1) (simplep y2)) t)
                     (zerop others))
                `(distance-positional ,x1 ,y1 ,x2 ,y2))
               ((and (&lt; x1s 2) (&lt; y1s 2) (&lt; x2s 2) (&lt; y2s 2)
                     (zerop others))
                (let ((temps (loop repeat n collect (gensym))))
                  `(let ,(loop for i below n
                               collect (list (nth i temps) (arg i)))
                     (distance
                       ,@(loop for i below n
                               append (list (key i) (nth i temps)))))))
               (t form))))))
<span class="roman">→</span> DISTANCE
 (dolist (form
           '((distance :x1 (setq x 7) :x2 (decf x) :y1 (decf x) :y2 (decf x))
             (distance :x1 (setq x 7) :y1 (decf x) :x2 (decf x) :y2 (decf x))
             (distance :x1 (setq x 7) :y1 (incf x))
             (distance :x1 (setq x 7) :y1 (incf x) :x1 (incf x))
             (distance :x1 a1 :y1 b1 :x2 a2 :y2 b2)
             (distance :x1 a1 :x2 a2 :y1 b1 :y2 b2)
             (distance :x1 a1 :y1 b1 :z1 c1 :x2 a2 :y2 b2 :z2 c2)))
   (print (funcall (compiler-macro-function 'distance) form nil)))
▷ (LET ((#:G6558 (SETQ X 7))
▷       (#:G6559 (DECF X))
▷       (#:G6560 (DECF X))
▷       (#:G6561 (DECF X)))
▷   (DISTANCE :X1 #:G6558 :X2 #:G6559 :Y1 #:G6560 :Y2 #:G6561)) 
▷ (DISTANCE-POSITIONAL (SETQ X 7) (DECF X) (DECF X) (DECF X)) 
▷ (LET ((#:G6567 (SETQ X 7))
▷       (#:G6568 (INCF X)))
▷   (DISTANCE :X1 #:G6567 :Y1 #:G6568)) 
▷ (DISTANCE :X1 (SETQ X 7) :Y1 (INCF X) :X1 (INCF X)) 
▷ (DISTANCE-POSITIONAL A1 B1 A2 B2) 
▷ (DISTANCE-POSITIONAL A1 B1 A2 B2) 
▷ (DISTANCE :X1 A1 :Y1 B1 :Z1 C1 :X2 A2 :Y2 B2 :Z2 C2) 
<span class="roman">→</span> NIL
</pre></div>


<span id="See-Also_003a-8"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#compiler_002dmacro_002dfunction">compiler-macro-function</a>,
<a href="#defmacro">defmacro</a>,
<a href="Environment.html#documentation">documentation</a>,
<a href="#Syntactic-Interaction-of-Documentation-Strings-and-Declarations">Section 3.4.11 (Syntactic Interaction of Documentation Strings and Declarations)</a>
</p>
<span id="Notes_003a-6"></span><h4 class="subsubheading">Notes:</h4>

<p>The consequences of writing a <i>compiler macro</i> definition for a function
in the <code>COMMON-LISP</code> <i>package</i> are undefined; it is quite possible that in some
<i>implementations</i> such an attempt would override an equivalent or equally
important definition.  In general, it is recommended that a programmer only
write <i>compiler macro</i> definitions for <i>functions</i> he or she personally 
maintains&ndash;writing a <i>compiler macro</i> definition for a function maintained
elsewhere is normally considered a violation of traditional rules of modularity
and data abstraction.
</p>


<hr>
<span id="defmacro"></span><div class="header">
<p>
Next: <a href="#macro_002dfunction" accesskey="n" rel="next">macro-function</a>, Previous: <a href="#define_002dcompiler_002dmacro" accesskey="p" rel="prev">define-compiler-macro</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">defmacro</h4>
<span id="defmacro-_0028Macro_0029"></span><h3 class="heading">defmacro (Macro)</h3>
<span id="index-defmacro-2"></span>
<span id="index-defmacro"></span>



<span id="Syntax_003a-9"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-defmacro-1">Macro: <strong>defmacro</strong> <em>name lambda-list 〚<tt>{</tt>declaration<tt>}</tt>* <span class="roman">|</span> documentation〛 <tt>{</tt>form<tt>}</tt>* <span class="roman">→</span> name</em></dt>
</dl>

<span id="Arguments-and-Values_003a-8"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>name</var>&mdash;a <i>symbol</i>. 
</p>
<p><var>lambda-list</var>&mdash;a <i>macro lambda list</i>.
</p>
<p><var>declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.
</p>
<p><var>documentation</var>&mdash;a <i>string</i>; not evaluated.
</p>
<p><var>form</var>&mdash;a <i>form</i>.
</p>
<span id="Description_003a-9"></span><h4 class="subsubheading">Description:</h4>

<p>Defines <var>name</var> as a <i>macro</i> 
by associating a <i>macro function</i> with that <var>name</var>
in the global environment.
The <i>macro function</i> is defined in the same <i>lexical environment</i>
in which the <code>defmacro</code> <i>form</i> appears.
</p>

<p>The parameter variables in <var>lambda-list</var> are bound to
destructured portions of the macro call.
</p>
<p>The expansion function
accepts two arguments, a <i>form</i> and an 
<i>environment</i>.  The expansion function returns a <i>form</i>.  
The body of the expansion function is specified by <var>forms</var>.
<var>Forms</var> are executed in order.  The value of the
last <var>form</var> executed is returned as the expansion of the
<i>macro</i>.
The body <var>forms</var> of the expansion function (but not the <var>lambda-list</var>)
are implicitly enclosed in a <i>block</i> whose name is <var>name</var>.
</p>
<p>The <var>lambda-list</var> conforms to the requirements described in <a href="#Macro-Lambda-Lists">Section 3.4.4 (Macro Lambda Lists)</a>.
</p>
<p><var>Documentation</var> is attached as a <i>documentation string</i> 
to <var>name</var> (as kind <code>function</code>)
and to the <i>macro function</i>.
</p>
<p><code>defmacro</code> can be used to redefine a <i>macro</i> or to replace
a <i>function</i> definition with a <i>macro</i> definition.
</p>

<p>Recursive expansion of the <i>form</i> returned must terminate,
including the expansion of other <i>macros</i> which are <i>subforms</i>
of other <i>forms</i> returned.
</p>
<p>The consequences are undefined if the result of fully macroexpanding
a <i>form</i>
contains any <i>circular</i> <i>list structure</i> except in <i>literal objects</i>.
</p>
<p>If a <code>defmacro</code> <i>form</i> appears as a <i>top level form</i>,
the <i>compiler</i> must store the <i>macro</i> definition at compile time,
so that occurrences of the macro later on in the file can be expanded correctly.
Users must ensure that the body of the <i>macro</i> can be evaluated at 
compile time if it is referenced within the <i>file</i> being <i>compiled</i>.
</p>
<span id="Examples_003a-7"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defmacro mac1 (a b) &quot;Mac1 multiplies and adds&quot; 
            `(+ ,a (* ,b 3))) <span class="roman">→</span> MAC1 
 (mac1 4 5) <span class="roman">→</span> 19 
 (documentation 'mac1 'function) <span class="roman">→</span> &quot;Mac1 multiplies and adds&quot; 
 (defmacro mac2 (&amp;optional (a 2 b) (c 3 d) &amp;rest x) `'(,a ,b ,c ,d ,x)) <span class="roman">→</span> MAC2 
 (mac2 6) <span class="roman">→</span> (6 T 3 NIL NIL) 
 (mac2 6 3 8) <span class="roman">→</span> (6 T 3 T (8)) 
 (defmacro mac3 (&amp;whole r a &amp;optional (b 3) &amp;rest x &amp;key c (d a))
    `'(,r ,a ,b ,c ,d ,x)) <span class="roman">→</span> MAC3 
 (mac3 1 6 :d 8 :c 9 :d 10) <span class="roman">→</span> ((MAC3 1 6 :D 8 :C 9 :D 10) 1 6 9 8 (:D 8 :C 9 :D 10)) 
</pre></div>





<p>The stipulation that
an embedded <i>destructuring lambda list</i> is permitted only
where <i>ordinary lambda list</i> syntax would permit a parameter name
but not a <i>list</i> is made to prevent ambiguity.  For example,
the following is not valid:
</p>
<div class="lisp">
<pre class="lisp"> (defmacro loser (x &amp;optional (a b &amp;rest c) &amp;rest z)
   ...)
</pre></div>

<p>because <i>ordinary lambda list</i> syntax does permit a 
<i>list</i> following <tt>&amp;optional</tt>;
the list <code>(a b &amp;rest c)</code> would be interpreted as describing an
optional parameter named <code>a</code> whose default value is that of the
form <code>b</code>, with a supplied-p parameter named <code>&amp;rest</code> (not valid),
and an extraneous symbol <code>c</code> in the list (also not valid).  An almost
correct way to express this is
</p>
<div class="lisp">
<pre class="lisp"> (defmacro loser (x &amp;optional ((a b &amp;rest c)) &amp;rest z)
   ...)
</pre></div>

<p>The extra set of parentheses removes the ambiguity.  However, the
definition is now incorrect because a macro call such as <code>(loser (car pool))</code>
would not provide any argument form for the lambda list <code>(a b &amp;rest c)</code>,
and so the default value against which to match the <i>lambda list</i> would be
<code>nil</code>&nbsp;<!-- /@w -->because no explicit default value was specified.  
The consequences of this are  unspecified
since the empty list, <code>nil</code>, does not have <i>forms</i> to satisfy the
parameters <code>a</code> and <code>b</code>.  The fully correct definition would be either
</p>
<div class="lisp">
<pre class="lisp"> (defmacro loser (x &amp;optional ((a b &amp;rest c) '(nil nil)) &amp;rest z)
   ...)
</pre></div>

<p>or
</p>
<div class="lisp">
<pre class="lisp"> (defmacro loser (x &amp;optional ((&amp;optional a b &amp;rest c)) &amp;rest z)
   ...)
</pre></div>

<p>These differ slightly: the first requires that if the macro call
specifies <code>a</code> explicitly then it must also specify <code>b</code> explicitly,
whereas the second does not have this requirement.  For example,
</p>
<div class="lisp">
<pre class="lisp"> (loser (car pool) ((+ x 1)))
</pre></div>

<p>would be a valid call for the second definition but not for the first.
</p>

<div class="lisp">
<pre class="lisp"> (defmacro dm1a (&amp;whole x) `',x)
 (macroexpand '(dm1a))  <span class="roman">→</span> (QUOTE (DM1A))
 (macroexpand '(dm1a a)) is an error.
 
 (defmacro dm1b (&amp;whole x a &amp;optional b) `'(,x ,a ,b))
 (macroexpand '(dm1b))  is an error.
 (macroexpand '(dm1b q))  <span class="roman">→</span> (QUOTE ((DM1B Q) Q NIL))
 (macroexpand '(dm1b q r)) <span class="roman">→</span> (QUOTE ((DM1B Q R) Q R))
 (macroexpand '(dm1b q r s)) is an error.
</pre></div>


<div class="lisp">
<pre class="lisp"> (defmacro dm2a (&amp;whole form a b) `'(form ,form a ,a b ,b))
 (macroexpand '(dm2a x y)) <span class="roman">→</span> (QUOTE (FORM (DM2A X Y) A X B Y))
 (dm2a x y) <span class="roman">→</span> (FORM (DM2A X Y) A X B Y)

 (defmacro dm2b (&amp;whole form a (&amp;whole b (c . d) &amp;optional (e 5)) 
                 &amp;body f &amp;environment env)
   ``(,',form ,,a ,',b ,',(macroexpand c env) ,',d ,',e ,',f))
 ;Note that because backquote is involved, implementations may differ
 ;slightly in the nature (though not the functionality) of the expansion.
 (macroexpand '(dm2b x1 (((incf x2) x3 x4)) x5 x6))
 <span class="roman">→</span> (LIST* '(DM2B X1 (((INCF X2) X3 X4))
                   X5 X6)
            X1
            '((((INCF X2) X3 X4)) (SETQ X2 (+ X2 1)) (X3 X4) 5 (X5 X6))),
     T
 (let ((x1 5))
   (macrolet ((segundo (x) `(cadr ,x)))
     (dm2b x1 (((segundo x2) x3 x4)) x5 x6)))
 <span class="roman">→</span> ((DM2B X1 (((SEGUNDO X2) X3 X4)) X5 X6)
      5 (((SEGUNDO X2) X3 X4)) (CADR X2) (X3 X4) 5 (X5 X6))
</pre></div>



<span id="See-Also_003a-9"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#define_002dcompiler_002dmacro">define-compiler-macro</a>,
<a href="Data-and-Control-Flow.html#destructuring_002dbind">destructuring-bind</a>, 
<a href="Environment.html#documentation">documentation</a>,
<a href="#macroexpand">macroexpand</a>,
<a href="#g_t_002amacroexpand_002dhook_002a">*macroexpand-hook*</a>,
<a href="Data-and-Control-Flow.html#macrolet">macrolet</a>, 
<a href="#macro_002dfunction">macro-function</a>, 
<a href="#Evaluation">Section 3.1 (Evaluation)</a>,
<a href="#Compilation">Section 3.2 (Compilation)</a>,
<a href="#Syntactic-Interaction-of-Documentation-Strings-and-Declarations">Section 3.4.11 (Syntactic Interaction of Documentation Strings and Declarations)</a>
</p>


<hr>
<span id="macro_002dfunction"></span><div class="header">
<p>
Next: <a href="#macroexpand_003b-macroexpand_002d1" accesskey="n" rel="next">macroexpand; macroexpand-1</a>, Previous: <a href="#defmacro" accesskey="p" rel="prev">defmacro</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">macro-function</h4>
<span id="macro_002dfunction-_0028Accessor_0029"></span><h3 class="heading">macro-function (Accessor)</h3>
<span id="index-macro_002dfunction-2"></span>
<span id="index-macro_002dfunction"></span>


<span id="Syntax_003a-10"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-macro_002dfunction-1">Function: <strong>macro-function</strong> <em>symbol <tt>&amp;optional</tt> environment <span class="roman">→</span> function</em></dt>
</dl>
<p><tt>(setf (macro-function symbol <tt>&amp;optional</tt> environment) new-function)</tt>
</p>
<span id="Arguments-and-Values_003a-9"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>symbol</var>&mdash;a <i>symbol</i>.
</p>
<p><var>environment</var>&mdash;an <i>environment</i> <i>object</i>.
</p>
<p><var>function</var>&mdash;a <i>macro function</i> or <code>nil</code>.
</p>
<p><var>new-function</var>&mdash;a <i>macro function</i>.
</p>
<span id="Description_003a-10"></span><h4 class="subsubheading">Description:</h4>

<p>Determines whether <var>symbol</var> has a function definition 
as a macro in the specified <var>environment</var>.
</p>
<p>If so, the macro expansion function, a function of two arguments,
is returned.  If <var>symbol</var> has no function definition
in the lexical environment <var>environment</var>, or its definition
is not a <i>macro</i>, <code>macro-function</code> returns <code>nil</code>.
</p>



<p>It is possible for both <code>macro-function</code> and 
<code>special-operator-p</code>
to return <i>true</i> of <var>symbol</var>.  The <i>macro</i> definition must
be available for use by programs that understand only the standard 
<span class="roman">Common Lisp</span>&nbsp;<!-- /@w --><i>special forms</i>.
</p>
<span id="Examples_003a-8"></span><h4 class="subsubheading">Examples:</h4>
<div class="lisp">
<pre class="lisp"> (defmacro macfun (x) '(macro-function 'macfun)) <span class="roman">→</span> MACFUN 
 (not (macro-function 'macfun)) <span class="roman">→</span> <i>false</i> 
</pre></div>

<div class="lisp">
<pre class="lisp"> (macrolet ((foo (&amp;environment env)
               (if (macro-function 'bar env)
                  ''yes
                  ''no)))
    (list (foo)
          (macrolet ((bar () :beep))
             (foo))))
 
<span class="roman">→</span> (NO YES)
</pre></div>


<span id="Affected-By_003a-1"></span><h4 class="subsubheading">Affected By:</h4>
<p><code>(setf macro-function)</code>, <code>defmacro</code>, and <code>macrolet</code>.
</p>
<span id="Exceptional-Situations_003a-2"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>The consequences are undefined if <var>environment</var> is <i>non-nil</i>
in a use of <code>setf</code> of <code>macro-function</code>.
</p>
<span id="See-Also_003a-10"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#defmacro">defmacro</a>, <a href="#Evaluation">Section 3.1 (Evaluation)</a>
</p>
<span id="Notes_003a-7"></span><h4 class="subsubheading">Notes:</h4>

<p><code>setf</code> can be used with <code>macro-function</code> to install
a <i>macro</i> as a symbol&rsquo;s global function definition:
</p>
<div class="lisp">
<pre class="lisp"> (setf (macro-function symbol) fn)
</pre></div>

<p>The value installed must be a <i>function</i> that accepts two arguments,
the entire macro call and an <i>environment</i>, 
and computes the expansion for that call.
Performing this operation causes <var>symbol</var> to have only that
macro definition as its global function definition; any previous
definition, whether as a <i>macro</i> or as a 
<i>function</i>, is lost.
</p>

<hr>
<span id="macroexpand_003b-macroexpand_002d1"></span><div class="header">
<p>
Next: <a href="#define_002dsymbol_002dmacro" accesskey="n" rel="next">define-symbol-macro</a>, Previous: <a href="#macro_002dfunction" accesskey="p" rel="prev">macro-function</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">macroexpand; macroexpand-1</h4>
<span id="macroexpand_002c-macroexpand_002d1-_0028Function_0029"></span><h3 class="heading">macroexpand, macroexpand-1 (Function)</h3>
<span id="index-macroexpand-2"></span>
<span id="index-macroexpand"></span>
<span id="index-macroexpand_002d1-2"></span>
<span id="index-macroexpand_002d1"></span>
<span id="macroexpand"></span><span id="macroexpand_002d1"></span>

<span id="Syntax_003a-11"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-macroexpand-1">Function: <strong>macroexpand</strong> <em>form <tt>&amp;optional</tt> env <span class="roman">→</span> expansion, expanded-p</em></dt>
</dl>
<dl>
<dt id="index-macroexpand_002d1-1">Function: <strong>macroexpand-1</strong> <em>form <tt>&amp;optional</tt> env <span class="roman">→</span> expansion, expanded-p</em></dt>
</dl>

<span id="Arguments-and-Values_003a-10"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>form</var>&mdash;a <i>form</i>.
</p>
<p><var>env</var>&mdash;an <i>environment</i> <i>object</i>.
The default is <code>nil</code>.
</p>
<p><var>expansion</var>&mdash;a <i>form</i>.
</p>
<p><var>expanded-p</var>&mdash;a <i>generalized boolean</i>.
</p>
<span id="Description_003a-11"></span><h4 class="subsubheading">Description:</h4>

<p><code>macroexpand</code> and <code>macroexpand-1</code> expand <i>macros</i>.
</p>
<p>If <var>form</var> is a <i>macro form</i>,
then <code>macroexpand-1</code> expands the <i>macro form</i> call once.
</p>
<p><code>macroexpand</code> 
repeatedly expands <var>form</var> until it is no longer a <i>macro form</i>.
In effect, <code>macroexpand</code> calls <code>macroexpand-1</code> repeatedly
until the <i>secondary value</i> it returns is <code>nil</code>.
</p>
<p>If <var>form</var> is a <i>macro form</i>,
then the <var>expansion</var> is a <i>macro expansion</i>
and <var>expanded-p</var> is <i>true</i>.
Otherwise,
the <var>expansion</var> is the given <var>form</var>
and <var>expanded-p</var> is <i>false</i>.
</p>
<p>Macro expansion is carried out as follows.  
Once <code>macroexpand-1</code> has
determined that the <var>form</var> is a <i>macro form</i>,
it obtains an appropriate expansion <i>function</i> for the
<i>macro</i> or <i>symbol macro</i>.
The value of 
<code>*macroexpand-hook*</code> is 
coerced to a <i>function</i> and
then called as a <i>function</i> of three arguments:
the expansion <i>function</i>,
the <var>form</var>,
and the <var>env</var>.
The <i>value</i> returned from this call is taken to be the expansion
of the <var>form</var>.
</p>
<p>In addition to <i>macro</i> definitions in the global environment,
any local macro definitions established within <var>env</var> by <code>macrolet</code> 
or <code>symbol-macrolet</code> are considered.
If only <var>form</var> is supplied as an argument,
then the environment is effectively null, and only global macro definitions
as established by <code>defmacro</code> are considered.
<i>Macro</i> definitions are shadowed by local <i>function</i> definitions.
</p>
<span id="Examples_003a-9"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defmacro alpha (x y) `(beta ,x ,y)) <span class="roman">→</span> ALPHA
 (defmacro beta (x y) `(gamma ,x ,y)) <span class="roman">→</span> BETA
 (defmacro delta (x y) `(gamma ,x ,y)) <span class="roman">→</span> EPSILON
 (defmacro expand (form &amp;environment env)
   (multiple-value-bind (expansion expanded-p)
       (macroexpand form env)
     `(values ',expansion ',expanded-p))) <span class="roman">→</span> EXPAND
 (defmacro expand-1 (form &amp;environment env)
   (multiple-value-bind (expansion expanded-p)
       (macroexpand-1 form env)
     `(values ',expansion ',expanded-p))) <span class="roman">→</span> EXPAND-1
&nbsp;
&nbsp;
;; Simple examples involving just the global environment
 (macroexpand-1 '(alpha a b)) <span class="roman">→</span> (BETA A B), <i>true</i>
 (expand-1 (alpha a b)) <span class="roman">→</span> (BETA A B), <i>true</i>
 (macroexpand '(alpha a b)) <span class="roman">→</span> (GAMMA A B), <i>true</i>
 (expand (alpha a b)) <span class="roman">→</span> (GAMMA A B), <i>true</i>
 (macroexpand-1 'not-a-macro) <span class="roman">→</span> NOT-A-MACRO, <i>false</i>
 (expand-1 not-a-macro) <span class="roman">→</span> NOT-A-MACRO, <i>false</i>
 (macroexpand '(not-a-macro a b)) <span class="roman">→</span> (NOT-A-MACRO A B), <i>false</i>
 (expand (not-a-macro a b)) <span class="roman">→</span> (NOT-A-MACRO A B), <i>false</i>
&nbsp;
&nbsp;
;; Examples involving lexical environments
 (macrolet ((alpha (x y) `(delta ,x ,y)))
   (macroexpand-1 '(alpha a b))) <span class="roman">→</span> (BETA A B), <i>true</i>
 (macrolet ((alpha (x y) `(delta ,x ,y)))
   (expand-1 (alpha a b))) <span class="roman">→</span> (DELTA A B), <i>true</i>
 (macrolet ((alpha (x y) `(delta ,x ,y)))
   (macroexpand '(alpha a b))) <span class="roman">→</span> (GAMMA A B), <i>true</i>
 (macrolet ((alpha (x y) `(delta ,x ,y)))
   (expand (alpha a b))) <span class="roman">→</span> (GAMMA A B), <i>true</i>
 (macrolet ((beta (x y) `(epsilon ,x ,y)))
   (expand (alpha a b))) <span class="roman">→</span> (EPSILON A B), <i>true</i>
 (let ((x (list 1 2 3)))
   (symbol-macrolet ((a (first x)))
     (expand a))) <span class="roman">→</span> (FIRST X), <i>true</i>
 (let ((x (list 1 2 3)))
   (symbol-macrolet ((a (first x)))
     (macroexpand 'a))) <span class="roman">→</span> A, <i>false</i>
 (symbol-macrolet ((b (alpha x y)))
   (expand-1 b)) <span class="roman">→</span> (ALPHA X Y), <i>true</i>
 (symbol-macrolet ((b (alpha x y)))
   (expand b)) <span class="roman">→</span> (GAMMA X Y), <i>true</i>
 (symbol-macrolet ((b (alpha x y))
                   (a b))
   (expand-1 a)) <span class="roman">→</span> B, <i>true</i>
 (symbol-macrolet ((b (alpha x y))
                   (a b))
   (expand a)) <span class="roman">→</span> (GAMMA X Y), <i>true</i>
&nbsp;
&nbsp;
;; Examples of shadowing behavior
 (flet ((beta (x y) (+ x y)))
   (expand (alpha a b))) <span class="roman">→</span> (BETA A B), <i>true</i>
 (macrolet ((alpha (x y) `(delta ,x ,y)))
   (flet ((alpha (x y) (+ x y)))
     (expand (alpha a b)))) <span class="roman">→</span> (ALPHA A B), <i>false</i>
 (let ((x (list 1 2 3)))
   (symbol-macrolet ((a (first x)))
     (let ((a x))
       (expand a)))) <span class="roman">→</span> A, <i>false</i>
</pre></div>


<span id="Affected-By_003a-2"></span><h4 class="subsubheading">Affected By:</h4>

<p><code>defmacro</code>,
<code>setf</code> of <code>macro-function</code>,
<code>macrolet</code>,
<code>symbol-macrolet</code>
</p>
<span id="See-Also_003a-11"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#g_t_002amacroexpand_002dhook_002a">*macroexpand-hook*</a>,
<a href="#defmacro">defmacro</a>,
<a href="Data-and-Control-Flow.html#setf">setf</a> of <a href="#macro_002dfunction">macro-function</a>,
<a href="Data-and-Control-Flow.html#macrolet">macrolet</a>,
<a href="#symbol_002dmacrolet">symbol-macrolet</a>,
<a href="#Evaluation">Section 3.1 (Evaluation)</a>
</p>
<span id="Notes_003a-8"></span><h4 class="subsubheading">Notes:</h4>

<p>Neither <code>macroexpand</code> nor <code>macroexpand-1</code> 
makes any explicit attempt to expand <i>macro forms</i> that are
either <i>subforms</i> of the <var>form</var> 
or <i>subforms</i> of the <var>expansion</var>.
Such expansion might occur implicitly, however,
due to the semantics or implementation of the <i>macro function</i>.
</p>

<hr>
<span id="define_002dsymbol_002dmacro"></span><div class="header">
<p>
Next: <a href="#symbol_002dmacrolet" accesskey="n" rel="next">symbol-macrolet</a>, Previous: <a href="#macroexpand_003b-macroexpand_002d1" accesskey="p" rel="prev">macroexpand; macroexpand-1</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">define-symbol-macro</h4>
<span id="define_002dsymbol_002dmacro-_0028Macro_0029"></span><h3 class="heading">define-symbol-macro (Macro)</h3>
<span id="index-define_002dsymbol_002dmacro-2"></span>
<span id="index-define_002dsymbol_002dmacro"></span>


<span id="Syntax_003a-12"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-define_002dsymbol_002dmacro-1">Macro: <strong>define-symbol-macro</strong> <em>symbol expansion <span class="roman">→</span> symbol</em></dt>
</dl>

<span id="Arguments-and-Values_003a-11"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>symbol</var>&mdash;a <i>symbol</i>.
</p>
<p><var>expansion</var>&mdash;a <i>form</i>.
</p>
<span id="Description_003a-12"></span><h4 class="subsubheading">Description:</h4>

<p>Provides a mechanism for globally affecting the <i>macro expansion</i>
of the indicated <var>symbol</var>.
</p>
<p>Globally establishes an expansion function for the <i>symbol macro</i> 
named by <var>symbol</var>.
The only guaranteed property of an expansion <i>function</i> for a <i>symbol macro</i>
is that when it is applied to the <i>form</i> and the <i>environment</i> it returns
the correct expansion.  (In particular, it is <i>implementation-dependent</i> 
whether the expansion is conceptually stored in the expansion function,
the <i>environment</i>, or both.)
</p>
<p>Each global reference to <var>symbol</var> (<i>i.e.</i>, not <i>shadowed</i><sub>2</sub>
<i>binding</i> for a <i>variable</i> or <i>symbol macro</i> named by
the same <i>symbol</i>) is expanded by the normal macro expansion process;
see <a href="#SymbolsAsForms">Section 3.1.2.1.1 (Symbols as Forms)</a>.
The expansion of a <i>symbol macro</i> is subject to further <i>macro expansion</i>
in the same <i>lexical environment</i> as the <i>symbol macro</i> reference,
exactly analogous to normal <i>macros</i>.
</p>
<p>The consequences are unspecified if a <code>special</code> declaration is made for
<var>symbol</var> while in the scope of this definition (<i>i.e.</i>, when it is not 
<i>shadowed</i><sub>2</sub>
or <i>symbol macro</i> named by the same <i>symbol</i>).
</p>
<p>Any use of <code>setq</code> to set the value of 
the <var>symbol</var>
while in the scope of this definition
is treated as if it were a <code>setf</code>.
<code>psetq</code> of <var>symbol</var>
is treated as if it were a <code>psetf</code>, and
<code>multiple-value-setq</code> 
is treated as if it were a <code>setf</code> of <code>values</code>.
</p>
<p>A <i>binding</i> for a <i>symbol macro</i> can be <i>shadowed</i><sub>2</sub>
by <code>let</code> or <code>symbol-macrolet</code>.
</p>
<span id="Examples_003a-10"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp">(defvar *things* (list 'alpha 'beta 'gamma)) <span class="roman">→</span> *THINGS*

(define-symbol-macro thing1 (first *things*)) <span class="roman">→</span> THING1
(define-symbol-macro thing2 (second *things*)) <span class="roman">→</span> THING2
(define-symbol-macro thing3 (third *things*)) <span class="roman">→</span> THING3

thing1 <span class="roman">→</span> ALPHA
(setq thing1 'ONE) <span class="roman">→</span> ONE
*things* <span class="roman">→</span> (ONE BETA GAMMA)
(multiple-value-setq (thing2 thing3) (values 'two 'three)) <span class="roman">→</span> TWO
thing3 <span class="roman">→</span> THREE
*things* <span class="roman">→</span> (ONE TWO THREE)

(list thing2 (let ((thing2 2)) thing2)) <span class="roman">→</span> (TWO 2)
</pre></div>


<span id="Exceptional-Situations_003a-3"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>If <var>symbol</var> is already defined as a <i>global variable</i>,
an error of <i>type</i> <code>program-error</code> is signaled.
</p>
<span id="See-Also_003a-12"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#symbol_002dmacrolet">symbol-macrolet</a>,
<a href="#macroexpand">macroexpand</a>
</p>

<hr>
<span id="symbol_002dmacrolet"></span><div class="header">
<p>
Next: <a href="#g_t_002amacroexpand_002dhook_002a" accesskey="n" rel="next">*macroexpand-hook*</a>, Previous: <a href="#define_002dsymbol_002dmacro" accesskey="p" rel="prev">define-symbol-macro</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">symbol-macrolet</h4>
<span id="symbol_002dmacrolet-_0028Special-Operator_0029"></span><h3 class="heading">symbol-macrolet (Special Operator)</h3>
<span id="index-symbol_002dmacrolet-3"></span>
<span id="index-symbol_002dmacrolet-1"></span>



<span id="Syntax_003a-13"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-symbol_002dmacrolet-2">Special Form: <strong>symbol-macrolet</strong> <em><tt>(</tt><tt>{</tt><tt>(</tt>symbol expansion<tt>)</tt><tt>}</tt>*<tt>)</tt> <tt>{</tt>declaration<tt>}</tt>*  <tt>{</tt>form<tt>}</tt>* <span class="roman">→</span> <tt>{</tt>result<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments-and-Values_003a-12"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>symbol</var>&mdash;a <i>symbol</i>.
</p>
<p><var>expansion</var>&mdash;a <i>form</i>.
</p>
<p><var>declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.
</p>
<p><var>forms</var>&mdash;an <i>implicit progn</i>.
</p>
<p><var>results</var>&mdash;the <i>values</i> returned by the <var>forms</var>.
</p>
<span id="Description_003a-13"></span><h4 class="subsubheading">Description:</h4>


<p><code>symbol-macrolet</code> provides a mechanism for 
affecting the <i>macro expansion</i> environment for <i>symbols</i>.
</p>
<p><code>symbol-macrolet</code> lexically establishes expansion functions
for each of the <i>symbol macros</i> named by <var>symbols</var>.
The only guaranteed property of an expansion <i>function</i> for a <i>symbol macro</i>
is that when it is applied to the <i>form</i> and the <i>environment</i> it returns
the correct expansion.  (In particular, it is <i>implementation-dependent</i> 
whether the expansion is conceptually stored in the expansion function,
the <i>environment</i>, or both.)
</p>
<p>Each reference to <var>symbol</var> as a variable within the lexical <i>scope</i>
of <code>symbol-macrolet</code> is expanded by the normal macro expansion process;
see <a href="#SymbolsAsForms">Section 3.1.2.1.1 (Symbols as Forms)</a>.
The expansion of a symbol macro is subject to further macro expansion
in the same lexical environment as the symbol macro invocation, exactly 
analogous to normal <i>macros</i>.
</p>
<p>Exactly the same <var>declarations</var> are allowed as for <code>let</code>
with one exception: <code>symbol-macrolet</code> signals an error
if a <code>special</code> declaration names one of the <i>symbols</i> 
being defined by <code>symbol-macrolet</code>.  
</p>
<p>When the <var>forms</var> of the <code>symbol-macrolet</code> form are expanded, 
any use of <code>setq</code> to set the value of one of the specified variables 
is treated as if it were a <code>setf</code>.
<code>psetq</code> of a <i>symbol</i> defined as a symbol macro 
is treated as if it were a <code>psetf</code>, and
<code>multiple-value-setq</code> 
is treated as if it were a <code>setf</code> of <code>values</code>.
</p>
<p>The use of <code>symbol-macrolet</code> can be shadowed by <code>let</code>.
In other words, <code>symbol-macrolet</code> only substitutes for occurrences
of <var>symbol</var> that would be in the <i>scope</i> of a lexical binding of
<var>symbol</var> surrounding the <var>forms</var>.
</p>
<span id="Examples_003a-11"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp">;;; The following is equivalent to
;;;   (list 'foo (let ((x 'bar)) x)),
;;; not
;;;   (list 'foo (let (('foo 'bar)) 'foo))
 (symbol-macrolet ((x 'foo))
   (list x (let ((x 'bar)) x))) 
<span class="roman">→</span> (foo bar)
not<span class="roman">→</span> (foo foo) 
 
 (symbol-macrolet ((x '(foo x)))
   (list x))
<span class="roman">→</span> ((FOO X))
</pre></div>


<span id="Exceptional-Situations_003a-4"></span><h4 class="subsubheading">Exceptional Situations:</h4>
<p>If an attempt is made to bind a <i>symbol</i> that is defined as a <i>global variable</i>,
an error of <i>type</i> <code>program-error</code> is signaled.
</p>
<p>If <var>declaration</var> contains a <code>special</code> declaration 
that names one of the <i>symbols</i> being bound by <code>symbol-macrolet</code>,
an error of <i>type</i> <code>program-error</code> is signaled.
</p>
<span id="See-Also_003a-13"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="Objects.html#with_002dslots">with-slots</a>, <a href="#macroexpand">macroexpand</a>
</p>
<span id="Notes_003a-9"></span><h4 class="subsubheading">Notes:</h4>

<p>The special form <code>symbol-macrolet</code> is the basic mechanism that is used to
implement <code>with-slots</code>.
</p>
<p>If a <code>symbol-macrolet</code> <i>form</i> is a <i>top level form</i>,
the <var>forms</var> are also processed as <i>top level forms</i>.
See <a href="#File-Compilation">Section 3.2.3 (File Compilation)</a>.
</p>


<hr>
<span id="g_t_002amacroexpand_002dhook_002a"></span><div class="header">
<p>
Next: <a href="#proclaim" accesskey="n" rel="next">proclaim</a>, Previous: <a href="#symbol_002dmacrolet" accesskey="p" rel="prev">symbol-macrolet</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">*macroexpand-hook*</h4>
<span id="g_t_002amacroexpand_002dhook_002a-_0028Variable_0029"></span><h3 class="heading">*macroexpand-hook* (Variable)</h3>
<span id="index-_002amacroexpand_002dhook_002a-1"></span>
<span id="index-_002amacroexpand_002dhook_002a"></span>



<span id="Value-Type_003a"></span><h4 class="subsubheading">Value Type:</h4>

<p>a <i>designator</i> for a <i>function</i> of three <i>arguments</i>:
a <i>macro function</i>,
a <i>macro form</i>,
and an <i>environment</i> <i>object</i>.
</p>
<span id="Initial-Value_003a"></span><h4 class="subsubheading">Initial Value:</h4>

<p>a <i>designator</i> for a function that is equivalent to the <i>function</i> <code>funcall</code>,
but that might have additional <i>implementation-dependent</i> side-effects.
</p>
<span id="Description_003a-14"></span><h4 class="subsubheading">Description:</h4>

<p>Used as the expansion interface hook by <code>macroexpand-1</code> to 
control the <i>macro expansion</i> process.
When a <i>macro form</i> is to be expanded,
this <i>function</i> is called with three arguments:
the <i>macro function</i>,
the <i>macro form</i>,
and the <i>environment</i> in which the <i>macro form</i> is to be expanded.
The <i>environment</i> <i>object</i> has <i>dynamic extent</i>;
the consequences are undefined if the <i>environment</i> <i>object</i> is 
referred to outside the <i>dynamic extent</i> of the macro expansion function.
</p>
<span id="Examples_003a-12"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun hook (expander form env)
    (format t &quot;Now expanding: ~S~%&quot; form)
    (funcall expander form env)) <span class="roman">→</span> HOOK 
 (defmacro machook (x y) `(/ (+ ,x ,y) 2)) <span class="roman">→</span> MACHOOK 
 (macroexpand '(machook 1 2)) <span class="roman">→</span> (/ (+ 1 2) 2), <i>true</i> 
 (let ((*macroexpand-hook* #'hook)) (macroexpand '(machook 1 2)))
▷ Now expanding (MACHOOK 1 2) 
<span class="roman">→</span> (/ (+ 1 2) 2), <i>true</i>
</pre></div>


<span id="See-Also_003a-14"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#macroexpand">macroexpand</a>, <a href="#macroexpand_002d1">macroexpand-1</a>, <a href="Data-and-Control-Flow.html#funcall">funcall</a>, <a href="#Evaluation">Section 3.1 (Evaluation)</a>
</p>
<span id="Notes_003a-10"></span><h4 class="subsubheading">Notes:</h4>

<p>The net effect of the chosen initial value is to just invoke the
<i>macro function</i>, giving it the <i>macro form</i> and
<i>environment</i> as its two arguments.
</p>
<p>Users or user programs can <i>assign</i> this <i>variable</i> to
customize or trace the <i>macro expansion</i> mechanism.  Note, however,
that this <i>variable</i> is a global resource, potentially shared by
multiple <i>programs</i>; as such, if any two <i>programs</i> depend for
their correctness on the setting of this <i>variable</i>, those
<i>programs</i> may not be able to run in the same <i>Lisp image</i>.
For this reason, it is frequently best to confine its uses to debugging
situations.
</p>
<p>Users who put their own function into <code>*macroexpand-hook*</code>
should consider saving the previous value of the hook, and calling that
value from their own.
</p>


<hr>
<span id="proclaim"></span><div class="header">
<p>
Next: <a href="#declaim" accesskey="n" rel="next">declaim</a>, Previous: <a href="#g_t_002amacroexpand_002dhook_002a" accesskey="p" rel="prev">*macroexpand-hook*</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">proclaim</h4>
<span id="proclaim-_0028Function_0029"></span><h3 class="heading">proclaim (Function)</h3>
<span id="index-proclaim-2"></span>
<span id="index-proclaim"></span>


<span id="Syntax_003a-14"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-proclaim-1">Function: <strong>proclaim</strong> <em>declaration-specifier <span class="roman">→</span> <i>implementation-dependent</i></em></dt>
</dl>

<span id="Arguments-and-Values_003a-13"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>declaration-specifier</var>&mdash;a <i>declaration specifier</i>.
</p>
<span id="Description_003a-15"></span><h4 class="subsubheading">Description:</h4>

<p><i>Establishes</i> the <i>declaration</i> specified by <var>declaration-specifier</var>
in the <i>global environment</i>.
</p>
<p>Such a <i>declaration</i>, sometimes called a <i>global declaration</i> 
or a <i>proclamation</i>, is always in force unless locally <i>shadowed</i>.
</p>
<p><i>Names</i> of <i>variables</i> and <i>functions</i> within 
<var>declaration-specifier</var> refer to <i>dynamic variables</i> 
and global <i>function</i> definitions, respectively.
</p>
<p>The next figure&nbsp;<!-- /@w -->shows a list of <var>declaration identifiers</var> 
that can be used with <code>proclaim</code>.
</p>

<div class="float"><span id="fig3_002e22"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>declaration</td><td>inline</td><td>optimize</td><td>type</td></tr>
<tr><td>ftype</td><td>notinline</td><td>special</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.22: </strong>Global Declaration Specifiers</p></div></div>

<p>An implementation is free to support other (<i>implementation-defined</i>)
<i>declaration identifiers</i> as well.
</p>
<span id="Examples_003a-13"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun declare-variable-types-globally (type vars)
   (proclaim `(type ,type ,@vars))
   type)

 ;; Once this form is executed, the dynamic variable *TOLERANCE*
 ;; must always contain a float.
 (declare-variable-types-globally 'float '(*tolerance*))
<span class="roman">→</span> FLOAT
</pre></div>


<span id="See-Also_003a-15"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declaim">declaim</a>,
<a href="#declare">declare</a>,
<a href="#Compilation">Section 3.2 (Compilation)</a>
</p>
<span id="Notes_003a-11"></span><h4 class="subsubheading">Notes:</h4>

<p>Although the <i>execution</i> of a <code>proclaim</code> <i>form</i> 
has effects that might affect compilation, the compiler does not make
any attempt to recognize and specially process <code>proclaim</code> <i>forms</i>.
A <i>proclamation</i> such as the following, even if a <i>top level form</i>,
does not have any effect until it is executed:
</p>
<div class="lisp">
<pre class="lisp">(proclaim '(special *x*))
</pre></div>


<p>If compile time side effects are desired, <code>eval-when</code> may be useful.
For example:
</p>
<div class="lisp">
<pre class="lisp"> (eval-when (:execute :compile-toplevel :load-toplevel)
   (proclaim '(special *x*)))
</pre></div>


<p>In most such cases, however, it is preferrable to use <code>declaim</code> for
this purpose.
</p>
<p>Since <code>proclaim</code> <i>forms</i> are ordinary <i>function forms</i>,
<i>macro forms</i> can expand into them.
</p>

<hr>
<span id="declaim"></span><div class="header">
<p>
Next: <a href="#declare" accesskey="n" rel="next">declare</a>, Previous: <a href="#proclaim" accesskey="p" rel="prev">proclaim</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">declaim</h4>
<span id="declaim-_0028Macro_0029"></span><h3 class="heading">declaim (Macro)</h3>
<span id="index-declaim-2"></span>
<span id="index-declaim"></span>



<span id="Syntax_003a-15"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-declaim-1">Macro: <strong>declaim</strong> <em><tt>{</tt>declaration-specifier<tt>}</tt>* <span class="roman">→</span> <i>implementation-dependent</i></em></dt>
</dl>

<span id="Arguments-and-Values_003a-14"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>declaration-specifier</var>&mdash;a <i>declaration specifier</i>; not evaluated.
</p>
<span id="Description_003a-16"></span><h4 class="subsubheading">Description:</h4>

<p>Establishes the <i>declarations</i> specified by the <var>declaration-specifiers</var>.
</p>
<p>If a use of this macro appears as a <i>top level form</i> in a <i>file</i> 
being processed by the <i>file compiler</i>, the proclamations are also made
at compile-time.  As with other defining macros, it is unspecified whether or
not the compile-time side-effects of a <code>declaim</code> persist after the
<i>file</i> has been <i>compiled</i>.
</p>
<span id="Examples_003a-14"></span><h4 class="subsubheading">Examples:</h4>

<span id="See-Also_003a-16"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>,
<a href="#proclaim">proclaim</a>
</p>


<hr>
<span id="declare"></span><div class="header">
<p>
Next: <a href="#ignore_003b-ignorable" accesskey="n" rel="next">ignore; ignorable</a>, Previous: <a href="#declaim" accesskey="p" rel="prev">declaim</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">declare</h4>
<span id="declare-_0028Symbol_0029"></span><h3 class="heading">declare (Symbol)</h3>
<span id="index-declare-2"></span>
<span id="index-declare"></span>


<span id="Syntax_003a-16"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-declare-1">Special Form: <strong>declare</strong> <em><tt>{</tt>declaration-specifier<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments_003a-1"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>declaration-specifier</var>&mdash;a <i>declaration specifier</i>; not evaluated.
</p>
<span id="Description_003a-17"></span><h4 class="subsubheading">Description:</h4>

<p>A <tt>declare</tt> <i>expression</i>, sometimes called a <i>declaration</i>,
can occur only at the beginning of the bodies of certain <i>forms</i>;
that is, it may be preceded only by other <tt>declare</tt> <i>expressions</i>,
or by a <i>documentation string</i> if the context permits.
</p>
<p>A <tt>declare</tt> <i>expression</i> can occur in a <i>lambda expression</i>
or in any of the <i>forms</i> listed in the next figure.
</p>

<div class="float"><span id="fig3_002e23"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>defgeneric</td><td>do-external-symbols</td><td>prog</td></tr>
<tr><td>define-compiler-macro</td><td>do-symbols</td><td>prog*</td></tr>
<tr><td>define-method-combination</td><td>dolist</td><td>restart-case</td></tr>
<tr><td>define-setf-expander</td><td>dotimes</td><td>symbol-macrolet</td></tr>
<tr><td>defmacro</td><td>flet</td><td>with-accessors</td></tr>
<tr><td>defmethod</td><td>handler-case</td><td>with-hash-table-iterator</td></tr>
<tr><td>defsetf</td><td>labels</td><td>with-input-from-string</td></tr>
<tr><td>deftype</td><td>let</td><td>with-open-file</td></tr>
<tr><td>defun</td><td>let*</td><td>with-open-stream</td></tr>
<tr><td>destructuring-bind</td><td>locally</td><td>with-output-to-string</td></tr>
<tr><td>do</td><td>macrolet</td><td>with-package-iterator</td></tr>
<tr><td>do*</td><td>multiple-value-bind</td><td>with-slots</td></tr>
<tr><td>do-all-symbols</td><td>pprint-logical-block</td><td></td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.23: </strong>Standardized Forms In Which Declarations Can Occur</p></div></div>

<p>A <tt>declare</tt> <i>expression</i> can only occur 
where specified by the syntax of these <i>forms</i>.
The consequences of attempting to evaluate a <tt>declare</tt> <i>expression</i> 
are undefined.  In situations where such <i>expressions</i> can appear, 
explicit checks are made for their presence and they are never actually evaluated;
it is for this reason that they
are called  &ldquo;<tt>declare</tt> <i>expressions</i>&rdquo;
rather than &ldquo;<tt>declare</tt> <i>forms</i>.&rdquo;
</p>
<p><i>Macro forms</i> cannot expand into declarations;
<tt>declare</tt> <i>expressions</i> must appear as actual <i>subexpressions</i> of
the <i>form</i> to which they refer.
</p>
<p>The next figure&nbsp;<!-- /@w -->shows a list of <i>declaration identifiers</i> 
that can be used with <tt>declare</tt>.
</p>

<div class="float"><span id="fig3_002e24"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<tr><td>dynamic-extent</td><td>ignore</td><td>optimize</td></tr>
<tr><td>ftype</td><td>inline</td><td>special</td></tr>
<tr><td>ignorable</td><td>notinline</td><td>type</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.24: </strong>Local Declaration Specifiers</p></div></div>

<p>An implementation is free to support other (<i>implementation-defined</i>)
<i>declaration identifiers</i> as well.
</p>
<span id="Examples_003a-15"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun nonsense (k x z)
   (foo z x)                     ;First call to foo
   (let ((j (foo k x))           ;Second call to foo
         (x (* k k)))
     (declare (inline foo) (special x z))
     (foo x j z)))               ;Third call to foo
</pre></div>


<p>In this example,
the <code>inline</code> declaration applies
only to the third call to <code>foo</code>, but not to the first or second ones.
The <code>special</code> declaration of <code>x</code> causes <code>let</code> 
to make a dynamic <i>binding</i> for <code>x</code>, and causes the reference to 
<code>x</code>
in the body of <code>let</code> to be a dynamic reference.
The reference to <code>x</code> in the second call to <code>foo</code> is a local reference
to the second parameter of <code>nonsense</code>.
The reference to <code>x</code> in the first call to <code>foo</code> is a local
reference, not a <code>special</code> one.  The <code>special</code> declaration of <code>z</code>
causes the reference to <code>z</code> in the 
third
call
to <code>foo</code> to be a dynamic reference; it does not
refer to the parameter to <code>nonsense</code> named <code>z</code>, because that
parameter <i>binding</i> has not been declared to be <code>special</code>.
(The <code>special</code> declaration of <code>z</code> does not appear in the body
of <code>defun</code>,  but in an inner <i>form</i>, and therefore does not
affect the <i>binding</i> of the <i>parameter</i>.)
</p>
<span id="Exceptional-Situations_003a-5"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>The consequences  of trying to use a <tt>declare</tt> <i>expression</i> as 
a <i>form</i> to be <i>evaluated</i> are undefined.
</p>


<span id="See-Also_003a-17"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#proclaim">proclaim</a>,
<a href="Types-and-Classes.html#Type-Specifiers">Section 4.2.3 (Type Specifiers)</a>,
<a href="#declaration">declaration</a>,
<a href="#dynamic_002dextent">dynamic-extent</a>,
<a href="#ftype">ftype</a>,
<a href="#ignorable">ignorable</a>,
<a href="#ignore">ignore</a>,
<a href="#inline">inline</a>,
<a href="#notinline">notinline</a>,
<a href="#optimize">optimize</a>,
<a href="#type">type</a>
</p>

<hr>
<span id="ignore_003b-ignorable"></span><div class="header">
<p>
Next: <a href="#dynamic_002dextent" accesskey="n" rel="next">dynamic-extent</a>, Previous: <a href="#declare" accesskey="p" rel="prev">declare</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">ignore; ignorable</h4>
<span id="ignore_002c-ignorable-_0028Declaration_0029"></span><h3 class="heading">ignore, ignorable (Declaration)</h3>
<span id="index-ignore-1"></span>
<span id="index-ignore"></span>
<span id="index-ignorable-1"></span>
<span id="index-ignorable"></span>
<span id="ignore"></span><span id="ignorable"></span>


<span id="Syntax_003a-17"></span><h4 class="subsubheading">Syntax:</h4>

<p><code><tt>(</tt>ignore <tt>{</tt><var>var</var> | <tt>(</tt><tt>function</tt> <var>fn</var><tt>)</tt><tt>}</tt>*<tt>)</tt></code>
</p>
<p><code><tt>(</tt>ignorable <tt>{</tt><var>var</var> | <tt>(</tt><tt>function</tt> <var>fn</var><tt>)</tt><tt>}</tt>*<tt>)</tt></code>
</p>
<span id="Arguments_003a-2"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>var</var>&mdash;a <i>variable</i> <i>name</i>.
</p>
<p><var>fn</var>&mdash;a <i>function</i> <i>name</i>.
</p>
<span id="Valid-Context_003a"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i>
</p>
<span id="Binding-Types-Affected_003a"></span><h4 class="subsubheading">Binding Types Affected:</h4>

<p><i>variable</i>, <i>function</i>
</p>
<span id="Description_003a-18"></span><h4 class="subsubheading">Description:</h4>

<p>The <code>ignore</code> and <code>ignorable</code> declarations
refer to <i>for-value</i> <i>references</i> 
to <i>variable</i> <i>bindings</i> for the <var>vars</var>
and to <i>function</i> <i>bindings</i> for the <var>fns</var>.
</p>
<p>An <code>ignore</code> <i>declaration</i> specifies that
<i>for-value</i> <i>references</i> to the indicated <i>bindings</i>
will not
occur within the scope of the <i>declaration</i>.
Within the <i>scope</i> of such a <i>declaration</i>,
it is desirable
for a compiler to issue a warning about 
the presence of
either a <i>for-value</i> <i>reference</i> to any <var>var</var> or <var>fn</var>,
or a <code>special</code> <i>declaration</i> for any <var>var</var>.
</p>
<p>An <code>ignorable</code> <i>declaration</i> specifies that 
<i>for-value</i> <i>references</i> to the indicated <i>bindings</i>
might or might not
occur within the scope of the <i>declaration</i>.
Within the <i>scope</i> of such a <i>declaration</i>,
it is not desirable
for a compiler to issue a warning about
the presence or absence of
either a <i>for-value</i> <i>reference</i> to any <var>var</var> or <var>fn</var>,
or a <code>special</code> <i>declaration</i> for any <var>var</var>.
</p>
<p>When not within the <i>scope</i> 
of a <code>ignore</code> or <code>ignorable</code> <i>declaration</i>,
it is desirable
for a compiler to issue a warning about
any <var>var</var> for which there is 
neither a <i>for-value</i> <i>reference</i> 
nor a <code>special</code> <i>declaration</i>,
or about
any <var>fn</var> for which there is 
no <i>for-value</i> <i>reference</i>.
</p>
<p>Any warning about a &ldquo;used&rdquo; or &ldquo;unused&rdquo; <i>binding</i> must be of <i>type</i> <code>style-warning</code>,
and may not affect program semantics.
</p>

<p>The <i>stream variables</i> established by 
<code>with-open-file</code>,
<code>with-open-stream</code>,
<code>with-input-from-string</code>,
and <code>with-output-to-string</code>,
and all <i>iteration variables</i> are, by definition, always &ldquo;used&rdquo;.
Using <code>(declare (ignore <var>v</var>))</code>, 
for such a <i>variable</i> <var>v</var> has unspecified consequences.
</p>


<span id="See-Also_003a-18"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>
</p>

<hr>
<span id="dynamic_002dextent"></span><div class="header">
<p>
Next: <a href="#type" accesskey="n" rel="next">type</a>, Previous: <a href="#ignore_003b-ignorable" accesskey="p" rel="prev">ignore; ignorable</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">dynamic-extent</h4>
<span id="dynamic_002dextent-_0028Declaration_0029"></span><h3 class="heading">dynamic-extent (Declaration)</h3>
<span id="index-dynamic_002dextent-1"></span>
<span id="index-dynamic_002dextent"></span>


<span id="Syntax_003a-18"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(dynamic-extent 〚<tt>{</tt>var<tt>}</tt>* |
<tt>(</tt><tt>function</tt> <var>fn</var><tt>)</tt>*〛)</code>
</p>
<span id="Arguments_003a-3"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>var</var>&mdash;a <i>variable</i> <i>name</i>.
</p>
<p><var>fn</var>&mdash;a <i>function</i> <i>name</i>.
</p>
<span id="Valid-Context_003a-1"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i>
</p>
<span id="Binding-Types-Affected_003a-1"></span><h4 class="subsubheading">Binding Types Affected:</h4>

<p><i>variable</i>, <i>function</i>
</p>
<span id="Description_003a-19"></span><h4 class="subsubheading">Description:</h4>


<p>In some containing <i>form</i>, <var>F</var>, this declaration
asserts for each <var>var<sub>i</sub>
and for each <i>value</i> <var>v<sub>ij</sub>
and for each <i>object</i> <var>x<sub>ijk</sub>
is
an <i>otherwise inaccessible part</i> of <var>v<sub>ij</sub>
<var>v<sub>ij</sub>
becomes the value of <var>var<sub>i</sub>
that just after the execution of <var>F</var> terminates, 
<var>x<sub>ijk</sub>
(if <var>F</var> established a <i>binding</i> for <var>var<sub>i</sub>
or still an <i>otherwise inaccessible part</i> of the current value of 
<var>var<sub>i</sub>
for <var>var<sub>i</sub>
The same relation holds for each <var>fn<sub>i</sub>
except that the <i>bindings</i> are in the <i>function</i> <i>namespace</i>.

</var></var></var></var></var></var></var></var></var></var></var></p><p>The compiler is permitted to use
this information in any way that is appropriate to the <i>implementation</i>
and that does not conflict with the semantics of <span class="roman">Common Lisp</span>.
</p>
<p><code>dynamic-extent</code> declarations can be <i>free declarations</i>
or <i>bound declarations</i>.
</p>
<p>The <var>vars</var> and <var>fns</var> named in a <code>dynamic-extent</code> 
declaration must not refer to <i>symbol macro</i> or <i>macro</i> bindings.
</p>
<span id="Examples_003a-16"></span><h4 class="subsubheading">Examples:</h4>

<p>Since stack allocation of the initial value entails knowing at the
<i>object</i>&rsquo;s creation time that the <i>object</i> can be 
<i>stack-allocated</i>,  it is not generally useful to make a 
<code>dynamic-extent</code> <i>declaration</i> for <i>variables</i>
which have no lexically apparent initial value. 
For example, it is probably useful to write:
</p>
<div class="lisp">
<pre class="lisp"> (defun f ()
   (let ((x (list 1 2 3)))
     (declare (dynamic-extent x))
         ...))
</pre></div>


<p>This would permit those compilers that wish to do so to <i>stack allocate</i>
the list held by the local variable <code>x</code>.  It is permissible,
but in practice probably not as useful, to write:
</p>
<div class="lisp">
<pre class="lisp"> (defun g (x) (declare (dynamic-extent x)) ...)
 (defun f () (g (list 1 2 3)))
</pre></div>


<p>Most compilers would probably not <i>stack allocate</i> the <i>argument</i>
to <code>g</code> in <code>f</code> because it would be a modularity violation for the compiler
to assume facts about <code>g</code> from within <code>f</code>.   Only an implementation that 
was willing to be responsible for recompiling <code>f</code> if the definition of <code>g</code> 
changed incompatibly could legitimately <i>stack allocate</i> the <i>list</i> 
argument to <code>g</code> in <code>f</code>.
</p>
<p>Here is another example:
</p>
<div class="lisp">
<pre class="lisp"> (declaim (inline g))
 (defun g (x) (declare (dynamic-extent x)) ...)
 (defun f () (g (list 1 2 3)))
 
 (defun f ()
   (flet ((g (x) (declare (dynamic-extent x)) ...))
     (g (list 1 2 3))))
 
</pre></div>

<p>In the previous example, some compilers might determine that optimization was 
possible and others might not.
</p>
<p>A variant of this is the so-called &ldquo;stack allocated rest list&rdquo;
that can be achieved (in implementations supporting the optimization) by:
</p>
<div class="lisp">
<pre class="lisp"> (defun f (&amp;rest x)
   (declare (dynamic-extent x))
   ...)
</pre></div>


<p>Note that although the initial value of <code>x</code> is not explicit, the <code>f</code>
function is responsible for assembling the list <code>x</code> from the passed arguments,
so the <code>f</code> function can be optimized by the compiler to construct a 
<i>stack-allocated</i> list instead of a heap-allocated list in implementations
that support such.
</p>
<p>In the following example,
</p>
<div class="lisp">
<pre class="lisp"> (let ((x (list 'a1 'b1 'c1))
       (y (cons 'a2 (cons 'b2 (cons 'c2 nil)))))
   (declare (dynamic-extent x y))
   ...)
</pre></div>

<p>The <i>otherwise inaccessible parts</i> of <code>x</code> are three 
<i>conses</i>,  and the <i>otherwise inaccessible parts</i>
of <code>y</code> are three other <i>conses</i>.  
None of the symbols <code>a1</code>,  <code>b1</code>,  <code>c1</code>,  <code>a2</code>,
<code>b2</code>,  <code>c2</code>,  or <code>nil</code>&nbsp;<!-- /@w -->is an
<i>otherwise inaccessible part</i> of <code>x</code> or <code>y</code> because each
is <i>interned</i> and hence <i>accessible</i> by the <i>package</i>
(or <i>packages</i>) in which it is <i>interned</i>.
However, if a freshly allocated <i>uninterned</i> <i>symbol</i> had
been used, it would have been an <i>otherwise inaccessible part</i> of
the <i>list</i> which contained it.
</p>
<div class="lisp">
<pre class="lisp">;; In this example, the implementation is permitted to <i>stack allocate</i>
;; the list that is bound to X.
 (let ((x (list 1 2 3)))
   (declare (dynamic-extent x))
   (print x)
   :done)
▷ (1 2 3)
<span class="roman">→</span> :DONE
 
;; In this example, the list to be bound to L can be <i>stack-allocated</i>.
 (defun zap (x y z)
   (do ((l (list x y z) (cdr l)))
       ((null l))
     (declare (dynamic-extent l))
     (prin1 (car l)))) <span class="roman">→</span> ZAP
 (zap 1 2 3)
▷ 123
<span class="roman">→</span> NIL

;; Some implementations might open-code LIST-ALL-PACKAGES in a way
;; that permits using <i>stack allocation</i> of the list to be bound to L.
 (do ((l (list-all-packages) (cdr l)))
     ((null l))
   (declare (dynamic-extent l))
   (let ((name (package-name (car l))))
     (when (string-search &quot;COMMON-LISP&quot; name) (print name))))
▷ &quot;COMMON-LISP&quot;
▷ &quot;COMMON-LISP-USER&quot;
<span class="roman">→</span> NIL

;; Some implementations might have the ability to <i>stack allocate</i> 
;; rest lists.  A declaration such as the following should be a cue
;; to such implementations that stack-allocation of the rest list
;; would be desirable.
 (defun add (&amp;rest x)
   (declare (dynamic-extent x))
   (apply #'+ x)) <span class="roman">→</span> ADD
 (add 1 2 3) <span class="roman">→</span> 6

 (defun zap (n m)
   ;; Computes (RANDOM (+ M 1)) at relative speed of roughly O(N).
   ;; It may be slow, but with a good compiler at least it
   ;; doesn't waste much heap storage.  :-<tt>}</tt>
   (let ((a (make-array n)))
     (declare (dynamic-extent a))
     (dotimes (i n) 
       (declare (dynamic-extent i))
       (setf (aref a i) (random (+ i 1))))
     (aref a m))) <span class="roman">→</span> ZAP
 (&lt; (zap 5 3) 3) <span class="roman">→</span> <i>true</i>
</pre></div>


<p>The following are in error, since the value of <code>x</code> is used outside of its
<i>extent</i>:
</p>
<div class="lisp">
<pre class="lisp"> (length (list (let ((x (list 1 2 3)))  ; Invalid
                (declare (dynamic-extent x))
                x)))

 (progn (let ((x (list 1 2 3)))  ; Invalid
          (declare (dynamic-extent x))
          x)
        nil)
</pre></div>


<span id="See-Also_003a-19"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>
</p>
<span id="Notes_003a-12"></span><h4 class="subsubheading">Notes:</h4>

<p>The most common optimization is to <i>stack allocate</i> the 
initial value of the <i>objects</i> named by the <var>vars</var>. 
</p>
<p>It is permissible for an implementation to simply ignore this declaration.
</p>

<hr>
<span id="type"></span><div class="header">
<p>
Next: <a href="#inline_003b-notinline" accesskey="n" rel="next">inline; notinline</a>, Previous: <a href="#dynamic_002dextent" accesskey="p" rel="prev">dynamic-extent</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">type</h4>
<span id="type-_0028Declaration_0029"></span><h3 class="heading">type (Declaration)</h3>
<span id="index-type-1"></span>
<span id="index-type"></span>


<span id="Syntax_003a-19"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(type <var>typespec</var> <tt>{</tt>var<tt>}</tt>*)</code>
</p>
<p><code>(<var>typespec</var> <tt>{</tt>var<tt>}</tt>*)</code>
</p>
<span id="Arguments_003a-4"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>typespec</var>&mdash;a <i>type specifier</i>.
</p>
<p><var>var</var>&mdash;a <i>variable</i> <i>name</i>.
</p>
<span id="Valid-Context_003a-2"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i> or <i>proclamation</i>
</p>
<span id="Binding-Types-Affected_003a-2"></span><h4 class="subsubheading">Binding Types Affected:</h4>

<p><i>variable</i>
</p>
<span id="Description_003a-20"></span><h4 class="subsubheading">Description:</h4>

<p>Affects
only variable <i>bindings</i> and specifies that the
<var>vars</var> take on 
values only of the specified <var>typespec</var>.
In particular, values assigned to the variables by <code>setq</code>,
as well as the initial values of the <var>vars</var> must be of
the specified <var>typespec</var>.
<code>type</code> declarations never apply to function <i>bindings</i> (see <code>ftype</code>).
</p>
<p>A type declaration of a <i>symbol</i> 
defined by <code>symbol-macrolet</code> is equivalent
to wrapping a <code>the</code> 
expression around the expansion of that <i>symbol</i>,
although the <i>symbol</i>&rsquo;s <i>macro expansion</i> is not actually affected.
</p>

<p>The meaning of a type declaration
is equivalent to changing each reference to 
a variable (<var>var</var>) within the scope of the
declaration to <code>(the <var>typespec</var> <var>var</var>)</code>,
changing each expression assigned to the
variable (<var>new-value</var>) within the scope of the declaration to 
<code>(the <var>typespec</var> <var>new-value</var>)</code>,
and executing 
<code>(the <var>typespec</var> <var>var</var>)</code> at the moment the scope of the declaration
is entered.
</p>
<p>A <i>type</i> declaration is valid in all declarations. The interpretation
of a type declaration is as follows:
</p>
<ol>
<li> During the execution of any reference to the
declared variable within the scope of the declaration, the consequences
are 
undefined
if
the value of the declared variable is not of the declared <i>type</i>.

</li><li> During the execution of any 
<code>setq</code> of the declared variable within the scope
of the declaration, the consequences are 
undefined
if the newly assigned value of the
declared variable is not of the declared <i>type</i>. 

</li><li> At the moment the
scope of the declaration is entered, the consequences are 
undefined
if the value of the
declared variable is not of the declared <i>type</i>.
</li></ol>


<p>A <i>type</i> declaration affects only variable references within
its scope.
</p>
<p>If nested <i>type</i> declarations refer to the same variable,
then the value of the variable must be a member of the intersection of
the declared <i>types</i>.
</p>
<p>If there is a local <code>type</code> declaration for a dynamic
variable, and there is also a global <code>type</code> proclamation for that same
variable, then the value of the variable within the scope of the local
declaration must be a member of the intersection of the two declared
<i>types</i>.
</p>
<p><code>type</code> declarations can  be <i>free declarations</i>
or <i>bound declarations</i>.
</p>
<p>A <i>symbol</i> cannot be both the name of a <i>type</i> and the name of a
declaration.  Defining a <i>symbol</i> as the <i>name</i> of a <i>class</i>,
<i>structure</i>, <i>condition</i>, or <i>type</i>, when the <i>symbol</i>
has been <i>declared</i> as a declaration name, or vice versa, signals an error.
</p>
<p>Within the <i>lexical scope</i> of an <code>array</code> type declaration, 
all references to <i>array</i> <i>elements</i> are assumed to satisfy the
<i>expressed array element type</i> (as opposed to the <i>upgraded array element type</i>).
A compiler can treat
the code within the scope of the <code>array</code> type declaration as if each
<i>access</i> of an <i>array</i> <i>element</i> were surrounded by an appropriate 
<code>the</code> form.
</p>
<span id="Examples_003a-17"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun f (x y)
   (declare (type fixnum x y))
   (let ((z (+ x y)))
     (declare (type fixnum z))
     z)) <span class="roman">→</span> F
 (f 1 2) <span class="roman">→</span> 3
 ;; The previous definition of F is equivalent to
 (defun f (x y)
   ;; This declaration is a shorthand form of the TYPE declaration
   (declare (fixnum x y))
   ;; To declare the type of a return value, it's not necessary to
   ;; create a named variable.  A THE special form can be used instead.
   (the fixnum (+ x y))) <span class="roman">→</span> F
 (f 1 2) <span class="roman">→</span> 3
</pre></div>



<div class="lisp">
<pre class="lisp"> (defvar *one-array* (make-array 10 :element-type '(signed-byte 5)))
 (defvar *another-array* (make-array 10 :element-type '(signed-byte 8)))
  
 (defun frob (an-array)
   (declare (type (array (signed-byte 5) 1) an-array))
   (setf (aref an-array 1) 31)
   (setf (aref an-array 2) 127)
   (setf (aref an-array 3) (* 2 (aref an-array 3)))
   (let ((foo 0))
     (declare (type (signed-byte 5) foo))
     (setf foo (aref an-array 0))))
  
 (frob *one-array*)
 (frob *another-array*)
</pre></div>


<p>&nbsp;</p>
<p>&nbsp;</p>

<p>The above definition of <code>frob</code> is equivalent to:
</p>
<div class="lisp">
<pre class="lisp"> (defun frob (an-array)
   (setf (the (signed-byte 5) (aref an-array 1)) 31)
   (setf (the (signed-byte 5) (aref an-array 2)) 127)
   (setf (the (signed-byte 5) (aref an-array 3))
         (* 2 (the (signed-byte 5) (aref an-array 3))))
   (let ((foo 0))
     (declare (type (signed-byte 5) foo))
     (setf foo (the (signed-byte 5) (aref an-array 0)))))
</pre></div>


<p>Given an implementation in which 
<i>fixnums</i> are 29 bits but <code>fixnum</code> <i>arrays</i> 
are upgraded to signed 32-bit <i>arrays</i>,
the following 
could be compiled with all <i>fixnum</i> arithmetic:
</p>
<div class="lisp">
<pre class="lisp"> (defun bump-counters (counters)
   (declare (type (array fixnum *) bump-counters))
   (dotimes (i (length counters))
     (incf (aref counters i))))
</pre></div>


<span id="See-Also_003a-20"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>,
<a href="#declaim">declaim</a>,
<a href="#proclaim">proclaim</a>
</p>
<span id="Notes_003a-13"></span><h4 class="subsubheading">Notes:</h4>

<p><code>(<var>typespec</var> <tt>{</tt>var<tt>}</tt>*)</code> 
is an abbreviation for <code>(type <var>typespec</var> <tt>{</tt>var<tt>}</tt>*)</code>.
</p>
<p>A <code>type</code> declaration for the arguments to a function does not
necessarily imply anything about the type of the result.  The following
function is not permitted to be compiled using <i>implementation-dependent</i>
<i>fixnum</i>-only arithmetic:
</p>
<div class="lisp">
<pre class="lisp"> (defun f (x y) (declare (fixnum x y)) (+ x y))
</pre></div>


<p>To see why, consider <code>(f most-positive-fixnum 1)</code>.
Common Lisp defines that <code>F</code> must return a <i>bignum</i> here, rather
than signal an error or produce a mathematically incorrect result.
If you have special knowledge such &ldquo;<i>fixnum</i> overflow&rdquo; cases will
not come up, you can declare the result value to be in the <i>fixnum</i>
range, enabling some compilers to use more efficient arithmetic:
</p>
<div class="lisp">
<pre class="lisp"> (defun f (x y)
   (declare (fixnum x y))
   (the fixnum (+ x y)))
</pre></div>


<p>Note, however, that in the three-argument case, because of the possibility
of an implicit intermediate value growing too large, the following will not
cause <i>implementation-dependent</i> <i>fixnum</i>-only arithmetic to be used:
</p>
<div class="lisp">
<pre class="lisp"> (defun f (x y)
   (declare (fixnum x y z))
   (the fixnum (+ x y z)))
</pre></div>


<p>To see why, consider <code>(f most-positive-fixnum 1 -1).</code>
Although the arguments and the result are all <i>fixnums</i>, an intermediate
value is not a <i>fixnum</i>.  If it is important that 
<i>implementation-dependent</i> <i>fixnum</i>-only arithmetic be selected
in <i>implementations</i> that provide it, 
consider writing something like this instead:
</p>
<div class="lisp">
<pre class="lisp"> (defun f (x y)
   (declare (fixnum x y z))
   (the fixnum (+ (the fixnum (+ x y)) z)))
</pre></div>



<hr>
<span id="inline_003b-notinline"></span><div class="header">
<p>
Next: <a href="#ftype" accesskey="n" rel="next">ftype</a>, Previous: <a href="#type" accesskey="p" rel="prev">type</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">inline; notinline</h4>
<span id="inline_002c-notinline-_0028Declaration_0029"></span><h3 class="heading">inline, notinline (Declaration)</h3>
<span id="index-inline-1"></span>
<span id="index-inline"></span>
<span id="index-notinline-2"></span>
<span id="index-notinline-1"></span>
<span id="inline"></span><span id="notinline"></span>

<span id="Syntax_003a-20"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(inline <tt>{</tt>function-name<tt>}</tt>*)</code>
</p>
<p><code>(notinline <tt>{</tt>function-name<tt>}</tt>*)</code>
</p>
<span id="Arguments_003a-5"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>function-name</var>&mdash;a <i>function name</i>.
</p>
<span id="Valid-Context_003a-3"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i> or <i>proclamation</i>
</p>
<span id="Binding-Types-Affected_003a-3"></span><h4 class="subsubheading">Binding Types Affected:</h4>

<p><i>function</i>
</p>
<span id="Description_003a-21"></span><h4 class="subsubheading">Description:</h4>

<p><code>inline</code> specifies that
it is desirable for the compiler to produce inline calls
to the <i>functions</i> named by <var>function-names</var>; 
that is, the code for a specified <var>function-name</var>
should be integrated into the calling routine, appearing &ldquo;in line&rdquo;
in place of a procedure call.  
A compiler is free to ignore this declaration.
<code>inline</code> declarations never apply to variable <i>bindings</i>. 
</p>
<p>If one of the <i>functions</i> mentioned has a lexically apparent local definition
(as made by <code>flet</code> or <code>labels</code>), then the declaration
applies to that local definition and not to the global function definition.
</p>
<p>While no <i>conforming implementation</i> is required to perform inline expansion
of user-defined functions, those <i>implementations</i> that do attempt
to recognize the following paradigm:
</p>
<p>To define a <i>function</i> <code>f</code> that is not <code>inline</code> by default
but for which <code>(declare (inline f))</code> will make <var>f</var> be locally inlined,
the proper definition sequence is:
</p>
<div class="lisp">
<pre class="lisp"> (declaim (inline f))
 (defun f ...)
 (declaim (notinline f))
</pre></div>


<p>The <code>inline</code> proclamation preceding the <code>defun</code> <i>form</i>
ensures that the <i>compiler</i> has the opportunity save the information
necessary for inline expansion, and the <code>notinline</code> proclamation 
following the <code>defun</code> <i>form</i> prevents <code>f</code> from being expanded
inline everywhere.  
</p>
<p><code>notinline</code> specifies that it is
undesirable to compile the <i>functions</i>
named by <var>function-names</var> in-line.
A compiler is not free to ignore this declaration;
calls to the specified functions must be implemented as out-of-line subroutine calls.
</p>
<p>If one of the <i>functions</i>
mentioned has a lexically apparent local definition
(as made by <code>flet</code> or <code>labels</code>), then the declaration
applies to that local definition and not to the global function definition.
</p>
<p>In the presence of a <i>compiler macro</i> definition for 
<var>function-name</var>, a <code>notinline</code> declaration prevents that
<i>compiler macro</i> from being used.
An <code>inline</code> declaration may be used to encourage use of 
<i>compiler macro</i> definitions.  <code>inline</code> and <code>notinline</code>
declarations otherwise have no effect when the lexically visible definition
of <var>function-name</var> is a <i>macro</i> definition.
</p>
<p><code>inline</code> and <code>notinline</code> declarations can be <i>free declarations</i> or
<i>bound declarations</i>.                  
<code>inline</code> and <code>notinline</code> declarations of functions that
appear before the body of a 
<code>flet</code>
or  <code>labels</code>
<i>form</i> that defines that function are <i>bound declarations</i>.  
Such declarations in other contexts are <i>free declarations</i>.
</p>
<span id="Examples_003a-18"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> ;; The globally defined function DISPATCH should be open-coded,
 ;; if the implementation supports inlining, unless a NOTINLINE 
 ;; declaration overrides this effect.
 (declaim (inline dispatch))
 (defun dispatch (x) (funcall (get (car x) 'dispatch) x))
 ;; Here is an example where inlining would be encouraged.
 (defun top-level-1 () (dispatch (read-command)))
 ;; Here is an example where inlining would be prohibited.
 (defun top-level-2 ()
   (declare (notinline dispatch))
   (dispatch (read-command)))
 ;; Here is an example where inlining would be prohibited.
 (declaim (notinline dispatch))
 (defun top-level-3 () (dispatch (read-command)))
 ;; Here is an example where inlining would be encouraged.
 (defun top-level-4 () 
   (declare (inline dispatch))
   (dispatch (read-command)))
</pre></div>


<span id="See-Also_003a-21"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>,
<a href="#declaim">declaim</a>,
<a href="#proclaim">proclaim</a>
</p>

<hr>
<span id="ftype"></span><div class="header">
<p>
Next: <a href="#declaration" accesskey="n" rel="next">declaration</a>, Previous: <a href="#inline_003b-notinline" accesskey="p" rel="prev">inline; notinline</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">ftype</h4>
<span id="ftype-_0028Declaration_0029"></span><h3 class="heading">ftype (Declaration)</h3>
<span id="index-ftype-1"></span>
<span id="index-ftype"></span>


<span id="Syntax_003a-21"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(ftype <var>type</var> <tt>{</tt>function-name<tt>}</tt>*)</code>
</p>
<span id="Arguments_003a-6"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>function-name</var>&mdash;a <i>function name</i>.
</p>
<p><var>type</var>&mdash;a <i>type specifier</i>.
</p>
<span id="Valid-Context_003a-4"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i> or <i>proclamation</i>
</p>
<span id="Binding-Types-Affected_003a-4"></span><h4 class="subsubheading">Binding Types Affected:</h4>

<p><i>function</i>
</p>
<span id="Description_003a-22"></span><h4 class="subsubheading">Description:</h4>

<p>Specifies that the <i>functions</i> named by <var>function-names</var> are of
the functional type <var>type</var>.
For example:
</p>
<div class="lisp">
<pre class="lisp"> (declare (ftype (function (integer list) t) ith)
          (ftype (function (number) float) sine cosine))
</pre></div>

<p>If one of the <i>functions</i> mentioned has a lexically apparent local definition
(as made by <code>flet</code> or <code>labels</code>), then the declaration
applies to that local definition and not to the global function definition.
<code>ftype</code> declarations never apply to variable <i>bindings</i> (see <code>type</code>). 
</p>
<p>The lexically apparent bindings of <var>function-names</var> must not be
<i>macro</i> definitions.  (This is because <code>ftype</code> declares the
functional definition of each <i>function name</i> to be of a particular
subtype of <code>function</code>, and <i>macros</i> do not denote 
<i>functions</i>.)
</p>
<p><code>ftype</code> 
declarations
can be <i>free declarations</i> or <i>bound declarations</i>.
<code>ftype</code> declarations of functions that appear before the body of a 
<code>flet</code>
or <code>labels</code>
<i>form</i> that defines that function are <i>bound declarations</i>.  
Such declarations in other contexts are <i>free declarations</i>.
</p>

<span id="See-Also_003a-22"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>,
<a href="#declaim">declaim</a>,
<a href="#proclaim">proclaim</a>
</p>

<hr>
<span id="declaration"></span><div class="header">
<p>
Next: <a href="#optimize" accesskey="n" rel="next">optimize</a>, Previous: <a href="#ftype" accesskey="p" rel="prev">ftype</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">declaration</h4>
<span id="declaration-_0028Declaration_0029"></span><h3 class="heading">declaration (Declaration)</h3>
<span id="index-declaration-3"></span>
<span id="index-declaration-2"></span>


<span id="Syntax_003a-22"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(declaration <tt>{</tt>name<tt>}</tt>*)</code>
</p>
<span id="Arguments_003a-7"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>name</var>&mdash;a <i>symbol</i>.
</p>
<span id="Valid-Context_003a-5"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>proclamation</i> only
</p>
<span id="Description_003a-23"></span><h4 class="subsubheading">Description:</h4>

<p>Advises the compiler that each <var>name</var> is a valid but potentially
non-standard declaration name.  The purpose of this is to tell one
compiler not to issue warnings for declarations meant for another 
compiler or other program processor.
</p>
<span id="Examples_003a-19"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (declaim (declaration author target-language target-machine))
 (declaim (target-language ada))
 (declaim (target-machine IBM-650))
 (defun strangep (x)
   (declare (author &quot;Harry Tweeker&quot;))
   (member x '(strange weird odd peculiar)))
</pre></div>


<span id="See-Also_003a-23"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declaim">declaim</a>,
<a href="#proclaim">proclaim</a>
</p>

<hr>
<span id="optimize"></span><div class="header">
<p>
Next: <a href="#special" accesskey="n" rel="next">special</a>, Previous: <a href="#declaration" accesskey="p" rel="prev">declaration</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">optimize</h4>
<span id="optimize-_0028Declaration_0029"></span><h3 class="heading">optimize (Declaration)</h3>
<span id="index-optimize-1"></span>
<span id="index-optimize"></span>


<span id="Syntax_003a-23"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(optimize <tt>{</tt><var>quality</var> | (<var>quality</var> <var>value</var>)<tt>}</tt>*)</code>
<span id="index-compilation_002dspeed"></span>
<span id="index-debug"></span>
<span id="index-safety-1"></span>
<span id="index-space"></span>
<span id="index-speed"></span>
</p>
<span id="Arguments_003a-8"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>quality</var>&mdash;an <i>optimize quality</i>.
</p>
<p><var>value</var>&mdash;one of the <i>integers</i> <code>0</code>, <code>1</code>, <code>2</code>, or <code>3</code>.
</p>
<span id="Valid-Context_003a-6"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i> or <i>proclamation</i>
</p>
<span id="Description_003a-24"></span><h4 class="subsubheading">Description:</h4>

<p>Advises the compiler that each <var>quality</var> should be given attention
according to the specified corresponding <var>value</var>.
Each <var>quality</var> must be a <i>symbol</i> naming an <i>optimize quality</i>; 
the names and meanings of the standard <var>optimize qualities</var> are shown in 
the next figure.
</p>

<div class="float"><span id="fig3_002e25"></span>
<table class="cartouche" border="1"><tr><td>
<table>
<thead><tr><th>Name</th><th>Meaning</th></tr></thead>
<tr><td><code>compilation-speed</code></td><td>speed of the compilation process</td></tr>
<tr><td><code>debug</code></td><td>ease of debugging</td></tr>
<tr><td><code>safety</code></td><td>run-time error checking</td></tr>
<tr><td><code>space</code></td><td>both code size and run-time space</td></tr>
<tr><td><code>speed</code></td><td>speed of the object code</td></tr>
</table>
</td></tr></table>

<div class="float-caption"><p><strong>Figure 3.25: </strong>Optimize qualities</p></div></div>

<p>There may be other, <i>implementation-defined</i> <i>optimize qualities</i>.
</p>
<p>A <var>value</var> <code>0</code> means that the corresponding <var>quality</var> is totally
unimportant, and <code>3</code> that the <var>quality</var> is extremely important;
<code>1</code> and <code>2</code> are intermediate values, with <code>1</code> the 
neutral value.
<code>(<var>quality</var> 3)</code> can be abbreviated to <var>quality</var>.
</p>
<p>Note that <i>code</i> which has the optimization <code>(safety 3)</code>,
or just <code>safety</code>,
is called <i>safe</i> <i>code</i>.
</p>
<p>The consequences are unspecified if a <var>quality</var> appears more than once
with <i>different</i> <var>values</var>.
</p>
<span id="Examples_003a-20"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun often-used-subroutine (x y)
   (declare (optimize (safety 2)))
   (error-check x y)
   (hairy-setup x)
   (do ((i 0 (+ i 1))
        (z x (cdr z)))
       ((null z))
     ;; This inner loop really needs to burn.
     (declare (optimize speed))
     (declare (fixnum i))
     ))
</pre></div>


<span id="See-Also_003a-24"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>,
<a href="#declaim">declaim</a>,
<a href="#proclaim">proclaim</a>,
<a href="#Declaration-Scope">Section 3.3.4 (Declaration Scope)</a>
</p>
<span id="Notes_003a-14"></span><h4 class="subsubheading">Notes:</h4>

<p>An <code>optimize</code> declaration never applies to either a <i>variable</i> or
a <i>function</i> <i>binding</i>.  An <code>optimize</code> declaration can only
be a <i>free declaration</i>.  For more information, see <a href="#Declaration-Scope">Section 3.3.4 (Declaration Scope)</a>.
</p>

<hr>
<span id="special"></span><div class="header">
<p>
Next: <a href="#locally" accesskey="n" rel="next">locally</a>, Previous: <a href="#optimize" accesskey="p" rel="prev">optimize</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">special</h4>
<span id="special-_0028Declaration_0029"></span><h3 class="heading">special (Declaration)</h3>
<span id="index-special-2"></span>
<span id="index-special-1"></span>


<span id="Syntax_003a-24"></span><h4 class="subsubheading">Syntax:</h4>

<p><code>(special <tt>{</tt>var<tt>}</tt>*)</code>
</p>
<span id="Arguments_003a-9"></span><h4 class="subsubheading">Arguments:</h4>

<p><var>var</var>&mdash;a <i>symbol</i>.
</p>
<span id="Valid-Context_003a-7"></span><h4 class="subsubheading">Valid Context:</h4>

<p><i>declaration</i> or <i>proclamation</i>
</p>
<span id="Binding-Types-Affected_003a-5"></span><h4 class="subsubheading">Binding Types Affected:</h4>

<p><i>variable</i>
</p>
<span id="Description_003a-25"></span><h4 class="subsubheading">Description:</h4>

<p>Specifies that all of
the <var>vars</var> named are dynamic.
This specifier affects variable <i>bindings</i> and 
affects references.
All variable <i>bindings</i> affected are made to be dynamic <i>bindings</i>,
and affected variable references refer to the current dynamic 
<i>binding</i>.
For example:
</p>
<div class="lisp">
<pre class="lisp"> (defun hack (thing *mod*)    ;The binding of the parameter
   (declare (special *mod*))  ; *mod* is visible to hack1,
   (hack1 (car thing)))       ; but not that of thing.
 (defun hack1 (arg)
   (declare (special *mod*))  ;Declare references to *mod*
                              ;within hack1 to be special.
   (if (atom arg) *mod*
       (cons (hack1 (car arg)) (hack1 (cdr arg)))))
</pre></div>


<p>A <code>special</code> declaration does not affect inner <i>bindings</i> 
of a <var>var</var>; the inner <i>bindings</i> implicitly shadow
a <code>special</code> declaration and must be explicitly re-declared to
be <code>special</code>.
<code>special</code> declarations never apply to function <i>bindings</i>.
</p>
<p><code>special</code> declarations can be either <i>bound declarations</i>,
affecting both a binding and references, or <i>free declarations</i>,
affecting only references, depending on whether the declaration is 
attached to a variable binding.
</p>
<p>When used in a <i>proclamation</i>, a <code>special</code> 
<i>declaration specifier</i>
applies to all <i>bindings</i> as well as to all references of the
mentioned variables.  For example, after
</p>
<div class="lisp">
<pre class="lisp"> (declaim (special x))
</pre></div>


<p>then in a function definition such as
</p>
<div class="lisp">
<pre class="lisp"> (defun example (x) ...)
</pre></div>


<p>the parameter <code>x</code> is bound as a dynamic variable
rather than as a lexical variable.  
</p>
<span id="Examples_003a-21"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp">(defun declare-eg (y)                 ;this y is special
 (declare (special y))
 (let ((y t))                         ;this y is lexical
      (list y
            (locally (declare (special y)) y)))) ;this y refers to the
                                                 ;special binding of y
<span class="roman">→</span> DECLARE-EG 
 (declare-eg nil) <span class="roman">→</span> (T NIL) 
</pre></div>


<div class="lisp">
<pre class="lisp">(setf (symbol-value 'x) 6)
(defun foo (x)                         ;a lexical binding of x
  (print x)
  (let ((x (1+ x)))                    ;a special binding of x
    (declare (special x))              ;and a lexical reference
    (bar))
  (1+ x))
(defun bar () 
  (print (locally (declare (special x))
           x)))
(foo 10) 
▷ 10
▷ 11
<span class="roman">→</span> 11
</pre></div>


<div class="lisp">
<pre class="lisp">(setf (symbol-value 'x) 6)
(defun bar (x y)            ;[1] 1st occurrence of x
  (let ((old-x x)           ;[2] 2nd occurrence of x -- same as 1st occurrence
        (x y))              ;[3] 3rd occurrence of x
    (declare (special x))
    (list old-x x)))
(bar 'first 'second) <span class="roman">→</span> (FIRST SECOND)
</pre></div>


<div class="lisp">
<pre class="lisp"> (defun few (x &amp;optional (y *foo*))
   (declare (special *foo*))
   ...)
</pre></div>

<p>The reference to <code>*foo*</code>
in the first line of this example is not <code>special</code>
even though there is a <code>special</code> declaration in the second line.
</p>
<div class="lisp">
<pre class="lisp"> (declaim (special prosp)) <span class="roman">→</span> <i>implementation-dependent</i>
 (setq prosp 1 reg 1) <span class="roman">→</span> 1
 (let ((prosp 2) (reg 2))         ;the binding of prosp is special
    (set 'prosp 3) (set 'reg 3)   ;due to the preceding proclamation,
    (list prosp reg))             ;whereas the variable reg is lexical
<span class="roman">→</span> (3 2)
 (list prosp reg) <span class="roman">→</span> (1 3)

 (declaim (special x))          ;x is always special.
 (defun example (x y)                                 
   (declare (special y))
   (let ((y 3) (x (* x 2)))
     (print (+ y (locally (declare (special y)) y)))
     (let ((y 4)) (declare (special y)) (foo x)))) <span class="roman">→</span> EXAMPLE
</pre></div>

<p>In the contorted code above, the outermost and innermost <i>bindings</i> of
<code>y</code> are dynamic,
but the middle
binding is lexical. The two arguments to <code>+</code> are different,
one being the value, which is <code>3</code>, of the lexical variable
<code>y</code>, and the other being the value of the dynamic variable named <code>y</code>
(a <i>binding</i> 
of which happens, coincidentally, to lexically surround it at
an outer level).  All the <i>bindings</i> 
of <code>x</code> and references to <code>x</code>
are dynamic, however, because of the proclamation that <code>x</code> is
always <code>special</code>.
</p>
<span id="See-Also_003a-25"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="Data-and-Control-Flow.html#defparameter">defparameter</a>,
<a href="Data-and-Control-Flow.html#defvar">defvar</a>
</p>

<hr>
<span id="locally"></span><div class="header">
<p>
Next: <a href="#the" accesskey="n" rel="next">the</a>, Previous: <a href="#special" accesskey="p" rel="prev">special</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">locally</h4>
<span id="locally-_0028Special-Operator_0029"></span><h3 class="heading">locally (Special Operator)</h3>
<span id="index-locally-2"></span>
<span id="index-locally"></span>



<span id="Syntax_003a-25"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-locally-1">Special Form: <strong>locally</strong> <em><tt>{</tt>declaration<tt>}</tt>* <tt>{</tt>form<tt>}</tt>* <span class="roman">→</span> <tt>{</tt>result<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments-and-Values_003a-15"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>Declaration</var>&mdash;a <tt>declare</tt> <i>expression</i>; not evaluated.
</p>
<p><var>forms</var>&mdash;an <i>implicit progn</i>.
</p>
<p><var>results</var>&mdash;the <i>values</i> of the <var>forms</var>.
</p>
<span id="Description_003a-26"></span><h4 class="subsubheading">Description:</h4>

<p>Sequentially evaluates a body of <var>forms</var>
in a <i>lexical environment</i> where the given <var>declarations</var> have effect.
</p>
<span id="Examples_003a-22"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (defun sample-function (y)  ;this y is regarded as special
   (declare (special y))                                
   (let ((y t))              ;this y is regarded as lexical
     (list y
           (locally (declare (special y))
             ;; this next y is regarded as special
             y))))
<span class="roman">→</span> SAMPLE-FUNCTION
 (sample-function nil) <span class="roman">→</span> (T NIL) 
 (setq x '(1 2 3) y '(4 . 5)) <span class="roman">→</span> (4 . 5)

;;; The following declarations are not notably useful in specific.
;;; They just offer a sample of valid declaration syntax using LOCALLY.
 (locally (declare (inline floor) (notinline car cdr))
          (declare (optimize space))
    (floor (car x) (cdr y))) <span class="roman">→</span> 0, 1
</pre></div>


<div class="lisp">
<pre class="lisp">;;; This example shows a definition of a function that has a particular set
;;; of OPTIMIZE settings made locally to that definition.
 (locally (declare (optimize (safety 3) (space 3) (speed 0)))
   (defun frob (w x y &amp;optional (z (foo x y)))
     (mumble x y z w)))
<span class="roman">→</span> FROB

;;; This is like the previous example, except that the optimize settings
;;; remain in effect for subsequent definitions in the same compilation unit.
 (declaim (optimize (safety 3) (space 3) (speed 0)))
 (defun frob (w x y &amp;optional (z (foo x y)))
   (mumble x y z w))
<span class="roman">→</span> FROB
</pre></div>


<span id="See-Also_003a-26"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="#declare">declare</a>
</p>
<span id="Notes_003a-15"></span><h4 class="subsubheading">Notes:</h4>

<p>The <code>special</code> declaration may be used with <code>locally</code>
to affect references to, rather than <i>bindings</i> of, <i>variables</i>.
</p>
<p>If a <code>locally</code> <i>form</i> is a <i>top level form</i>, the body <var>forms</var>
are also processed as <i>top level forms</i>.  See <a href="#File-Compilation">Section 3.2.3 (File Compilation)</a>.
</p>


<hr>
<span id="the"></span><div class="header">
<p>
Next: <a href="#special_002doperator_002dp" accesskey="n" rel="next">special-operator-p</a>, Previous: <a href="#locally" accesskey="p" rel="prev">locally</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">the</h4>
<span id="the-_0028Special-Operator_0029"></span><h3 class="heading">the (Special Operator)</h3>
<span id="index-the-2"></span>
<span id="index-the"></span>


<span id="Syntax_003a-26"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-the-1">Special Form: <strong>the</strong> <em>value-type form <span class="roman">→</span> <tt>{</tt>result<tt>}</tt>*</em></dt>
</dl>

<span id="Arguments-and-Values_003a-16"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>value-type</var>&mdash;a <i>type specifier</i>; not evaluated.
</p>
<p><var>form</var>&mdash;a <i>form</i>; evaluated.
</p>
<p><var>results</var>&mdash;the <i>values</i> resulting from the <i>evaluation</i> of <var>form</var>.
These <i>values</i> must conform to the <i>type</i> supplied by <var>value-type</var>;
see below.
</p>
<span id="Description_003a-27"></span><h4 class="subsubheading">Description:</h4>

<p><code>the</code> specifies that the <i>values</i>[1a] returned by <var>form</var>
are of the <i>types</i> specified by <var>value-type</var>.
The consequences are undefined if any <var>result</var>
is not of the declared type.
</p>

<p>It is permissible for <var>form</var> to <i>yield</i> a different number of <i>values</i> 
than are specified by <var>value-type</var>, provided that the values
for which <var>types</var> are declared are indeed of those <i>types</i>.
Missing values are treated as <code>nil</code>&nbsp;<!-- /@w -->for the purposes of checking their <i>types</i>.
</p>
<p>Regardless of number of <i>values</i> declared by <var>value-type</var>,
the number of <i>values</i> returned by the <code>the</code> <i>special form</i> is the same as
the number of <i>values</i> returned by <var>form</var>. 
</p>
<span id="Examples_003a-23"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (the symbol (car (list (gensym)))) <span class="roman">→</span> #:G9876
 (the fixnum (+ 5 7)) <span class="roman">→</span> 12
 (the (values) (truncate 3.2 2)) <span class="roman">→</span> 1, 1.2
 (the integer (truncate 3.2 2)) <span class="roman">→</span> 1, 1.2
 (the (values integer) (truncate 3.2 2)) <span class="roman">→</span> 1, 1.2
 (the (values integer float) (truncate 3.2 2))   <span class="roman">→</span> 1, 1.2
 (the (values integer float symbol) (truncate 3.2 2)) <span class="roman">→</span> 1, 1.2
 (the (values integer float symbol t null list) 
      (truncate 3.2 2)) <span class="roman">→</span> 1, 1.2
 (let ((i 100))
    (declare (fixnum i))
    (the fixnum (1+ i))) <span class="roman">→</span> 101
 (let* ((x (list 'a 'b 'c))
        (y 5))
    (setf (the fixnum (car x)) y)
    x) <span class="roman">→</span> (5 B C)
</pre></div>


<span id="Exceptional-Situations_003a-6"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>The consequences are undefined if
the <i>values</i> <i>yielded</i> by the <var>form</var> 
are not of the <i>type</i> specified by <var>value-type</var>.
</p>
<span id="See-Also_003a-27"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="Types-and-Classes.html#values-_0028Type-Specifier_0029">values (Type Specifier)</a>
</p>
<span id="Notes_003a-16"></span><h4 class="subsubheading">Notes:</h4>

<p>The <code>values</code> <i>type specifier</i> can be used to indicate the types
of <i>multiple values</i>:
</p>
<div class="lisp">
<pre class="lisp"> (the (values integer integer) (floor x y))
 (the (values string t)
      (gethash the-key the-string-table))
</pre></div>


<p><code>setf</code> can be used with <code>the</code> type declarations.
In this case the declaration is transferred to the form that
specifies  the new value.  The resulting <code>setf</code> <i>form</i>
is then analyzed.
</p>

<hr>
<span id="special_002doperator_002dp"></span><div class="header">
<p>
Next: <a href="#constantp" accesskey="n" rel="next">constantp</a>, Previous: <a href="#the" accesskey="p" rel="prev">the</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">special-operator-p</h4>
<span id="special_002doperator_002dp-_0028Function_0029"></span><h3 class="heading">special-operator-p (Function)</h3>
<span id="index-special_002doperator_002dp-2"></span>
<span id="index-special_002doperator_002dp"></span>



<span id="Syntax_003a-27"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-special_002doperator_002dp-1">Function: <strong>special-operator-p</strong> <em>symbol <span class="roman">→</span> generalized-boolean</em></dt>
</dl>

<span id="Arguments-and-Values_003a-17"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>symbol</var>&mdash;a <i>symbol</i>.
</p>
<p><var>generalized-boolean</var>&mdash;a <i>generalized boolean</i>.
</p>
<span id="Description_003a-28"></span><h4 class="subsubheading">Description:</h4>

<p>Returns <i>true</i> if <var>symbol</var> is a <i>special operator</i>; otherwise, returns <i>false</i>.
</p>
<span id="Examples_003a-24"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (special-operator-p 'if) <span class="roman">→</span> <i>true</i>
 (special-operator-p 'car) <span class="roman">→</span> <i>false</i>
 (special-operator-p 'one) <span class="roman">→</span> <i>false</i>
</pre></div>


<span id="Exceptional-Situations_003a-7"></span><h4 class="subsubheading">Exceptional Situations:</h4>

<p>Should signal <code>type-error</code> if its argument is not a <i>symbol</i>.
</p>
<span id="Notes_003a-17"></span><h4 class="subsubheading">Notes:</h4>

<p>Historically, this function was called <code>special-form-p</code>.  The name was
finally declared a misnomer and changed, since it returned true for
<i>special operators</i>, not <i>special forms</i>.
</p>


<hr>
<span id="constantp"></span><div class="header">
<p>
Previous: <a href="#special_002doperator_002dp" accesskey="p" rel="prev">special-operator-p</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<h4 class="node-heading">constantp</h4>
<span id="constantp-_0028Function_0029"></span><h3 class="heading">constantp (Function)</h3>
<span id="index-constantp-2"></span>
<span id="index-constantp"></span>



<span id="Syntax_003a-28"></span><h4 class="subsubheading">Syntax:</h4>

<dl>
<dt id="index-constantp-1">Function: <strong>constantp</strong> <em>form <tt>&amp;optional</tt> environment <span class="roman">→</span> generalized-boolean</em></dt>
</dl>

<span id="Arguments-and-Values_003a-18"></span><h4 class="subsubheading">Arguments and Values:</h4>

<p><var>form</var>&mdash;a <i>form</i>.
</p>
<p><var>environment</var>&mdash;an <i>environment</i> <i>object</i>.
The default is <code>nil</code>.
</p>
<p><var>generalized-boolean</var>&mdash;a <i>generalized boolean</i>.
</p>
<span id="Description_003a-29"></span><h4 class="subsubheading">Description:</h4>

<p>Returns <i>true</i> if <var>form</var> can be determined
by the <i>implementation</i> to be a <i>constant form</i> 
in the indicated <var>environment</var>; 
otherwise, it returns <i>false</i> indicating either 
that the <i>form</i> is not a <i>constant form</i>
or that it cannot be determined whether or not <i>form</i> is a <i>constant form</i>.
</p>
<p>The following kinds of <i>forms</i> are considered <i>constant forms</i>:
</p>
<ul>
<li> <i>Self-evaluating objects</i> 
(such as <i>numbers</i>, 
<i>characters</i>,
and the various kinds of <i>arrays</i>)
are always considered <i>constant forms</i> 
and must be recognized as such by <code>constantp</code>.

</li><li> <i>Constant variables</i>, such as <i>keywords</i>,
symbols defined by <span class="roman">Common Lisp</span>&nbsp;<!-- /@w -->as constant (such as <code>nil</code>, <code>t</code>, and <code>pi</code>),
and symbols declared as constant by the user in the indicated <var>environment</var>
using <code>defconstant</code>
are always considered <i>constant forms</i>
and must be recognized as such by <code>constantp</code>.

</li><li> <code>quote</code> <i>forms</i> are always considered <i>constant forms</i>
and must be recognized as such by <code>constantp</code>.

</li><li> An <i>implementation</i> is permitted, but not required, to detect
additional <i>constant forms</i>.  If it does, it is also permitted,
but not required, to make use of information in the <var>environment</var>.
Examples of <i>constant forms</i> for which <code>constantp</code> might
or might not return <i>true</i> are:
<code>(sqrt pi)</code>,
<code>(+ 3 2)</code>,
<code>(length '(a b c))</code>,
and
<code>(let ((x 7)) (zerop x))</code>.
</li></ul>


<p>If an <i>implementation</i> chooses to make use of the <var>environment</var>
information, such actions as expanding <i>macros</i> or performing function
inlining are permitted to be used, but not required; 
however, expanding <i>compiler macros</i> is not permitted.
</p>
<span id="Examples_003a-25"></span><h4 class="subsubheading">Examples:</h4>

<div class="lisp">
<pre class="lisp"> (constantp 1) <span class="roman">→</span> <i>true</i>
 (constantp 'temp) <span class="roman">→</span> <i>false</i>
 (constantp ''temp)) <span class="roman">→</span> <i>true</i>
 (defconstant this-is-a-constant 'never-changing) <span class="roman">→</span> THIS-IS-A-CONSTANT 
 (constantp 'this-is-a-constant) <span class="roman">→</span> <i>true</i>
 (constantp &quot;temp&quot;) <span class="roman">→</span> <i>true</i>
 (setq a 6) <span class="roman">→</span> 6 
 (constantp a) <span class="roman">→</span> <i>true</i>
 (constantp '(sin pi)) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(car '(x))) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(eql x x)) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(typep x 'nil)) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(typep x 't)) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(values this-is-a-constant)) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(values 'x 'y)) <span class="roman">→</span> <i>implementation-dependent</i>
 (constantp '(let ((a '(a b c))) (+ (length a) 6))) <span class="roman">→</span> <i>implementation-dependent</i>
</pre></div>


<span id="Affected-By_003a-3"></span><h4 class="subsubheading">Affected By:</h4>

<p>The state of the global environment (<i>e.g.</i>, which <i>symbols</i> have been
declared to be the <i>names</i> of <i>constant variables</i>).
</p>
<span id="See-Also_003a-28"></span><h4 class="subsubheading">See Also:</h4>

<p><a href="Data-and-Control-Flow.html#defconstant">defconstant</a>
</p>





<hr>
<div class="header">
<p>
Previous: <a href="#special_002doperator_002dp" accesskey="p" rel="prev">special-operator-p</a>, Up: <a href="#Evaluation-and-Compilation" accesskey="u" rel="up">Evaluation and Compilation</a> &nbsp; [<a href="Table-of-Contents.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
